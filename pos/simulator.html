<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ³¨æ–‡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ | å—é™µç¥­2026</title>
    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f8f9fa;
        padding-top: 20px;
      }
      .card {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: none;
      }
      .console-log {
        background: #212529;
        color: #00ff41;
        font-family: "Courier New", Courier, monospace;
        padding: 15px;
        border-radius: 5px;
        height: 300px;
        overflow-y: auto;
        font-size: 0.9rem;
      }
      .log-entry {
        margin-bottom: 5px;
        border-bottom: 1px solid #333;
        padding-bottom: 2px;
      }
    </style>
  </head>
  <body>
    <div class="container" style="max-width: 800px">
      <div class="text-center mb-4">
        <h1>ğŸ› ï¸ Order Simulator (v2)</h1>
        <p class="text-muted">
          ãƒ¢ãƒã‚¤ãƒ«ã‚ªãƒ¼ãƒ€ãƒ¼ãƒ»SOKï¼ˆåˆ¸å£²æ©Ÿï¼‰ã®æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
        </p>
      </div>

      <!-- èªè¨¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div id="auth-section" class="card p-4 mb-4 text-center">
        <h4>é–‹ç™ºè€…ãƒ­ã‚°ã‚¤ãƒ³</h4>
        <p>Firestoreã¸ã®æ›¸ãè¾¼ã¿ã«ã¯èªè¨¼ãŒå¿…è¦ã§ã™ã€‚</p>
        <button id="login-btn" class="btn btn-dark w-50 mx-auto">
          Googleã§ãƒ­ã‚°ã‚¤ãƒ³
        </button>
        <p id="auth-status" class="mt-2 text-danger"></p>
      </div>

      <!-- ãƒ¡ã‚¤ãƒ³æ“ä½œãƒ‘ãƒãƒ« (ãƒ­ã‚°ã‚¤ãƒ³å¾Œè¡¨ç¤º) -->
      <div id="main-panel" style="display: none">
        <!-- è¨­å®šã‚¨ãƒªã‚¢ -->
        <div class="card p-4 mb-4">
          <h5 class="card-title">âš™ï¸ åŸºæœ¬è¨­å®š</h5>
          <div class="row align-items-center">
            <div class="col-auto">
              <label for="storeIdInput" class="col-form-label fw-bold"
                >Store ID:</label
              >
            </div>
            <div class="col-auto">
              <input
                type="text"
                id="storeIdInput"
                class="form-control"
                value="101"
                style="width: 100px; text-align: center"
              />
            </div>
            <div class="col">
              <span class="text-muted small"
                >â€»å¯¾è±¡ã®åº—èˆ—IDã‚’æŒ‡å®šã—ã¦ãã ã•ã„</span
              >
            </div>
          </div>
        </div>

        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ -->
        <div class="row g-3 mb-4">
          <!-- ãƒœã‚¿ãƒ³A: ãƒ¢ãƒã‚¤ãƒ«ã‚ªãƒ¼ãƒ€ãƒ¼ -->
          <div class="col-md-6">
            <div class="card h-100 border-primary">
              <div class="card-header bg-primary text-white fw-bold">
                ğŸ“± ãƒ¢ãƒã‚¤ãƒ«ã‚ªãƒ¼ãƒ€ãƒ¼ (Online)
              </div>
              <div class="card-body">
                <p class="card-text small">
                  ã‚¹ãƒãƒ›æ³¨æ–‡ãƒ»ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ±ºæ¸ˆæ¸ˆã€‚<br />
                  <code>status: authorized</code><br />
                  <code>payment: online</code>
                </p>
                <button
                  class="btn btn-primary w-100 action-btn"
                  data-type="mobile"
                >
                  ãƒ¢ãƒã‚¤ãƒ«æ³¨æ–‡ã‚’ç™ºè¡Œ
                </button>
              </div>
            </div>
          </div>

          <!-- ãƒœã‚¿ãƒ³B: SOK (ä¿®æ­£æ¸ˆã¿) -->
          <div class="col-md-6">
            <div class="card h-100 border-warning">
              <div class="card-header bg-warning text-dark fw-bold">
                ğŸ° SOK / åˆ¸å£²æ©Ÿ (Kiosk)
              </div>
              <div class="card-body">
                <p class="card-text small">
                  åˆ¸å£²æ©Ÿæ³¨æ–‡ãƒ»æ”¯æ‰•æ¸ˆã€‚<br />
                  <code>status: authorized</code> (ä¿®æ­£æ¸ˆ)<br />
                  <code>payment: kiosk</code>
                </p>
                <button
                  class="btn btn-warning w-100 action-btn"
                  data-type="sok"
                >
                  SOKæ³¨æ–‡ã‚’ç™ºè¡Œ
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- ãƒ­ã‚°ã‚¨ãƒªã‚¢ -->
        <div class="card">
          <div
            class="card-header d-flex justify-content-between align-items-center"
          >
            <span>ğŸ“Ÿ å®Ÿè¡Œãƒ­ã‚°</span>
            <button
              class="btn btn-sm btn-outline-secondary"
              onclick="document.getElementById('console').innerHTML=''"
            >
              ã‚¯ãƒªã‚¢
            </button>
          </div>
          <div id="console" class="console-log">
            <div class="text-muted">
              // æº–å‚™å®Œäº†ã€‚æ³¨æ–‡ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„...
            </div>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      // --- Firebase Import ---
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
      import {
        getAuth,
        GoogleAuthProvider,
        signInWithPopup,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
      import {
        getFunctions,
        httpsCallable,
      } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-functions.js";

      // --- Firebase Configuration ---
      const firebaseConfig = {
        apiKey: "AIzaSyA-Ijkbo-9rgrNKbDlRJ-rQVYdSXR_a9Do",
        authDomain: "nanryosai-2026-a4091.firebaseapp.com",
        projectId: "nanryosai-2026-a4091",
        storageBucket: "nanryosai-2026-a4091.appspot.com",
        messagingSenderId: "93228414556",
        appId: "1:93228414556:web:f64f90c13849fae9049899",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const functions = getFunctions(app);

      const authSection = document.getElementById("auth-section");
      const mainPanel = document.getElementById("main-panel");
      const loginBtn = document.getElementById("login-btn");
      const authStatus = document.getElementById("auth-status");
      const consoleDiv = document.getElementById("console");
      const storeIdInput = document.getElementById("storeIdInput");
      const actionBtns = document.querySelectorAll(".action-btn");

      loginBtn.addEventListener("click", async () => {
        try {
          await signInWithPopup(auth, new GoogleAuthProvider());
        } catch (e) {
          authStatus.textContent = "ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: " + e.message;
        }
      });

      onAuthStateChanged(auth, (user) => {
        if (user) {
          authSection.style.display = "none";
          mainPanel.style.display = "block";
          log(`ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ: ${user.email}`);
        } else {
          authSection.style.display = "block";
          mainPanel.style.display = "none";
        }
      });

      actionBtns.forEach((btn) => {
        btn.addEventListener("click", () =>
          handleOrderCreate(btn.dataset.type)
        );
      });

      async function handleOrderCreate(type) {
        const storeId = storeIdInput.value;
        if (!storeId) return alert("Store IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

        setLoading(true);
        log(
          `å‡¦ç†é–‹å§‹: ${
            type === "mobile" ? "ãƒ¢ãƒã‚¤ãƒ«ã‚ªãƒ¼ãƒ€ãƒ¼" : "SOKæ³¨æ–‡"
          }ã‚’ä½œæˆä¸­...`
        );

        try {
          const getNextReceiptNumber = httpsCallable(
            functions,
            "getNextReceiptNumber"
          );
          const result = await getNextReceiptNumber({ storeId: storeId });
          const receiptNumber = result.data.receiptNumber;

          const orderData = createOrderData(type, storeId, receiptNumber);

          const docRef = await addDoc(collection(db, "orders"), orderData);

          log(`âœ… æ³¨æ–‡ä½œæˆæˆåŠŸ! DocID: ${docRef.id}`, "text-success fw-bold");
          log(
            `è©³ç´°: No.${receiptNumber} / Pay:${orderData.paymentMethod} / Status:${orderData.status}`
          );
        } catch (error) {
          console.error(error);
          log(`âŒ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: ${error.message}`, "text-danger fw-bold");
        } finally {
          setLoading(false);
        }
      }

      function createOrderData(type, storeId, receiptNumber) {
        const isYakisoba = Math.random() > 0.5;
        // POSã¨è¦‹åˆ†ã‘ã‚„ã™ã„ã‚ˆã†ã«ã€å•†å“åã«ã€SOKã€‘ãªã©ã‚’ã¤ã‘ã¦ãŠãã®ã‚‚æ‰‹ã§ã™ãŒã€
        // ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆã—ã¾ã™ã€‚
        const itemName = isYakisoba
          ? "ã€ãƒ†ã‚¹ãƒˆã€‘ã‚½ãƒ¼ã‚¹ç„¼ããã°"
          : "ã€ãƒ†ã‚¹ãƒˆã€‘ãƒ•ãƒ©ãƒ³ã‚¯ãƒ•ãƒ«ãƒˆ";
        const itemPrice = isYakisoba ? 400 : 250;

        const items = [
          { name: itemName, price: itemPrice, quantity: 1, customizations: [] },
        ];
        const totalPrice = items.reduce((s, i) => s + i.price, 0);

        const baseOrder = {
          storeId: storeId,
          receiptNumber: receiptNumber,
          createdAt: serverTimestamp(),
          items: items,
          totalPrice: totalPrice,
        };

        if (type === "mobile") {
          return {
            ...baseOrder,
            status: "authorized", // èª¿ç†å¾…ã¡
            paymentMethod: "online", // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³
            isPrepaid: true,
          };
        } else {
          // SOK (Self Order Kiosk) - ä¿®æ­£ï¼šæ”¯æ‰•æ¸ˆã¨ã—ã¦ç™ºè¡Œ
          return {
            ...baseOrder,
            status: "authorized", // â˜…èª¿ç†å¾…ã¡ (ã“ã“ã‚’unpaidã‹ã‚‰å¤‰æ›´ã—ã¾ã—ãŸ)
            paymentMethod: "kiosk", // åˆ¸å£²æ©Ÿ
            isPrepaid: true, // â˜…æ”¯æ‰•æ¸ˆ
          };
        }
      }

      function log(message, className = "") {
        const time = new Date().toLocaleTimeString();
        const div = document.createElement("div");
        div.className = `log-entry ${className}`;
        div.innerHTML = `<span class="text-muted">[${time}]</span> ${message}`;
        consoleDiv.insertBefore(div, consoleDiv.firstChild);
      }

      function setLoading(isLoading) {
        actionBtns.forEach((btn) => {
          btn.disabled = isLoading;
          btn.style.opacity = isLoading ? 0.6 : 1;
          btn.style.cursor = isLoading ? "wait" : "pointer";
        });
      }
    </script>
  </body>
</html>
