<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>POS (ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°) | å—é™µç¥­2026</title>
    <style>
      :root {
        --bg-color: #333;
        --panel-bg: #f4f4f4;
        --selected-bg: #0d47a1;
        --text-color: #333;
        --shadow: 0 2px 0 rgba(0, 0, 0, 0.1);
      }

      * {
        box-sizing: border-box;
        user-select: none;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: "Helvetica Neue", Arial, sans-serif;
        height: 100vh;
        height: 100dvh;
        background-color: var(--bg-color);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      /* --- ãƒ­ãƒ¼ãƒ€ãƒ¼ --- */
      #global-loader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 99999;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: white;
      }
      #global-loader.active {
        display: flex;
      }

      .spinner {
        width: 60px;
        height: 60px;
        border: 6px solid #f3f3f3;
        border-top: 6px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .loading-text {
        font-size: 1.5em;
        font-weight: bold;
        letter-spacing: 2px;
      }

      /* --- ãƒˆãƒƒãƒ—ãƒãƒ¼ --- */
      .top-bar {
        height: 30px;
        background: #1a1a1a;
        color: #fff;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 15px;
        font-size: 0.9em;
        font-family: monospace;
        flex-shrink: 0;
      }
      .timer-display {
        color: #00e676;
        font-weight: bold;
      }

      /* --- ã‚¢ãƒ—ãƒªãƒ¡ã‚¤ãƒ³ç”»é¢ --- */
      #app-container {
        display: none;
        flex: 1;
        overflow: hidden;
      }

      /* å·¦å´ï¼šæ³¨æ–‡ãƒªã‚¹ãƒˆ */
      .order-panel {
        height: 100%;
        overflow: hidden;
        width: 32%;
        background: #fff;
        display: flex;
        flex-direction: column;
        border-right: 4px solid #444;
      }
      .list-header {
        background: #333;
        color: #fff;
        padding: 10px;
        font-weight: bold;
        text-align: center;
        letter-spacing: 1px;
      }
      .order-list {
        min-height: 0;
        flex: 1;
        overflow-y: auto;
        padding: 0;
        margin: 0;
        list-style: none;
        background: #fff;
      }
      .order-item {
        padding: 10px 15px;
        border-bottom: 1px solid #ddd;
        cursor: pointer;
        font-size: 1.1em;
        color: #333;
      }
      .order-item.selected {
        background-color: var(--selected-bg);
        color: white;
      }
      .item-row {
        display: flex;
        align-items: baseline;
      }
      .item-qty {
        font-weight: 900;
        font-size: 1.3em;
        width: 40px;
        text-align: right;
        margin-right: 15px;
      }
      .item-name {
        font-weight: bold;
        flex: 1;
      }
      .item-price {
        font-size: 0.9em;
        font-weight: normal;
        margin-left: 10px;
      }
      .order-item.selected .item-qty {
        color: #ffeb3b;
      }
      .item-mods {
        padding-left: 55px;
        font-size: 0.85em;
        margin-top: 2px;
        display: flex;
        flex-direction: column;
      }
      .mod-line {
        font-weight: bold;
      }
      .mod-no {
        color: #d32f2f;
      }
      .mod-add {
        color: #2e7d32;
      }
      .order-item.selected .mod-no {
        color: #ff8a80;
      }
      .order-item.selected .mod-add {
        color: #b9f6ca;
      }
      .total-area {
        background: #222;
        color: #0f0;
        padding: 15px;
        font-size: 2.2em;
        text-align: right;
        font-family: "Courier New", monospace;
        font-weight: bold;
      }

      /* å³å´ï¼šæ“ä½œãƒ‘ãƒãƒ« */
      .control-panel {
        height: 100%;
        overflow: hidden;
        width: 68%;
        background: var(--panel-bg);
        padding: 8px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .modifier-row {
        display: flex;
        gap: 8px;
      }
      .mode-btn {
        flex: 0 0 80px;
        height: 60px;
        border: 1px solid #777;
        border-radius: 4px;
        background: linear-gradient(#fff, #eee);
        font-weight: bold;
        font-size: 1.2em;
        cursor: pointer;
        box-shadow: var(--shadow);
      }
      .mode-btn[data-mode="NO"].active {
        background: #d32f2f;
        color: white;
        border-color: #b71c1c;
      }
      .mode-btn[data-mode="ADD"].active {
        background: #2e7d32;
        color: white;
        border-color: #1b5e20;
      }

      .ingredient-container {
        flex: 1;
        display: flex;
        gap: 5px;
        overflow-x: auto;
        background: #e0e0e0;
        border: 1px solid #999;
        border-radius: 4px;
        padding: 4px;
        align-items: center;
      }
      .ing-btn {
        min-width: 80px;
        height: 100%;
        border: 1px solid #888;
        border-radius: 4px;
        background: white;
        font-weight: bold;
        font-size: 0.9em;
        cursor: pointer;
        box-shadow: var(--shadow);
        white-space: pre-wrap;
        line-height: 1.1;
      }
      .ing-btn:active {
        transform: translateY(2px);
        box-shadow: none;
      }
      .no-toppings-msg {
        width: 100%;
        text-align: center;
        color: #666;
        font-size: 0.9em;
      }

      .quantity-control-row {
        display: flex;
        gap: 10px;
        height: 60px;
        align-items: center;
        background: #ddd;
        border-radius: 6px;
        padding: 5px;
      }
      .qty-btn {
        height: 100%;
        flex: 1;
        font-size: 1.8em;
        font-weight: bold;
        border: 1px solid #888;
        border-radius: 4px;
        cursor: pointer;
        box-shadow: var(--shadow);
        background: linear-gradient(#fff, #f0f0f0);
      }
      .qty-btn:active {
        transform: translateY(2px);
        box-shadow: none;
      }
      .qty-btn.minus {
        color: #d32f2f;
      }
      .qty-btn.plus {
        color: #2e7d32;
      }
      .qty-display-area {
        flex: 0 0 80px;
        text-align: center;
        font-size: 2em;
        font-weight: bold;
        color: #333;
        background: white;
        height: 100%;
        line-height: 50px;
        border-radius: 4px;
        border: 1px solid #bbb;
      }
      .delete-btn {
        flex: 0 0 120px;
        height: 100%;
        background: #d32f2f;
        color: white;
        font-size: 1.1em;
        font-weight: bold;
        border: 1px solid #b71c1c;
        border-radius: 4px;
        cursor: pointer;
        box-shadow: var(--shadow);
        margin-left: 10px;
      }
      .delete-btn:active {
        transform: translateY(2px);
        box-shadow: none;
      }

      .product-grid {
        min-height: 0;
        flex: 1;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
        grid-auto-rows: 90px;
        gap: 8px;
        overflow-y: auto;
        align-content: start;
        padding-right: 4px;
      }
      .prod-btn {
        background: white;
        border: 1px solid #999;
        border-radius: 6px;
        padding: 5px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        position: relative;
        overflow: hidden;
        transition: all 0.2s;
      }
      .prod-btn:active {
        transform: scale(0.96);
        background: #eee;
      }
      .prod-name {
        font-weight: bold;
        line-height: 1.2;
        font-size: 0.95em;
      }
      .prod-price {
        font-size: 0.85em;
        margin-top: 5px;
        color: #555;
        font-weight: bold;
      }

      .prod-btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 6px;
        background: #999;
      }
      .prod-btn[data-type="burger"]::before {
        background: #ff9800;
      }
      .prod-btn[data-type="drink"]::before {
        background: #2196f3;
      }
      .prod-btn[data-type="side"]::before {
        background: #4caf50;
      }

      /* MOD: å£²ã‚Šåˆ‡ã‚Œå•†å“ã®ã‚¹ã‚¿ã‚¤ãƒ« */
      .prod-btn.disabled {
        background: #e0e0e0;
        cursor: not-allowed;
        opacity: 0.7;
        box-shadow: none;
      }
      .prod-btn.disabled .prod-name {
        color: #888;
      }
      .prod-btn.disabled::after {
        content: "SOLD OUT";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(-15deg);
        color: #d32f2f;
        font-weight: 900;
        font-size: 1.2em;
        border: 3px solid #d32f2f;
        padding: 2px 5px;
        background: rgba(255, 255, 255, 0.8);
        pointer-events: none;
      }

      .footer-actions {
        height: 70px;
        display: flex;
        gap: 10px;
        border-top: 1px solid #ccc;
        padding-top: 8px;
      }
      .action-btn {
        border: none;
        border-radius: 6px;
        color: white;
        font-weight: bold;
        font-size: 1.2em;
        cursor: pointer;
        box-shadow: var(--shadow);
      }
      .btn-clear {
        background: #555;
        width: 120px;
      }
      .btn-checkout {
        flex: 1;
        background: #2e7d32;
        font-size: 1.5em;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      /* --- ãƒ¢ãƒ¼ãƒ€ãƒ« (å…±é€š) --- */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
      }
      .modal-overlay.active {
        display: flex;
      }
      .modal-box {
        background: white;
        padding: 40px;
        border-radius: 12px;
        text-align: center;
        min-width: 450px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
      }
      .receipt-num {
        font-size: 5em;
        font-weight: bold;
        color: #333;
        margin: 20px 0;
      }
      .close-btn {
        padding: 10px 30px;
        font-size: 1.2em;
        cursor: pointer;
        border-radius: 6px;
        border: 1px solid #aaa;
        background: #eee;
      }
      .confirm-title {
        font-size: 1.5em;
        font-weight: bold;
        margin-bottom: 20px;
      }
      .confirm-total {
        font-size: 3em;
        font-weight: bold;
        color: #2e7d32;
        margin: 20px 0;
        font-family: "Courier New", monospace;
        font-weight: bold;
      }
      .confirm-text {
        font-size: 1.2em;
        font-weight: bold;
        color: #555;
        margin-bottom: 30px;
      }
      .modal-actions {
        display: flex;
        justify-content: center;
        gap: 20px;
      }
      .modal-btn {
        padding: 15px 40px;
        font-size: 1.2em;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: bold;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }
      .modal-btn:active {
        transform: translateY(2px);
        box-shadow: none;
      }
      .modal-btn.cancel {
        background: #999;
        color: white;
      }
      .modal-btn.confirm-checkout {
        background: #2e7d32;
        color: white;
      }
      .modal-btn.confirm-clear {
        background: #d32f2f;
        color: white;
      }

      /* --- ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ç”»é¢ --- */
      #manual-section {
        flex: 1;
        background-color: #f8f9fa; /* Light Mode */
        color: #333;
        display: none; /* Initially hidden, shown after login */
        flex-direction: column;
        align-items: center;
        overflow-y: auto;
        padding: 30px;
      }
      .manual-container {
        max-width: 800px;
        width: 100%;
        background: #ffffff;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border: 1px solid #ddd;
      }
      .video-placeholder {
        width: 100%;
        height: 400px;
        background: #eee;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 8px;
        margin-bottom: 25px;
        border: 2px dashed #999;
        color: #666;
        font-size: 1.2em;
      }
      .manual-text {
        line-height: 1.6;
        font-size: 1.1em;
        margin-bottom: 30px;
        color: #333;
      }
      .start-training-btn {
        width: 100%;
        padding: 15px;
        font-size: 1.5em;
        font-weight: bold;
        background: #0d47a1;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      }
      .start-training-btn:hover {
        background: #1565c0;
      }
    </style>
  </head>
  <body>
    <div id="global-loader">
      <div class="spinner"></div>
      <div class="loading-text" id="loader-text">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <div id="error-screen" style="display: none"></div>

    <div id="login-screen" style="display: none"></div>

    <div class="top-bar">
      <div style="display: flex; align-items: center; gap: 15px">
        <a
          href="./index.html"
          class="btn btn-sm btn-secondary"
          style="text-decoration: none; font-weight: bold"
          >çµ‚äº†</a
        >
        <div id="clock-display">00:00:00</div>
      </div>
      <div>
        çµŒéæ™‚é–“: <span id="timer-display" class="timer-display">00:00</span>
      </div>
    </div>

    <!-- ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div id="manual-section">
      <div class="manual-container">
        <h2
          style="
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
            margin-bottom: 20px;
            color: #222;
          "
        >
          ãƒ¬ã‚¸æ‰“ã¡ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° (POS)
        </h2>

        <!-- å‹•ç”»ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ -->
        <div class="video-placeholder">
          <div>
            <span style="font-size: 3em; display: block; margin-bottom: 10px"
              >ğŸ¥</span
            >
            <span>æ“ä½œèª¬æ˜å‹•ç”» (æº–å‚™ä¸­)</span>
          </div>
        </div>

        <div class="manual-text">
          <h4><span style="color: #4caf50">â—</span> ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã®ç›®çš„</h4>
          <p>
            POSãƒ¬ã‚¸ã®åŸºæœ¬æ“ä½œï¼ˆæ³¨æ–‡å…¥åŠ›ã€ã‚«ã‚¹ã‚¿ãƒ å¤‰æ›´ã€ä¼šè¨ˆå‡¦ç†ï¼‰ã‚’ãƒã‚¹ã‚¿ãƒ¼ã—ã¾ã™ã€‚
            ã“ã®ãƒ¢ãƒ¼ãƒ‰ã§ã®æ“ä½œã¯<strong>å®Ÿéš›ã®å£²ä¸Šã«ã¯è¨˜éŒ²ã•ã‚Œã¾ã›ã‚“</strong>ã®ã§ã€å®‰å¿ƒã—ã¦ç·´ç¿’ã—ã¦ãã ã•ã„ã€‚
          </p>

          <h4><span style="color: #2196f3">â—</span> æ‰‹é †</h4>
          <ol>
            <li>å•†å“ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã‚«ãƒ¼ãƒˆã«è¿½åŠ ã—ã¾ã™ã€‚</li>
            <li>
              å•†å“ã‚’é¸æŠã—ãŸçŠ¶æ…‹ã§ã€ŒNo(æŠœã)ã€ã‚„ã€ŒAdd(è¿½åŠ )ã€ã‚’è¨­å®šã§ãã¾ã™ã€‚
            </li>
            <li>ã€ŒãŠä¼šè¨ˆã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã€å†…å®¹ã‚’ç¢ºèªã—ã¦ç¢ºå®šã—ã¾ã™ã€‚</li>
          </ol>
        </div>

        <button class="start-training-btn" onclick="startTraining()">
          ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’é–‹å§‹ã™ã‚‹
        </button>
      </div>
    </div>

    <div id="app-container">
      <div class="order-panel">
        <div class="list-header">æ³¨æ–‡ãƒªã‚¹ãƒˆ</div>
        <ul id="order-list" class="order-list"></ul>
        <div class="total-area" id="total-price">Â¥0</div>
      </div>

      <div class="control-panel">
        <div class="modifier-row">
          <button class="mode-btn" data-mode="NO" onclick="setMode('NO')">
            No<br /><small>æŠœã</small>
          </button>
          <button class="mode-btn" data-mode="ADD" onclick="setMode('ADD')">
            Add<br /><small>è¿½åŠ </small>
          </button>
          <div id="ingredient-container" class="ingredient-container">
            <div class="no-toppings-msg">å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
          </div>
        </div>

        <div class="quantity-control-row">
          <button class="qty-btn minus" onclick="changeQuantity(-1)">ï¼</button>
          <div class="qty-display-area" id="current-qty-display">-</div>
          <button class="qty-btn plus" onclick="changeQuantity(1)">ï¼‹</button>
          <button class="delete-btn" onclick="deleteSelected()">å‰Šé™¤</button>
        </div>

        <div id="product-grid" class="product-grid"></div>

        <div class="footer-actions">
          <button class="action-btn btn-clear" onclick="openClearModal()">
            å…¨æ¶ˆå»
          </button>
          <button class="action-btn btn-checkout" onclick="openCheckoutModal()">
            ãŠä¼šè¨ˆ
          </button>
        </div>
      </div>
    </div>

    <div id="checkout-confirm-modal" class="modal-overlay">
      <div class="modal-box">
        <div class="confirm-title">ãŠä¼šè¨ˆç¢ºèª</div>
        <div class="confirm-total" id="modal-total-price">Â¥0</div>
        <div class="confirm-text">ã“ã®å†…å®¹ã§ä¼šè¨ˆã‚’ç¢ºå®šã—ã¾ã™ã‹ï¼Ÿ</div>
        <div class="modal-actions">
          <button class="modal-btn cancel" onclick="closeAllModals()">
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </button>
          <button
            class="modal-btn confirm-checkout"
            onclick="processCheckout()"
          >
            ç¢ºå®šã™ã‚‹
          </button>
        </div>
      </div>
    </div>

    <div id="clear-confirm-modal" class="modal-overlay">
      <div class="modal-box">
        <div class="confirm-title" style="color: #d32f2f">è­¦å‘Š</div>
        <div class="confirm-text">
          ã‚«ãƒ¼ãƒˆã®ä¸­èº«ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã€‚<br />ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ
        </div>
        <div class="modal-actions">
          <button class="modal-btn cancel" onclick="closeAllModals()">
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </button>
          <button class="modal-btn confirm-clear" onclick="processClearCart()">
            å‰Šé™¤ã™ã‚‹
          </button>
        </div>
      </div>
    </div>

    <div id="success-modal" class="modal-overlay">
      <div class="modal-box">
        <h2>æ³¨æ–‡ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸ</h2>
        <div class="receipt-num" id="receipt-display">---</div>
        <button class="close-btn" onclick="closeAllModals()">æ¬¡ã®æ³¨æ–‡ã¸</button>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
      import {
        initializeAppCheck,
        ReCaptchaV3Provider,
      } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app-check.js";
      // Removed: getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged
      // MOD: onSnapshot ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
      import {
        getFirestore,
        collection,
        query,
        where,
        addDoc,
        serverTimestamp,
        onSnapshot,
        doc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
      import {
        getFunctions,
        httpsCallable,
      } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-functions.js";

      const firebaseConfig = {
        apiKey: "AIzaSyA-Ijkbo-9rgrNKbDlRJ-rQVYdSXR_a9Do",
        authDomain: "nanryosai-2026-a4091.firebaseapp.com",
        projectId: "nanryosai-2026-a4091",
        storageBucket: "nanryosai-2026-a4091.appspot.com",
        messagingSenderId: "93228414556",
        appId: "1:93228414556:web:f64f90c13849fae9049899",
      };

      const app = initializeApp(firebaseConfig);

      const appCheck = initializeAppCheck(app, {
        provider: new ReCaptchaV3Provider(
          "6LeHxzIsAAAAAOIf0lXePHNpUkvYRdFtQw9osmIS"
        ),
        isTokenAutoRefreshEnabled: true,
      });

      // const auth = getAuth(app); // Removed: Auth initialization
      const db = getFirestore(app);
      const functions = getFunctions(app);

      // State
      let products = [];
      let cart = [];
      let selectedUniqueId = null;
      let currentMode = null;
      let orderStartTime = null;
      let timerInterval = null;
      let isProcessing = false;
      let storeId = null;
      const isTraining = true; // TRAINING FORCE FLAG

      // Training Visuals
      document.body.style.border = "8px solid #ff9800";
      const banner = document.createElement("div");
      banner.innerHTML =
        "âš ï¸ ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ (æ³¨æ–‡ã¯ä¿å­˜ã•ã‚Œã¾ã™ãŒå£²ä¸Šã«ã¯è¨ˆä¸Šã•ã‚Œã¾ã›ã‚“)";
      banner.style.background = "#ff9800";
      banner.style.color = "white";
      banner.style.textAlign = "center";
      banner.style.padding = "10px";
      banner.style.fontWeight = "bold";
      banner.style.flexShrink = "0";
      document.body.prepend(banner);

      // MOD: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼è§£é™¤ç”¨
      let unsubscribeProducts = null;

      // Elements
      const orderListEl = document.getElementById("order-list");
      const totalEl = document.getElementById("total-price");
      const modalTotalEl = document.getElementById("modal-total-price");
      const productGrid = document.getElementById("product-grid");
      const ingredientContainer = document.getElementById(
        "ingredient-container"
      );
      const modeBtns = document.querySelectorAll(".mode-btn");
      const qtyDisplay = document.getElementById("current-qty-display");
      const clockDisplay = document.getElementById("clock-display");
      const timerDisplay = document.getElementById("timer-display");
      const loader = document.getElementById("global-loader");
      const loaderText = document.getElementById("loader-text");
      const errorScreen = null;

      // Modals
      const checkoutModal = document.getElementById("checkout-confirm-modal");
      const clearModal = document.getElementById("clear-confirm-modal");
      const successModal = document.getElementById("success-modal");

      const urlParams = new URLSearchParams(window.location.search);
      // MOD: åº—èˆ—IDãŒãªã‘ã‚Œã°ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç”¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆIDã‚’è¨­å®š
      storeId = urlParams.get("storeId") || "TRAINING-STORE";

      // Loader
      function showLoader(text = "å‡¦ç†ä¸­...") {
        loaderText.innerText = text;
        loader.classList.add("active");
        isProcessing = true;
      }
      function hideLoader() {
        loader.classList.remove("active");
        isProcessing = false;
      }

      // Auth has been removed
      // document.getElementById("store-login-btn").addEventListener("click", ...);

      // Auto-start for training
      document.getElementById("manual-section").style.display = "flex";
      subscribeToProducts();
      startClock();

      // Clock
      function startClock() {
        setInterval(() => {
          const now = new Date();
          clockDisplay.textContent = now.toLocaleTimeString();
        }, 1000);
      }
      function startOrderTimer() {
        if (orderStartTime) return;
        orderStartTime = Date.now();
        timerDisplay.textContent = "00:00";
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
          const diff = Math.floor((Date.now() - orderStartTime) / 1000);
          const mm = String(Math.floor(diff / 60)).padStart(2, "0");
          const ss = String(diff % 60).padStart(2, "0");
          timerDisplay.textContent = `${mm}:${ss}`;
        }, 1000);
      }
      function resetOrderTimer() {
        clearInterval(timerInterval);
        orderStartTime = null;
        timerDisplay.textContent = "00:00";
      }

      // MOD: ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç”¨ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—
      function subscribeToProducts() {
        showLoader("ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’\næº–å‚™ä¸­...");

        // Firestoreã®ä»£ã‚ã‚Šã«ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
        products = [
          {
            id: "mock1",
            name: "ãƒãƒ†ãƒˆ",
            price: 100,
            allowedToppings: ["ãƒˆãƒãƒˆ", "ãƒ”ã‚¯ãƒ«ã‚¹", "ã‚ªãƒ‹ã‚ªãƒ³", "ã‚½ãƒ¼ã‚¹å¤šã‚"],
            isAvailable: true,
          },
          {
            id: "mock2",
            name: "ãƒ•ãƒ©ãƒ³ã‚¯ãƒ•ãƒ«ãƒˆ",
            price: 100,
            allowedToppings: ["ãƒˆãƒãƒˆ", "ãƒ”ã‚¯ãƒ«ã‚¹", "ã‚ªãƒ‹ã‚ªãƒ³", "ã‚±ãƒãƒ£ãƒƒãƒ—"],
            isAvailable: true,
          },
          {
            id: "mock3",
            name: "ãƒãƒ¼ã‚ºãƒ•ãƒ©ãƒ³ã‚¯",
            price: 150,
            allowedToppings: ["ãƒãƒ¨ãƒãƒ¼ã‚º", "ãƒ¬ã‚¿ã‚¹"],
            isAvailable: true,
          },
        ];

        // èª­ã¿è¾¼ã¿æ¼”å‡º
        setTimeout(() => {
          renderProductGrid();
          hideLoader();
        }, 500);
      }

      function renderProductGrid() {
        productGrid.innerHTML = "";
        if (products.length === 0) {
          productGrid.innerHTML = "<p>å•†å“ãŒã‚ã‚Šã¾ã›ã‚“</p>";
          return;
        }

        products.forEach((p) => {
          const btn = document.createElement("div");
          btn.className = "prod-btn";

          // å£²ã‚Šåˆ‡ã‚Œå•†å“ã®åˆ¶å¾¡
          if (!p.isAvailable) {
            btn.classList.add("disabled");
            btn.onclick = (e) => e.preventDefault(); // ã‚¯ãƒªãƒƒã‚¯ç„¡åŠ¹
          } else {
            btn.onclick = () => addToCart(p);
          }

          let type = "other";
          if (p.name.match(/ãƒãƒ¼ã‚¬ãƒ¼|ãƒãƒƒã‚¯|ç‰›|ã‚µãƒ³ãƒ‰/)) type = "burger";
          else if (p.name.match(/ãƒ‰ãƒªãƒ³ã‚¯|ã‚³ãƒ¼ãƒ©|èŒ¶|æ°´/)) type = "drink";
          else if (p.name.match(/ãƒãƒ†ãƒˆ|ãƒŠã‚²ãƒƒãƒˆ/)) type = "side";
          btn.setAttribute("data-type", type);

          btn.innerHTML = `<span class="prod-name">${p.name}</span><span class="prod-price">Â¥${p.price}</span>`;
          productGrid.appendChild(btn);
        });
      }

      // Cart Logic
      window.addToCart = (product) => {
        if (isProcessing) return;
        // ã‚¬ãƒ¼ãƒ‰: å£²ã‚Šåˆ‡ã‚Œå•†å“ã¯è¿½åŠ ã•ã›ãªã„
        if (!product.isAvailable) return;

        if (cart.length === 0) startOrderTimer();

        const existingItem = cart.find(
          (item) =>
            item.productId === product.id && item.customizations.length === 0
        );
        if (existingItem) {
          existingItem.quantity++;
          selectItem(existingItem.uniqueId);
        } else {
          const newItem = {
            uniqueId: Date.now() + Math.random(),
            productId: product.id,
            name: product.name,
            price: product.price,
            quantity: 1,
            customizations: [],
            allowedToppings: product.allowedToppings,
          };
          cart.push(newItem);
          selectItem(newItem.uniqueId);
        }
        renderCart();
      };

      function selectItem(uniqueId) {
        selectedUniqueId = uniqueId;
        currentMode = null;
        renderCart();
        updateModeButtons();
        renderDynamicToppingButtons();
        updateQtyDisplay();
      }

      function updateQtyDisplay() {
        if (!selectedUniqueId) {
          qtyDisplay.innerText = "-";
          return;
        }
        const item = cart.find((i) => i.uniqueId === selectedUniqueId);
        qtyDisplay.innerText = item ? item.quantity : "-";
      }

      window.changeQuantity = (delta) => {
        if (!selectedUniqueId) return;
        const idx = cart.findIndex((i) => i.uniqueId === selectedUniqueId);
        if (idx === -1) return;
        const item = cart[idx];
        const newQty = item.quantity + delta;

        if (newQty < 1) {
          cart.splice(idx, 1);
          selectedUniqueId = null;
        } else {
          item.quantity = newQty;
        }
        updateQtyDisplay();
        renderCart();
        renderDynamicToppingButtons();
      };

      window.deleteSelected = () => {
        if (!selectedUniqueId) return;
        const idx = cart.findIndex((i) => i.uniqueId === selectedUniqueId);
        if (idx === -1) return;
        cart.splice(idx, 1);
        selectedUniqueId = null;
        renderCart();
        renderDynamicToppingButtons();
        updateQtyDisplay();
      };

      function renderDynamicToppingButtons() {
        ingredientContainer.innerHTML = "";
        if (!selectedUniqueId) {
          ingredientContainer.innerHTML =
            '<div class="no-toppings-msg">å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„</div>';
          return;
        }
        const item = cart.find((i) => i.uniqueId === selectedUniqueId);
        if (!item || !item.allowedToppings.length) {
          ingredientContainer.innerHTML =
            '<div class="no-toppings-msg">ãƒˆãƒƒãƒ”ãƒ³ã‚°ä¸å¯</div>';
          return;
        }
        item.allowedToppings.forEach((toppingName) => {
          const btn = document.createElement("button");
          btn.className = "ing-btn";
          btn.innerText = toppingName;
          btn.onclick = () => applyIngredient(toppingName);
          ingredientContainer.appendChild(btn);
        });
      }

      window.setMode = (mode) => {
        if (!selectedUniqueId) return;
        currentMode = currentMode === mode ? null : mode;
        updateModeButtons();
      };

      window.applyIngredient = (ingName) => {
        if (!selectedUniqueId) return;
        if (!currentMode) {
          alert("å…ˆã«ãƒ¢ãƒ¼ãƒ‰(No, Add)ã‚’é¸æŠã—ã¦ãã ã•ã„");
          return;
        }
        let idx = cart.findIndex((i) => i.uniqueId === selectedUniqueId);
        if (idx === -1) return;
        let item = cart[idx];

        if (item.quantity > 1) {
          item.quantity--;
          const newItem = {
            ...item,
            uniqueId: Date.now() + Math.random(),
            quantity: 1,
            customizations: [...item.customizations],
          };
          cart.push(newItem);
          item = newItem;
          selectedUniqueId = newItem.uniqueId;
        }

        const newMod = { mode: currentMode, target: ingName };
        const exIdx = item.customizations.findIndex(
          (c) => c.target === ingName
        );
        if (exIdx > -1) item.customizations[exIdx] = newMod;
        else item.customizations.push(newMod);

        currentMode = null;
        renderCart();
        updateModeButtons();
        updateQtyDisplay();
      };

      function renderCart() {
        orderListEl.innerHTML = "";
        let total = 0;
        cart.forEach((item) => {
          total += item.price * item.quantity;
          const li = document.createElement("li");
          li.className = `order-item ${
            item.uniqueId === selectedUniqueId ? "selected" : ""
          }`;
          li.onclick = () => selectItem(item.uniqueId);

          const modsHtml = item.customizations
            .map((c) => {
              const cls = c.mode === "NO" ? "mod-no" : "mod-add";
              return `<span class="mod-line ${cls}">${c.mode} ${c.target}</span>`;
            })
            .join("");

          li.innerHTML = `
                    <div class="item-row">
                        <span class="item-qty">${item.quantity}</span>
                        <span class="item-name">${item.name}</span>
                        <span class="item-price">Â¥${item.price}</span>
                    </div>
                    <div class="item-mods">${modsHtml}</div>
                `;
          orderListEl.appendChild(li);
        });
        totalEl.innerText = `Â¥${total.toLocaleString()}`;
      }

      function updateModeButtons() {
        modeBtns.forEach((btn) => {
          if (btn.dataset.mode === currentMode) btn.classList.add("active");
          else btn.classList.remove("active");
        });
      }

      // Modals
      window.closeAllModals = () => {
        if (isProcessing) return;
        checkoutModal.classList.remove("active");
        clearModal.classList.remove("active");
        successModal.classList.remove("active");
      };

      window.openCheckoutModal = () => {
        if (cart.length === 0) return;
        modalTotalEl.innerText = totalEl.innerText;
        checkoutModal.classList.add("active");
      };

      // Start Training Function
      window.startTraining = () => {
        document.getElementById("manual-section").style.display = "none";
        document.getElementById("app-container").style.display = "flex";
      };

      window.processCheckout = async () => {
        if (isProcessing) return;
        showLoader("æ³¨æ–‡å‡¦ç†ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¸­...");

        // MOCK SIMULATION
        setTimeout(() => {
          const mockReceiptNumber = Math.floor(Math.random() * 900) + 100;

          closeAllModals();
          document.getElementById(
            "receipt-display"
          ).innerText = `No. ${mockReceiptNumber} (ç·´ç¿’)`;
          successModal.classList.add("active");

          cart = [];
          selectedUniqueId = null;
          renderCart();
          renderDynamicToppingButtons();
          updateQtyDisplay();
          resetOrderTimer();

          hideLoader();
        }, 1500); // 1.5ç§’ã®ãƒ‡ã‚£ãƒ¬ã‚¤ã§å‡¦ç†æ„Ÿã‚’å‡ºã™
      };

      window.openClearModal = () => {
        if (cart.length === 0) return;
        clearModal.classList.add("active");
      };

      window.processClearCart = () => {
        cart = [];
        selectedUniqueId = null;
        currentMode = null;
        renderCart();
        renderDynamicToppingButtons();
        updateModeButtons();
        updateQtyDisplay();
        resetOrderTimer();
        closeAllModals();
      };
    </script>
  </body>
</html>
