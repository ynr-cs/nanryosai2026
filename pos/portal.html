<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>店舗管理ポータル | 南陵祭2026</title>
    <style>
        /* ============================
           基本スタイル
           ============================ */
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-color: #f4f6f9;
            margin: 0; padding: 0; color: #333;
        }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; padding-bottom: 100px; }
        h1, h2, h3 { text-align: center; color: #2c3e50; }
        
        /* カードスタイル */
        .card {
            background: white; padding: 20px; border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px;
            position: relative;
        }

        /* フォーム要素 */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }
        
        /* 入力＆セレクトボックス */
        input[type="text"], input[type="password"], input[type="number"], textarea, select {
            width: 100%; padding: 12px; border: 1px solid #ccc;
            border-radius: 6px; font-size: 16px; box-sizing: border-box;
            background-color: #fff;
        }
        select { cursor: pointer; }
        textarea { resize: vertical; height: 80px; font-family: inherit; }

        /* ボタン */
        button {
            width: 100%; padding: 12px; border: none; border-radius: 6px;
            font-size: 16px; font-weight: bold; cursor: pointer;
            transition: opacity 0.2s; color: white; margin-bottom: 10px;
        }
        button:hover { opacity: 0.9; }
        button:disabled { background-color: #ccc !important; cursor: not-allowed; }

        .btn-primary { background-color: #007bff; }
        .btn-google { background-color: #db4437; }
        .btn-add { background-color: #6610f2; }
        .btn-update { background-color: #28a745; }
        .btn-danger { background-color: #dc3545; }
        .btn-secondary { background-color: #6c757d; }
        
        /* ログアウトボタン */
        .btn-logout {
            position: absolute; top: 15px; right: 15px;
            width: auto; padding: 6px 12px; font-size: 0.8rem;
            background-color: #6c757d; border-radius: 20px;
        }

        /* トッピング入力エリア */
        .topping-row { display: flex; gap: 10px; margin-bottom: 8px; }
        .topping-row input { flex: 1; }
        .btn-sm-delete { width: auto; padding: 0 15px; background: #dc3545; color: white; margin: 0; }
        .btn-sm-add { width: auto; background: #17a2b8; display: inline-block; padding: 8px 16px; font-size: 0.9rem; color: white; border:none; border-radius:4px; cursor:pointer;}

        /* 商品リスト */
        .item-row {
            display: flex; justify-content: space-between; align-items: flex-start;
            padding: 15px; border-bottom: 1px solid #eee; gap: 15px;
        }
        .item-row:last-child { border-bottom: none; }

        .item-img {
            width: 80px; height: 80px; object-fit: cover; border-radius: 8px; background: #eee; flex-shrink: 0;
        }
        .item-info { flex: 1; }
        .item-name { font-weight: bold; font-size: 1.1rem; }
        .item-desc { font-size: 0.85rem; color: #666; margin: 4px 0; white-space: pre-wrap; }
        .badge-recommend {
            background: #ffc107; color: #333; font-size: 0.7rem;
            padding: 2px 6px; border-radius: 4px; margin-left: 5px; vertical-align: middle;
        }
        .item-actions {
            display: flex; flex-direction: column; gap: 8px; width: 100px; flex-shrink: 0;
        }
        .action-btn { font-size: 0.8rem; padding: 6px; margin: 0; }

        /* 画面切り替え */
        .view-section { display: none; min-height: 100vh; flex-direction: column; align-items: center; justify-content: center; }
        
        /* ログイン関連 */
        .login-card { max-width: 400px; width: 100%; text-align: center; }
        .auth-info { background: #eee; padding: 5px; font-size: 0.8rem; margin-bottom: 10px; border-radius: 4px; }

        /* モーダル (編集用) */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;
        }
        .modal-content {
            background: white; padding: 25px; border-radius: 12px;
            width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        /* リンクメニュー */
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 10px; }
        .menu-link { 
            text-decoration: none; background: white; border: 1px solid #ddd; 
            color: #333; padding: 15px; text-align: center; border-radius: 8px; font-weight: bold; display: block;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: 0.2s;
        }
        .menu-link:hover { background: #f8f9fa; border-color: #007bff; color: #007bff; }
    </style>
</head>
<body>

    <!-- 1. Google認証セクション -->
    <div id="google-auth-section" class="view-section" style="display: flex;">
        <div class="card login-card">
            <h2>管理者認証</h2>
            <p style="color:#666; font-size:0.9rem;">
                DB接続許可のため、Googleアカウントでログインしてください。<br>
                (どのアカウントでも構いません)
            </p>
            <button id="googleLoginBtn" class="btn-google">Googleでログイン</button>
            <div id="googleAuthError" style="color:red; font-size:0.9rem;"></div>
        </div>
    </div>

    <!-- 2. 店舗ログインセクション (プルダウン) -->
    <div id="store-login-section" class="view-section">
        <div class="card login-card">
            <div class="auth-info">認証済み: <span id="userEmailDisplay"></span></div>
            <h2>店舗ログイン</h2>
            <div id="loadingStoreList" style="color:#666; padding:10px;">店舗リストを読み込み中...</div>
            
            <div id="loginFormContainer" style="display:none;">
                <div class="form-group">
                    <label>ログインする団体を選択</label>
                    <select id="storeSelect">
                        <option value="" disabled selected>▼ 選択してください</option>
                        <!-- JSで動的に追加 -->
                    </select>
                </div>
                <div class="form-group">
                    <input type="password" id="password" placeholder="パスワード">
                </div>
                <button id="storeLoginBtn" class="btn-primary">ログイン</button>
            </div>
            
            <div id="storeLoginError" style="color:red; margin-top:10px; font-size:0.9rem;"></div>
        </div>
    </div>

    <!-- 3. ダッシュボードセクション -->
    <div id="dashboard-section" style="display: none; padding-top: 20px;">
        <div class="container">
            <!-- ヘッダー -->
            <div class="card" style="text-align:center;">
                <button id="logoutBtn" class="btn-logout">ログアウト</button>
                <h1 id="displayStoreName" style="margin:0; color:#007bff;">店舗名</h1>
                <p style="color:#666; margin:5px 0;"><span id="displayTeamName"></span> (ID: <span id="displayStoreId"></span>)</p>
            </div>

            <!-- メニューリンク -->
            <div class="card">
                <h3 style="margin-top:0;">機能メニュー</h3>
                <div class="menu-grid">
                    <a href="#" id="linkPos" class="menu-link">POSレジ</a>
                    <a href="#" id="linkKitchen" class="menu-link">厨房</a>
                    <a href="#" id="linkPresenter" class="menu-link">提供口</a>
                    <a href="#" id="linkMonitor" class="menu-link">モニター</a>
                    <a href="#" id="linkReport" class="menu-link">売上</a>
                </div>
            </div>

            <!-- 商品追加フォーム -->
            <div class="card">
                <h3 style="margin-top:0;">新規商品の追加</h3>
                <div class="form-group">
                    <label>商品名 *</label>
                    <input type="text" id="addName" placeholder="例: 焼きそば">
                </div>
                <div class="form-group">
                    <label>価格 (円) *</label>
                    <input type="number" id="addPrice" placeholder="例: 300">
                </div>
                <div class="form-group">
                    <label>説明文</label>
                    <textarea id="addDesc" placeholder="商品の特徴などを入力"></textarea>
                </div>
                <div class="form-group">
                    <label>商品画像</label>
                    <input type="file" id="addImage" accept="image/*">
                </div>
                <div class="form-group">
                    <label>トッピング・オプション</label>
                    <div id="addToppingsContainer"></div>
                    <button type="button" class="btn-sm-add" onclick="window.addToppingInput('addToppingsContainer')">＋ トッピング枠を追加</button>
                </div>
                <div class="form-group" style="display:flex; align-items:center;">
                    <input type="checkbox" id="addRecommended" style="width:auto; margin-right:8px;">
                    <label for="addRecommended" style="margin:0; cursor:pointer;">おすすめ商品として強調する</label>
                </div>
                <button id="addItemBtn" class="btn-add">商品を登録する</button>
            </div>

            <!-- 商品リスト -->
            <h3 style="text-align:left; border-left: 5px solid #007bff; padding-left:10px;">商品一覧</h3>
            <div class="card" id="itemsContainer" style="padding:0; overflow:hidden;">
                <div style="text-align:center; padding:20px; color:#999;">読み込み中...</div>
            </div>
        </div>
    </div>

    <!-- 4. 編集用モーダル -->
    <div id="editModal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top:0;">商品を編集</h3>
            <input type="hidden" id="editDocId">
            
            <div class="form-group">
                <label>商品名</label>
                <input type="text" id="editName">
            </div>
            <div class="form-group">
                <label>価格</label>
                <input type="number" id="editPrice">
            </div>
            <div class="form-group">
                <label>説明文</label>
                <textarea id="editDesc"></textarea>
            </div>
            <div class="form-group">
                <label>画像を変更</label>
                <input type="file" id="editImage" accept="image/*">
                <div id="currentImagePreview" style="margin-top:5px; font-size:0.8rem; color:#666;"></div>
            </div>
            <div class="form-group">
                <label>トッピング</label>
                <div id="editToppingsContainer"></div>
                <button type="button" class="btn-sm-add" onclick="window.addToppingInput('editToppingsContainer')">＋ 追加</button>
            </div>
            <div class="form-group" style="display:flex; align-items:center;">
                <input type="checkbox" id="editRecommended" style="width:auto; margin-right:8px;">
                <label for="editRecommended" style="margin:0; cursor:pointer;">おすすめ</label>
            </div>
            
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button id="updateItemBtn" class="btn-update">更新保存</button>
                <button onclick="document.getElementById('editModal').style.display='none'" class="btn-secondary">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (v9 Module) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        // ↓↓↓ ここに 'where' を追加しました ↓↓↓
        import { getFirestore, collection, query, orderBy, where, getDocs, getDoc, onSnapshot, doc, updateDoc, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA-Ijkbo-9rgrNKbDlRJ-rQVYdSXR_a9Do", 
            authDomain: "nanryosai-2026-a4091.firebaseapp.com",
            projectId: "nanryosai-2026-a4091",
            storageBucket: "nanryosai-2026-a4091.firebasestorage.app", 
            messagingSenderId: "360316480856",
            appId: "1:360316480856:web:1234567890abcdef" 
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // State
        let currentStoreId = null;
        let itemsCache = {}; 
        let storesDataMap = {}; 

        // LocalStorageのキー
        const LS_KEY_STORE_ID = "nanryosai_store_id";

        // ==========================================
        //  グローバル関数
        // ==========================================
        window.addToppingInput = (containerId, value = "") => {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'topping-row';
            div.innerHTML = `
                <input type="text" class="topping-input" value="${value}" placeholder="トッピング名">
                <button type="button" class="btn-sm-delete" onclick="this.parentElement.remove()">削除</button>
            `;
            container.appendChild(div);
        };

        window.toggleStatus = async (id, newStatus) => {
            try { await updateDoc(doc(db, "items", id), { isAvailable: newStatus }); }
            catch(e) { alert("更新失敗: " + e.message); }
        };

        window.deleteItem = async (id) => {
            if(!confirm("本当にこの商品を削除しますか？\n(元に戻せません)")) return;
            try { await deleteDoc(doc(db, "items", id)); }
            catch(e) { alert("削除失敗: " + e.message); }
        };

        window.setupEditModal = (id) => {
            const item = itemsCache[id];
            if(!item) return;

            document.getElementById('editDocId').value = id;
            document.getElementById('editName').value = item.name;
            document.getElementById('editPrice').value = item.price;
            document.getElementById('editDesc').value = item.description || "";
            document.getElementById('editRecommended').checked = item.isRecommended || false;
            document.getElementById('editImage').value = ""; 
            
            const preview = document.getElementById('currentImagePreview');
            preview.innerHTML = item.imageUrl 
                ? `現在の画像: <a href="${item.imageUrl}" target="_blank" style="color:#007bff;">確認する</a>` 
                : "現在の画像: なし";

            const container = document.getElementById('editToppingsContainer');
            container.innerHTML = "";
            if(item.allowedToppings) {
                item.allowedToppings.forEach(t => window.addToppingInput('editToppingsContainer', t));
            }

            document.getElementById('editModal').style.display = 'flex';
        };

        // ==========================================
        //  ヘルパー関数
        // ==========================================
        function getToppingsFromContainer(containerId) {
            const inputs = document.querySelectorAll(`#${containerId} .topping-input`);
            const list = [];
            inputs.forEach(input => {
                const val = input.value.trim();
                if(val) list.push(val);
            });
            return list;
        }

        async function uploadImage(file) {
            if (!file) return null;
            const fileName = `product_images/${currentStoreId}/${Date.now()}_${file.name}`;
            const storageRef = ref(storage, fileName);
            await uploadBytes(storageRef, file);
            return await getDownloadURL(storageRef);
        }

        // ==========================================
        //  1. 認証 & 状態監視
        // ==========================================
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Google認証済み
                document.getElementById('userEmailDisplay').textContent = user.email;
                document.getElementById('google-auth-section').style.display = 'none';

                // 自動ログインチェック (LocalStorage)
                const cachedStoreId = localStorage.getItem(LS_KEY_STORE_ID);
                if (cachedStoreId) {
                    try {
                        const storeRef = doc(db, "stores", cachedStoreId);
                        const storeSnap = await getDoc(storeRef);
                        if (storeSnap.exists()) {
                            currentStoreId = cachedStoreId;
                            initDashboard(cachedStoreId, storeSnap.data());
                            return;
                        } else {
                            localStorage.removeItem(LS_KEY_STORE_ID);
                        }
                    } catch (e) {
                        console.error("Auto login failed", e);
                    }
                }

                // 自動ログインできない場合 -> 店舗リスト取得して選択画面へ
                document.getElementById('store-login-section').style.display = 'flex';
                await loadStoreList();

            } else {
                // 未認証
                document.getElementById('dashboard-section').style.display = 'none';
                document.getElementById('store-login-section').style.display = 'none';
                document.getElementById('google-auth-section').style.display = 'flex';
            }
        });

        document.getElementById('googleLoginBtn').addEventListener('click', async () => {
            try { await signInWithPopup(auth, new GoogleAuthProvider()); } 
            catch (e) { document.getElementById('googleAuthError').textContent = e.message; }
        });

        // ==========================================
        //  2. 店舗リスト取得 & ログイン処理
        // ==========================================
        async function loadStoreList() {
            try {
                const q = query(collection(db, "stores"), orderBy("teamName"));
                const querySnapshot = await getDocs(q);
                
                const select = document.getElementById('storeSelect');
                select.innerHTML = '<option value="" disabled selected>▼ ログインする団体を選択</option>';
                storesDataMap = {};

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = `${data.teamName} - ${data.name}`;
                    select.appendChild(option);
                    storesDataMap[doc.id] = data;
                });

                document.getElementById('loadingStoreList').style.display = 'none';
                document.getElementById('loginFormContainer').style.display = 'block';

            } catch (e) {
                console.error(e);
                document.getElementById('loadingStoreList').textContent = "リスト取得エラー: " + e.message;
            }
        }

        document.getElementById('storeLoginBtn').addEventListener('click', async () => {
            const select = document.getElementById('storeSelect');
            const selectedId = select.value;
            const pass = document.getElementById('password').value.trim();

            if(!selectedId) {
                document.getElementById('storeLoginError').textContent = "団体を選択してください";
                return;
            }
            if(!pass) {
                document.getElementById('storeLoginError').textContent = "パスワードを入力してください";
                return;
            }

            const storeData = storesDataMap[selectedId];
            if(String(storeData.password) === String(pass)) {
                // ログイン成功
                localStorage.setItem(LS_KEY_STORE_ID, selectedId); 
                currentStoreId = selectedId;
                initDashboard(selectedId, storeData);
            } else {
                document.getElementById('storeLoginError').textContent = "パスワードが違います";
            }
        });

        // ログアウト
        document.getElementById('logoutBtn').addEventListener('click', () => {
            if(confirm("ログアウトしますか？")) {
                localStorage.removeItem(LS_KEY_STORE_ID);
                location.reload(); 
            }
        });

        // ==========================================
        //  3. ダッシュボード初期化
        // ==========================================
        function initDashboard(storeId, data) {
            document.getElementById('store-login-section').style.display = 'none';
            document.getElementById('dashboard-section').style.display = 'block';
            
            document.getElementById('displayStoreName').textContent = data.name;
            document.getElementById('displayTeamName').textContent = data.teamName;
            document.getElementById('displayStoreId').textContent = storeId;

            ['Pos','Kitchen','Presenter','Monitor','Report'].forEach(key => {
                const fileName = key === 'Report' ? 'sales-report.html' : `${key.toLowerCase()}.html`;
                document.getElementById(`link${key}`).href = `${fileName}?storeId=${storeId}`;
            });

            startItemListener(storeId);
        }

        // 商品一覧監視
        function startItemListener(storeId) {
            const q = query(collection(db, "items"), where("storeId", "==", storeId));
            const container = document.getElementById('itemsContainer');

            onSnapshot(q, (snapshot) => {
                container.innerHTML = "";
                itemsCache = {};

                if(snapshot.empty) {
                    container.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">商品がまだ登録されていません</div>';
                    return;
                }

                snapshot.forEach(docSnap => {
                    const item = docSnap.data();
                    const id = docSnap.id;
                    itemsCache[id] = item;

                    const div = document.createElement('div');
                    div.className = 'item-row';
                    
                    const imgHtml = item.imageUrl 
                        ? `<img src="${item.imageUrl}" class="item-img">` 
                        : `<div class="item-img" style="display:flex;align-items:center;justify-content:center;color:#ccc;font-size:0.7rem;">NO IMAGE</div>`;

                    const toppingTxt = (item.allowedToppings && item.allowedToppings.length) 
                        ? `OP: ${item.allowedToppings.join(', ')}` : "";

                    div.innerHTML = `
                        ${imgHtml}
                        <div class="item-info">
                            <div class="item-name">
                                ${item.name} <span style="font-size:0.9rem; color:#666;">(¥${item.price})</span>
                                ${item.isRecommended ? '<span class="badge-recommend">おすすめ</span>' : ''}
                            </div>
                            <div class="item-desc">${item.description || ""}</div>
                            <div style="font-size:0.8rem; color:#888; margin-top:2px;">${toppingTxt}</div>
                            <div style="margin-top:6px;">
                                <span style="background:${item.isAvailable?'#d4edda':'#f8d7da'}; color:${item.isAvailable?'#155724':'#721c24'}; padding:3px 10px; border-radius:12px; font-size:0.8rem; font-weight:bold;">
                                    ${item.isAvailable ? '● 販売中' : '× 売切'}
                                </span>
                            </div>
                        </div>
                        <div class="item-actions">
                            <button class="action-btn ${item.isAvailable ? 'btn-secondary' : 'btn-update'}" onclick="window.toggleStatus('${id}', ${!item.isAvailable})">
                                ${item.isAvailable ? '売切にする' : '販売再開'}
                            </button>
                            <button class="action-btn btn-primary" onclick="window.setupEditModal('${id}')">編集</button>
                            <button class="action-btn btn-danger" onclick="window.deleteItem('${id}')">削除</button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            });
        }

        // ==========================================
        //  4. 商品登録 & 更新
        // ==========================================
        
        // 登録
        document.getElementById('addItemBtn').addEventListener('click', async () => {
            const btn = document.getElementById('addItemBtn');
            const name = document.getElementById('addName').value.trim();
            const price = document.getElementById('addPrice').value;
            const desc = document.getElementById('addDesc').value.trim();
            const fileInput = document.getElementById('addImage');
            const isRec = document.getElementById('addRecommended').checked;
            
            if(!name || !price) return alert("商品名と価格は必須です");

            btn.disabled = true;
            btn.textContent = "登録中...";

            try {
                let imageUrl = "";
                if(fileInput.files[0]) {
                    imageUrl = await uploadImage(fileInput.files[0]);
                }

                await addDoc(collection(db, "items"), {
                    storeId: currentStoreId,
                    name: name,
                    price: Number(price),
                    description: desc,
                    imageUrl: imageUrl,
                    allowedToppings: getToppingsFromContainer('addToppingsContainer'),
                    isRecommended: isRec,
                    isAvailable: true
                });

                document.getElementById('addName').value = "";
                document.getElementById('addPrice').value = "";
                document.getElementById('addDesc').value = "";
                document.getElementById('addImage').value = "";
                document.getElementById('addToppingsContainer').innerHTML = "";
                document.getElementById('addRecommended').checked = false;
                alert("登録しました");
            } catch(e) {
                alert("登録エラー: " + e.message);
                console.error(e);
            } finally {
                btn.disabled = false;
                btn.textContent = "商品を登録する";
            }
        });

        // 更新
        document.getElementById('updateItemBtn').addEventListener('click', async () => {
            const btn = document.getElementById('updateItemBtn');
            const id = document.getElementById('editDocId').value;
            const name = document.getElementById('editName').value.trim();
            const price = document.getElementById('editPrice').value;
            const desc = document.getElementById('editDesc').value.trim();
            const fileInput = document.getElementById('editImage');
            const isRec = document.getElementById('editRecommended').checked;

            if(!name || !price) return alert("必須項目が空です");

            btn.disabled = true;
            btn.textContent = "更新中...";

            try {
                const updateData = {
                    name: name,
                    price: Number(price),
                    description: desc,
                    allowedToppings: getToppingsFromContainer('editToppingsContainer'),
                    isRecommended: isRec
                };
                if(fileInput.files[0]) {
                    updateData.imageUrl = await uploadImage(fileInput.files[0]);
                }
                await updateDoc(doc(db, "items", id), updateData);
                document.getElementById('editModal').style.display = 'none';
            } catch(e) {
                alert("更新エラー: " + e.message);
            } finally {
                btn.disabled = false;
                btn.textContent = "更新保存";
            }
        });

    </script>
</body>
</html>