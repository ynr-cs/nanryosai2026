<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>åº—èˆ—ç®¡ç†ãƒãƒ¼ã‚¿ãƒ« | å—é™µç¥­2026</title>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+JP:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg-color: #f0f2f5;
        --card-bg: #ffffff;
        --text-color: #1f2937;
        --text-secondary: #6b7280;
        --accent-color: #10b981; /* Emerald 500 */
        --accent-hover: #059669;
        --danger-color: #ef4444;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --header-bg: #111827;
        
        /* Status Colors */
        --status-unpaid: #ef4444; /* Red */
        --status-preparing: #f59e0b; /* Amber */
        --status-ready: #10b981; /* Emerald */
        --status-completed: #6b7280; /* Gray */
        --status-canceled: #1f2937; /* Dark */
      }

      * { box-sizing: border-box; }

      body {
        margin: 0; padding: 0;
        font-family: "Inter", "Noto Sans JP", sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        display: flex; flex-direction: column;
        height: 100vh; overflow: hidden;
        font-size: 14px;
      }

      /* --- Top Bar --- */
      .top-bar {
        height: 56px; background: var(--header-bg); color: #fff;
        display: flex; justify-content: space-between; align-items: center;
        padding: 0 20px; flex-shrink: 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 50;
      }
      .brand {
        font-weight: 800; font-size: 1.1rem;
        display: flex; align-items: center; gap: 10px; letter-spacing: -0.025em;
      }
      .store-badge {
          background: rgba(255,255,255,0.1); padding: 3px 8px; border-radius: 999px;
          font-size: 0.7rem; font-weight: 600;
      }
      .user-info { font-size: 0.8rem; display: flex; align-items: center; gap: 12px; }
      .logout-btn {
        background: transparent; border: 1px solid rgba(255,255,255,0.3); color: white;
        padding: 5px 10px; border-radius: 6px; cursor: pointer; transition: all 0.2s; font-size: 0.75rem;
      }
      .logout-btn:hover { background: rgba(255,255,255,0.1); border-color: #fff; }

      /* --- App Layout --- */
      .app-container { display: flex; flex: 1; overflow: hidden; }

      /* Sidebar */
      .sidebar {
        width: 240px; background: #fff; border-right: 1px solid #e5e7eb;
        padding: 16px; display: flex; flex-direction: column; gap: 8px;
        z-index: 40; overflow-y: auto;
      }
      
      .nav-item {
          padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;
          color: #4b5563; transition: all 0.2s; display: flex; align-items: center; gap: 10px;
      }
      .nav-item:hover { background: #f3f4f6; }
      .nav-item.active { background: #ecfdf5; color: var(--accent-color); }
      .nav-icon { font-size: 1.2rem; }

      /* Main Content Area */
      .main-content {
        flex: 1; padding: 20px; overflow-y: auto;
        display: flex; flex-direction: column; gap: 20px;
      }
      
      /* View Sections (Toggled) */
      .view-section { display: none; flex-direction: column; gap: 20px; height: 100%; }
      .view-section.active { display: flex; }

      /* --- Common UI Components --- */
      .card {
        background: var(--card-bg); border-radius: 10px; padding: 16px;
        box-shadow: var(--shadow); display: flex; flex-direction: column;
      }
      .input-field {
          width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;
          font-size: 0.9rem; background: #f9fafb; margin-bottom: 10px;
      }
      .btn-primary {
          background: var(--accent-color); color: white; border: none; padding: 10px 16px;
          border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.9rem;
      }
      .btn-primary:hover { background: var(--accent-hover); }
      
      /* Top Page Specifics */
      .app-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
      .app-link-card {
          text-decoration: none; color: inherit; background: white; padding: 24px;
          border-radius: 12px; box-shadow: var(--shadow); text-align: center;
          transition: transform 0.2s, border-color 0.2s; border: 2px solid transparent;
      }
      .app-link-card:hover { transform: translateY(-4px); border-color: var(--accent-color); }
      .app-icon { font-size: 3rem; margin-bottom: 12px; display: block; }
      .app-title { font-weight: 800; font-size: 1.2rem; display: block; color: #111827; }
      .app-desc { font-size: 0.85rem; color: #6b7280; margin-top: 4px; display: block; }

      /* Items Manager Specifics */
      .items-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 16px; }
      .item-card { background: white; border-radius: 8px; box-shadow: var(--shadow); overflow: hidden; display: flex; flex-direction: column; }
      .item-img { width: 100%; height: 140px; object-fit: cover; background: #eee; }
      .item-body { padding: 12px; flex: 1; display:flex; flex-direction:column; }
      .item-name { font-weight: bold; font-size: 1rem; margin-bottom: 4px; }
      .item-price { font-weight: 600; color: #111827; }
      .item-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-left: auto; }
      .badge-rec { background: #fef3c7; color: #92400e; }
      .item-actions-row { margin-top: auto; display: flex; gap: 8px; padding-top: 10px; }
      .btn-sm { padding: 4px 8px; font-size: 0.8rem; border-radius: 4px; border:none; cursor:pointer; }
      .btn-edit { background: #e5e7eb; color: #374151; }
      .btn-toggle { flex:1; }
      .is-active { background: #d1fae5; color: #065f46; }
      .is-inactive { background: #fee2e2; color: #991b1b; }

      /* Search & Sales Shared Styles */
      .summary-row { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 20px; }
      .summary-card { background: white; padding: 16px; border-radius: 10px; box-shadow: var(--shadow); flex: 1; min-width: 150px; }
      .summary-title { font-size: 0.75rem; color: #6b7280; font-weight: 600; text-transform: uppercase; margin-bottom: 6px; }
      .summary-value { font-size: 1.5rem; font-weight: 800; color: #111827; }
      .val-money { color: var(--accent-color); }
      
      .table-wrapper { background: white; border-radius: 10px; box-shadow: var(--shadow); overflow: hidden; }
      table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
      th, td { padding: 12px; text-align: left; border-bottom: 1px solid #f3f4f6; }
      th { background: #f9fafb; font-weight: 600; color: #6b7280; }
      tr.clickable:hover { background: #f9fafb; cursor: pointer; }
      
      /* Login Overlay */
      .auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f3f4f6; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
      .auth-card { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; width: 100%; max-width: 400px; }
      
      /* Modals */
      .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; justify-content: center; align-items: center; }
      .modal-content { background: white; padding: 24px; border-radius: 12px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }


      /* --- Mobile Responsive Overrides --- */
      @media (max-width: 768px) {
        body { font-size: 13px; }
        .sidebar { display: none !important; }
        .bottom-nav { display: flex !important; }
        
        .main-content { 
            padding: 12px;
            padding-bottom: calc(60px + env(safe-area-inset-bottom)); /* Add extra padding for bottom nav */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }
        
        /* Layout Adjustments */
        .top-bar { padding: 0 12px; height: 50px; }
        .brand { font-size: 1rem; }
        
        /* App Grid (Top Page) */
        .app-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; } /* 2 cols for apps */
        .app-link-card { padding: 16px; }
        .app-icon { font-size: 2rem; margin-bottom: 8px; }
        .app-title { font-size: 1rem; }
        
        /* Items Grid */
        .items-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; }
        .item-img { height: 100px; } /* Compact images */
        .item-body { padding: 8px; }
        .item-name { font-size: 0.9rem; }
        
        /* Sales Dashboard Compact */
        #view-sales .summary-row { gap: 8px; margin-bottom: 12px; }
        #view-sales .summary-card { padding: 12px; min-width: 100px; }
        #view-sales .summary-value { font-size: 1.2rem; }
        #view-sales .card { padding: 12px; margin-bottom: 10px; min-height: fit-content; }
        #view-sales .card canvas { min-height: 200px; max-height: 250px; }

        /* Search View Compact */
        #view-search .card { padding: 12px; gap: 8px !important; }
        #view-search .input-field, #view-search select { font-size: 16px; /* prevent zoom on focus */ padding: 8px; }
        
        /* Table Compact */
        .table-wrapper { border-radius: 8px; }
        th, td { padding: 8px; font-size: 0.8rem; }
        table { min-width: 500px; }
        
        /* Modal Adjustments */
        .modal-content { 
             width: 95%; max-height: 80vh; padding: 16px; 
             margin-bottom: 80px; /* clear bottom nav */
        }
        
        /* Buttons */
        .btn-primary { padding: 8px 12px; font-size: 0.85rem; }
      }

      /* Bottom Navigation (Mobile Only) */
      .bottom-nav {
        display: none;
        position: fixed; bottom: 0; left: 0; width: 100%;
        height: 60px; background: white; border-top: 1px solid #e5e7eb;
        z-index: 1000; justify-content: space-around; align-items: center;
        padding-bottom: env(safe-area-inset-bottom);
        box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
      }
      .bottom-nav-item {
        flex: 1; height: 100%; display: flex; flex-direction: column;
        justify-content: center; align-items: center; gap: 2px;
        color: #9ca3af; font-size: 0.65rem; font-weight: 600;
        cursor: pointer; -webkit-tap-highlight-color: transparent;
      }
      .bottom-nav-item.active { color: var(--accent-color); background: #ecfdf5; }
      .bottom-nav-icon { font-size: 1.3rem; margin-bottom: 2px; }
    </style>
  </head>
  <body>

    <!-- Auth Overlay -->
    <div id="auth-overlay" class="auth-overlay">
        <div id="step-google" class="auth-card">
            <h1 style="font-size:1.5rem; font-weight:800; margin-bottom:8px;">ãƒãƒ¼ã‚¿ãƒ«</h1>
            <p style="color:#6b7280; margin-bottom:24px;">ã‚¹ã‚¿ãƒƒãƒ•å°‚ç”¨ãƒãƒ¼ã‚¿ãƒ«</p>
            <button id="btn-google-login" class="btn-primary" style="width:100%; background:white; color:#374151; border:1px solid #d1d5db; display:flex; justify-content:center; align-items:center; gap:10px;">
                <span style="font-weight:bold;">G</span> Googleã§ãƒ­ã‚°ã‚¤ãƒ³
            </button>
            <p id="google-error" style="color:red; margin-top:12px; font-size:0.9rem;"></p>
        </div>

        <div id="step-store" class="auth-card" style="display:none;">
            <h1 style="font-size:1.5rem; font-weight:800; margin-bottom:8px;">åº—èˆ—ãƒ­ã‚°ã‚¤ãƒ³</h1>
            <div id="store-select-wrapper" style="margin-bottom:16px; text-align:left;">
                <label style="font-size:0.8rem; font-weight:bold;">ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹å›£ä½“</label>
                <select id="store-select" class="input-field" style="margin-top:4px;">
                    <option value="" disabled selected>èª­ã¿è¾¼ã¿ä¸­...</option>
                </select>
            </div>
            <input type="password" id="store-pass" class="input-field" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
            <button id="btn-store-login" class="btn-primary" style="width:100%; margin-top:10px; background:#111827;">ãƒãƒ¼ã‚¿ãƒ«ã¸ç§»å‹•</button>
            <p id="store-error" style="color:red; margin-top:12px; font-size:0.9rem;"></p>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" style="display:none; flex-direction:column; height:100%;">
        <div class="top-bar">
            <div class="brand">
                <span>åº—èˆ—ç®¡ç†ãƒãƒ¼ã‚¿ãƒ«</span>
                <span id="header-store-name" class="store-badge">---</span>
            </div>
            <div class="user-info">
                <span id="user-email"></span>
                <button class="logout-btn" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
        </div>

        <div class="app-container">
            <!-- Sidebar Navigation -->
            <div class="sidebar">
                <div class="nav-item active" onclick="switchView('top')">
                    <span class="nav-icon">ğŸ </span> ãƒˆãƒƒãƒ—
                </div>
                <div class="nav-item" onclick="switchView('items')">
                    <span class="nav-icon">ğŸ”</span> å•†å“ç®¡ç†
                </div>
                <div class="nav-item" onclick="switchView('sales')">
                    <span class="nav-icon">ğŸ“Š</span> å£²ä¸Š
                </div>
                <div class="nav-item" onclick="switchView('search')">
                    <span class="nav-icon">ğŸ”</span> æ³¨æ–‡æ¤œç´¢
                </div>
                <div class="nav-item" onclick="switchView('training')">
                    <span class="nav-icon">ğŸ“</span> ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°
                </div>
            </div>

            <div class="main-content">
                
                <!-- 1. Top View -->
                <div id="view-top" class="view-section active">
                    <h2 style="margin:0;">ãƒšãƒ¼ã‚¸</h2>
                    <div class="app-grid">
                        <a href="#" id="link-pos" class="app-link-card">
                            <span class="app-icon">ğŸ“±</span>
                            <span class="app-title">POSãƒ¬ã‚¸</span>
                            <span class="app-desc">æ³¨æ–‡ãƒ»ä¼šè¨ˆç”»é¢ã¸</span>
                        </a>
                        <a href="#" id="link-kitchen" class="app-link-card">
                            <span class="app-icon">ğŸ‘¨â€ğŸ³</span>
                            <span class="app-title">ã‚­ãƒƒãƒãƒ³ãƒ¢ãƒ‹ã‚¿ãƒ¼</span>
                            <span class="app-desc">å¨æˆ¿ãƒ¢ãƒ‹ã‚¿ãƒ¼</span>
                        </a>
                        <a href="#" id="link-monitor" class="app-link-card">
                            <span class="app-icon">ğŸ“º</span>
                            <span class="app-title">å‘¼ã³å‡ºã—ãƒ¢ãƒ‹ã‚¿ãƒ¼</span>
                            <span class="app-desc">å‘¼ã³å‡ºã—ãƒ¢ãƒ‹ã‚¿ãƒ¼</span>
                        </a>
                        <a href="#" id="link-presenter" class="app-link-card">
                            <span class="app-icon">ğŸ</span>
                            <span class="app-title">ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¿ãƒ¼ãƒ¢ãƒ‹ã‚¿ãƒ¼</span>
                            <span class="app-desc">å•†å“æä¾›å£</span>
                        </a>
                    </div>
                </div>

                <!-- 2. Items View -->
                <div id="view-items" class="view-section">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h2 style="margin:0;">å•†å“ç®¡ç†</h2>
                        <button class="btn-primary" onclick="openItemModal()">ï¼‹ æ–°è¦å•†å“ã‚’è¿½åŠ </button>
                    </div>
                    
                    <div id="items-grid" class="items-grid">
                        <!-- Items rendered here -->
                        <div style="grid-column:1/-1; text-align:center; padding:40px; color:#9ca3af;">å•†å“ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                </div>

                <!-- 3. Sales View -->
                <div id="view-sales" class="view-section">
                    <div class="summary-row">
                        <div class="summary-card">
                            <div class="summary-title">æœ¬æ—¥ã®å£²ä¸Š</div>
                            <div class="summary-value val-money" id="sales-total">Â¥0</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-title">ç·æ³¨æ–‡æ•°</div>
                            <div class="summary-value" id="sales-count">0</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-title">å®¢å˜ä¾¡</div>
                            <div class="summary-value" id="sales-avg">Â¥0</div>
                        </div>
                    </div>
                    
                    <div style="display:flex; gap:20px; flex-wrap:wrap;">
                        <div class="card" style="flex:2; min-height:300px;">
                            <h3 style="margin-top:0; font-size:0.9rem; color:#6b7280;">æ™‚é–“åˆ¥å£²ä¸Š</h3>
                            <div style="flex:1; position:relative;"><canvas id="chart-hourly"></canvas></div>
                        </div>
                        <div class="card" style="flex:1; min-height:300px;">
                            <h3 style="margin-top:0; font-size:0.9rem; color:#6b7280;">å•†å“åˆ¥å£²ä¸Š</h3>
                            <div style="flex:1; position:relative;"><canvas id="chart-products"></canvas></div>
                        </div>
                    </div>
                </div>

                <!-- 4. Search View -->
                <div id="view-search" class="view-section">
                    <div class="card" style="flex-direction:row; gap:16px; align-items:end; flex-wrap:wrap;">
                        <div style="flex:1; min-width:200px;">
                            <label style="font-size:0.8rem; font-weight:bold;">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢</label>
                            <input type="text" id="search-keyword" class="input-field" placeholder="ãƒ¬ã‚·ãƒ¼ãƒˆç•ªå· No..." style="margin-bottom:0;">
                        </div>
                        <div style="width:150px;">
                            <label style="font-size:0.8rem; font-weight:bold;">æ—¥ä»˜</label>
                            <input type="date" id="search-date" class="input-field" style="margin-bottom:0;">
                        </div>
                        <div style="width:150px;">
                            <label style="font-size:0.8rem; font-weight:bold;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                            <select id="search-status" class="input-field" style="margin-bottom:0;">
                                <option value="all">ã™ã¹ã¦</option>
                                <option value="unpaid">æœªæ‰•ã„</option>
                                <option value="active">èª¿ç†ä¸­</option>
                                <option value="completed">å®Œäº†</option>
                                <option value="canceled">å–æ¶ˆ</option>
                            </select>
                        </div>
                    </div>

                    <div class="table-wrapper" style="flex:1; overflow-y:auto;">
                        <table id="search-table">
                            <thead>
                                <tr>
                                    <th>æ™‚åˆ»</th>
                                    <th>ç•ªå·</th>
                                    <th>å•†å“å†…å®¹</th>
                                    <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                    <th class="text-right">é‡‘é¡</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                   overflow-y</div>
                </div>

                <!-- 5. Training View -->
                <div id="view-training" class="view-section">
                    <div class="card" style="text-align:center; padding:60px;">
                        <h2 style="font-size:2rem; margin-bottom:20px;">ğŸ“ ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰</h2>
                        <p style="color:#6b7280; margin-bottom:40px;">ã“ã“ã§ã¯å¾“æ¥­å“¡ãƒ»ç”Ÿå¾’ãŒæ¨¡æ“¬æ³¨æ–‡ã‚’ä½œæˆã—ã¦ç·´ç¿’ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚<br>ï¼ˆä½œæˆã•ã‚ŒãŸæ³¨æ–‡ã¯å£²ä¸Šã«è¨ˆä¸Šã•ã‚Œã¾ã›ã‚“ï¼‰</p>
                        <button class="btn-primary" style="font-size:1.2rem; padding:16px 32px;" onclick="openTraining()">
                            ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒãƒ¼ã‚¿ãƒ«ã¸ç§»å‹•
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>
        <!-- Bottom Nav (Mobile) -->
        <div class="bottom-nav">
            <div class="bottom-nav-item active" onclick="switchView('top')">
                <span class="bottom-nav-icon">ğŸ </span> <span>ãƒˆãƒƒãƒ—</span>
            </div>
            <div class="bottom-nav-item" onclick="switchView('items')">
                <span class="bottom-nav-icon">ğŸ”</span> <span>å•†å“</span>
            </div>
            <div class="bottom-nav-item" onclick="switchView('sales')">
                <span class="bottom-nav-icon">ğŸ“Š</span> <span>å£²ä¸Š</span>
            </div>
            <div class="bottom-nav-item" onclick="switchView('search')">
                <span class="bottom-nav-icon">ğŸ”</span> <span>æ¤œç´¢</span>
            </div>
            <div class="bottom-nav-item" onclick="switchView('training')">
                <span class="bottom-nav-icon">ğŸ“</span> <span>ç·´ç¿’</span>
            </div>
        </div>
    </div>

    <!-- Item Edit/Add Modal -->
    <div id="item-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title" style="margin-top:0;">å•†å“ç·¨é›†</h3>
            <input type="hidden" id="edit-id">
            
            <label style="font-weight:bold; font-size:0.85rem;">å•†å“å</label>
            <input type="text" id="edit-name" class="input-field">
            
            <label style="font-weight:bold; font-size:0.85rem;">ä¾¡æ ¼ (å††)</label>
            <input type="number" id="edit-price" class="input-field">
            
            <label style="font-weight:bold; font-size:0.85rem;">èª¬æ˜æ–‡</label>
            <textarea id="edit-desc" class="input-field" style="height:80px;"></textarea>
            
            <label style="font-weight:bold; font-size:0.85rem;">å•†å“ç”»åƒ</label>
            <input type="file" id="edit-image" class="input-field">
            
            <label style="font-weight:bold; font-size:0.85rem;">ãƒˆãƒƒãƒ”ãƒ³ã‚°ãƒ»ã‚ªãƒ—ã‚·ãƒ§ãƒ³</label>
            <div id="edit-toppings-container" style="margin-bottom:10px;"></div>
            <button type="button" class="btn-sm" style="background:#17a2b8; color:white; margin-bottom:16px;" onclick="addToppingInput()">ï¼‹ ãƒˆãƒƒãƒ”ãƒ³ã‚°æ ã‚’è¿½åŠ </button>
            <br>
            
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                <button onclick="closeItemModal()" style="background:#e5e7eb; border:none; padding:10px 20px; border-radius:6px; cursor:pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="saveItem()" class="btn-primary">ä¿å­˜ã™ã‚‹</button>
                <button onclick="deleteItem()" style="background:var(--danger-color); color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; margin-right:auto;">å‰Šé™¤</button>
            </div>
        </div>
    </div>

    <!-- Order Detail Modal (Reused from sales-report) -->
    <div id="order-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">æ³¨æ–‡è©³ç´°</div>
                <button class="modal-close" onclick="closeOrderModal()">Ã—</button>
            </div>
            <div style="margin-bottom:10px; font-weight:bold; font-size:1.2rem;">
                Receipt: <span id="order-receipt-no">---</span>
            </div>
            <div id="order-items-list" class="order-detail-list"></div>
            <select id="order-status-select" class="status-select">
                <option value="unpaid_at_pos">ğŸ”´ POSæœªæ‰•ã„</option>
                <option value="ready_to_serve">ğŸŸ  é…è†³å¾…</option>
                <option value="ready_for_pickup">ğŸŸ¢ å‘¼å‡ºä¸­</option>
                <option value="completed_at_store">âš«ï¸ å—å–å®Œäº†</option>
                <option value="cancelled">ğŸš« ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
            </select>
            <div class="modal-actions">
                <button class="save-btn" onclick="updateOrderStatus()">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app-check.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, query, where, orderBy, onSnapshot, getDocs, doc, updateDoc, addDoc, deleteDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-storage.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-functions.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA-Ijkbo-9rgrNKbDlRJ-rQVYdSXR_a9Do",
            authDomain: "nanryosai-2026-a4091.firebaseapp.com",
            projectId: "nanryosai-2026-a4091",
            storageBucket: "nanryosai-2026-a4091.firebasestorage.app", /* Corrected bucket domain usually ends with appspot logging elsewhere, but user config had firebasestorage.app or appspot.com. Using generic logic. */
            messagingSenderId: "93228414556",
            appId: "1:93228414556:web:f64f90c13849fae9049899"
        };

        const app = initializeApp(firebaseConfig);
        
        const appCheck = initializeAppCheck(app, {
            provider: new ReCaptchaV3Provider('6LeHxzIsAAAAAOIf0lXePHNpUkvYRdFtQw9osmIS'),
            isTokenAutoRefreshEnabled: true
        });

        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const functions = getFunctions(app, 'asia-northeast1');

        // State
        let currentStoreId = null;
        let storeData = null;
        let ordersUnsubscribe = null;
        let itemsUnsubscribe = null;
        let ordersData = [];
        let itemsData = [];
        let hourlyChart = null;
        let productChart = null;
        
        // --- Navigation ---
        window.switchView = (viewName) => {
            // Update Sidebar
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            // Find the nav item - simply by index or adding ID. For now assume order.
            // A bit hacky but simple selector:
            const navs = document.querySelectorAll('.nav-item');
            if(viewName==='top') navs[0].classList.add('active');
            if(viewName==='items') navs[1].classList.add('active');
            if(viewName==='sales') navs[2].classList.add('active');
            if(viewName==='search') navs[3].classList.add('active');
            if(viewName==='training') navs[4].classList.add('active');

            // Update Bottom Nav
            document.querySelectorAll('.bottom-nav-item').forEach(el => el.classList.remove('active'));
            const bottoms = document.querySelectorAll('.bottom-nav-item');
            if(bottoms.length > 0) {
                if(viewName==='top') bottoms[0].classList.add('active');
                if(viewName==='items') bottoms[1].classList.add('active');
                if(viewName==='sales') bottoms[2].classList.add('active');
                if(viewName==='search') bottoms[3].classList.add('active');
                if(viewName==='training') bottoms[4].classList.add('active');
            }

            // Update Views
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${viewName}`).classList.add('active');

            // Trigger renders if needed
            if(viewName === 'sales') renderSalesDashboard();
            if(viewName === 'search') renderSearchTable();
        };

        // --- Auth Logic ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('step-google').style.display = 'none';
                
                // Check Cached Login
                const cachedId = localStorage.getItem('nanryosai_store_id');
                // AUTO LOGIN IMPROVEMENT: If we have a cached ID, verify it exists (mentally) and just GO.
                // We trust the local storage for friction reduction.
                if(cachedId) {
                    currentStoreId = cachedId;
                    // We can skip the "step-store" screen entirely
                    // But we might want to fetch store name for the header.
                    // For now, let's just startApp and let listeners fetch data.
                    startApp(); 
                    return; 
                }

                // Show Store Login only if no cache
                document.getElementById('step-store').style.display = 'block';
                loadStoreOptions();
                document.getElementById('user-email').innerText = user.email;
            } else {
                document.getElementById('auth-overlay').style.display = 'flex';
                document.getElementById('step-google').style.display = 'block';
                document.getElementById('step-store').style.display = 'none';
                document.getElementById('app').style.display = 'none';
            }
        });

        document.getElementById('btn-google-login').onclick = async () => {
            try { await signInWithPopup(auth, new GoogleAuthProvider()); }
            catch(e) { document.getElementById('google-error').innerText = e.message; }
        };



        async function loadStoreOptions() {
            const q = query(collection(db, "stores"), orderBy("teamName"));
            const snap = await getDocs(q);
            const select = document.getElementById('store-select');
            select.innerHTML = '<option value="" disabled selected>â–¼ é¸æŠã—ã¦ãã ã•ã„</option>';
            snap.forEach(d => {
                const data = d.data();
                const op = document.createElement('option');
                op.value = d.id;
                op.textContent = `${data.teamName} - ${data.name}`;
                // op.dataset.password = data.password; // SECURITY FIX: Do not expose password in DOM
                select.appendChild(op);
            });
        }
        
        document.getElementById('btn-store-login').onclick = async () => {
            const select = document.getElementById('store-select');
            const pass = document.getElementById('store-pass').value;
            const storeId = select.value;
            
            if(!storeId || !pass) return;

            const btn = document.getElementById('btn-store-login');
            btn.disabled = true;
            btn.innerText = "èªè¨¼ä¸­...";
            document.getElementById('store-error').innerText = "";

            try {
                const loginStore = httpsCallable(functions, 'loginStore');
                const result = await loginStore({ storeId: storeId, password: pass });
                
                if (result.data.success) {
                    currentStoreId = storeId;
                    localStorage.setItem('nanryosai_store_id', currentStoreId);
                    
                    // Custom Claimsã‚’åæ˜ ã•ã›ã‚‹ãŸã‚ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å¼·åˆ¶ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
                    await auth.currentUser.getIdToken(true);
                    
                    loadStoreData(currentStoreId).then(() => startApp());
                }
            } catch (e) {
                console.error(e);
                document.getElementById('store-error').innerText = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™(ã‚µãƒ¼ãƒãƒ¼èªè¨¼)";
                btn.disabled = false;
                btn.innerText = "ãƒãƒ¼ã‚¿ãƒ«ã¸ç§»å‹•";
            }
        };

        async function loadStoreData(id) {
            // Placeholder: currently we just need the name
            // real app would fetch doc(db, 'stores', id)
            // But we already have logic to fetch all in loadStoreOptions? 
            // If cached, we might need to fetch.
            // Let's rely on basic info for now.
        }

        window.logout = () => {
             if(confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
                 signOut(auth);
                 localStorage.removeItem('nanryosai_store_id');
                 location.reload();
             }
        };

        function startApp() {
            document.getElementById('auth-overlay').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            document.getElementById('header-store-name').innerText = `ID: ${currentStoreId}`;
            
            // Set up Links
            document.getElementById('link-pos').href = `pos.html?storeId=${currentStoreId}`;
            document.getElementById('link-kitchen').href = `kitchen.html?storeId=${currentStoreId}`;
            document.getElementById('link-monitor').href = `monitor.html?storeId=${currentStoreId}`;
            document.getElementById('link-presenter').href = `presenter.html?storeId=${currentStoreId}`;
            
            setupRealtimeListeners();
            
            // Set Date Picker to today
            document.getElementById('search-date').valueAsDate = new Date();
            
            // Default view
            switchView('top');
        }

        function setupRealtimeListeners() {
            // 1. Items
            const qItems = query(collection(db, "items"), where("storeId", "==", currentStoreId));
            itemsUnsubscribe = onSnapshot(qItems, (snap) => {
                itemsData = [];
                snap.forEach(d => itemsData.push({id: d.id, ...d.data()}));
                renderItems();
            });

            // 2. Orders (Today)
            const today = new Date(); today.setHours(0,0,0,0);
            // Just fetching today's orders for dashboard/search default
            // Ideally we'd have a more robust date query
            const qOrders = query(
                collection(db, "orders"), 
                where("storeId", "==", currentStoreId),
                where("createdAt", ">=", Timestamp.fromDate(today)),
                orderBy("createdAt", "desc")
            );
            ordersUnsubscribe = onSnapshot(qOrders, (snap) => {
                ordersData = [];
                snap.forEach(d => ordersData.push({id: d.id, ...d.data()}));
                renderSalesDashboard();
                renderSearchTable();
            });
        }
        
        // --- Items Logic ---
        function renderItems() {
            const grid = document.getElementById('items-grid');
            grid.innerHTML = "";
            itemsData.forEach(item => {
                const div = document.createElement('div');
                div.className = 'item-card';
                div.innerHTML = `
                    <img src="${item.imageUrl || ''}" class="item-img">
                    <div class="item-body">
                        <div class="item-name">${item.name}</div>
                        <div class="item-price">Â¥${item.price}</div>
                        <div class="item-actions-row">
                             <button class="btn-sm btn-edit" onclick="openItemModal('${item.id}')">ç·¨é›†</button>
                             <button class="btn-sm btn-toggle ${item.isAvailable ? 'is-active' : 'is-inactive'}" 
                                 onclick="toggleItemStatus('${item.id}', ${!item.isAvailable})">
                                 ${item.isAvailable ? 'è²©å£²ä¸­' : 'å£²åˆ‡'}
                             </button>
                        </div>
                    </div>
                `;
                grid.appendChild(div);
            });
        }
        
        
        // --- Toppings Helpers ---
        window.addToppingInput = (val = "") => {
            const container = document.getElementById('edit-toppings-container');
            const div = document.createElement('div');
            div.style.display = 'flex';
            div.style.gap = '8px';
            div.style.marginBottom = '8px';
            div.innerHTML = `
                <input type="text" class="input-field topping-input" value="${val}" placeholder="ãƒˆãƒƒãƒ”ãƒ³ã‚°å" style="margin-bottom:0; flex:1;">
                <button type="button" onclick="this.parentElement.remove()" style="background:#ef4444; color:white; border:none; border-radius:4px; cursor:pointer; padding:0 12px;">å‰Šé™¤</button>
            `;
            container.appendChild(div);
        };

        function getToppings() {
             const inputs = document.querySelectorAll('.topping-input');
             return Array.from(inputs).map(i => i.value.trim()).filter(v => v);
        }

        window.openItemModal = (id=null) => {
            const modal = document.getElementById('item-modal');
            const title = document.getElementById('modal-title');
            document.getElementById('edit-id').value = id || "";
            document.getElementById('edit-toppings-container').innerHTML = "";
            
            if(id) {
                const item = itemsData.find(i => i.id === id);
                title.innerText = "å•†å“ç·¨é›†";
                document.getElementById('edit-name').value = item.name;
                document.getElementById('edit-price').value = item.price;
                document.getElementById('edit-desc').value = item.description || "";
                
                if(item.allowedToppings) {
                    item.allowedToppings.forEach(t => addToppingInput(t));
                }
            } else {
                title.innerText = "æ–°è¦å•†å“è¿½åŠ ";
                document.getElementById('edit-name').value = "";
                document.getElementById('edit-price').value = "";
                document.getElementById('edit-desc').value = "";
            }
            modal.style.display = 'flex';
        };
        
        window.closeItemModal = () => document.getElementById('item-modal').style.display = 'none';
        
        window.saveItem = async () => {
            const id = document.getElementById('edit-id').value;
            const name = document.getElementById('edit-name').value;
            const price = Number(document.getElementById('edit-price').value);
            const desc = document.getElementById('edit-desc').value;
            const file = document.getElementById('edit-image').files[0];
            const toppings = getToppings();
            
            if(!name || !price) return alert("å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            
            // Disable button
            // ...

            let imageUrl = null;
            if(file) {
                 const refStorage = ref(storage, `products/${currentStoreId}/${Date.now()}_${file.name}`);
                 await uploadBytes(refStorage, file);
                 imageUrl = await getDownloadURL(refStorage);
            }
            
            const data = {
                storeId: currentStoreId,
                name, price, description: desc,
                allowedToppings: toppings,
                isAvailable: true // Default true for new, should probably preserve if editing?
            };
            
            // logic to preserve isAvailable if editing
            if(id) {
                 const existing = itemsData.find(i => i.id === id);
                 if(existing) data.isAvailable = existing.isAvailable;
            }

            if(imageUrl) data.imageUrl = imageUrl;
            
            try {
                if(id) {
                    await updateDoc(doc(db, "items", id), data);
                } else {
                    await addDoc(collection(db, "items"), data);
                }
                closeItemModal();
            } catch(e) {
                alert("Error: " + e.message);
            }
        };

        window.deleteItem = async () => {
            const id = document.getElementById('edit-id').value;
            if(!id) return;
            if(!confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            
            try {
                await deleteDoc(doc(db, "items", id));
                closeItemModal();
            } catch(e) {
                alert("å‰Šé™¤ã‚¨ãƒ©ãƒ¼: " + e.message);
            }
        };


        window.toggleItemStatus = async (id, status) => {
            await updateDoc(doc(db, "items", id), { isAvailable: status });
        };

        // --- Sales & Search Logic ---
        function renderSalesDashboard() {
            // Aggregate
            let total = 0;
            let count = 0;
            let salesByHour = Array(24).fill(0);
            let productSales = {};
            
            ordersData.forEach(o => {
                if(o.status === 'cancelled' || o.status === 'canceled') return;
                
                count++;
                let orderTotal = 0;
                if(o.items) {
                    o.items.forEach(i => {
                        const sub = i.price * i.quantity;
                        orderTotal += sub;
                        if(!productSales[i.name]) productSales[i.name] = 0;
                        productSales[i.name] += sub;
                    });
                }
                total += orderTotal;
                
                if(o.createdAt) {
                    const h = o.createdAt.toDate().getHours();
                    salesByHour[h] += orderTotal;
                }
            });
            
            document.getElementById('sales-total').innerText = 'Â¥' + total.toLocaleString();
            document.getElementById('sales-count').innerText = count;
            document.getElementById('sales-avg').innerText = 'Â¥' + (count ? Math.round(total/count) : 0).toLocaleString();
            
            // Charts
            renderHourlyChart(salesByHour);
            renderProductChart(productSales);
        }
        
        function renderHourlyChart(data) {
            const ctx = document.getElementById('chart-hourly').getContext('2d');
            if(hourlyChart) hourlyChart.destroy();
            hourlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({length:24},(_,i)=>`${i}:00`),
                    datasets: [{ label: 'å£²ä¸Š', data: data, backgroundColor:'#10b981' }]
                },
                options: { maintainAspectRatio: false, plugins: { legend:{display:false} } }
            });
        }
        
        function renderProductChart(map) {
             const sorted = Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,5);
             const ctx = document.getElementById('chart-products').getContext('2d');
             if(productChart) productChart.destroy();
             productChart = new Chart(ctx, {
                 type: 'doughnut',
                 data: {
                     labels: sorted.map(s=>s[0]),
                     datasets: [{ data: sorted.map(s=>s[1]), backgroundColor: ['#10b981','#34d399','#6ee7b7','#a7f3d0','#d1fae5'] }]
                 },
                 options: { maintainAspectRatio: false }
             });
        }
        
        // --- Search Logic ---
        document.getElementById('search-keyword').addEventListener('input', renderSearchTable);
        document.getElementById('search-status').addEventListener('change', renderSearchTable);
        
        function renderSearchTable() {
            const tbody = document.getElementById('search-table').querySelector('tbody');
            tbody.innerHTML = "";
            
            const keyword = document.getElementById('search-keyword').value.trim();
            const statusFilter = document.getElementById('search-status').value;
            
            const filtered = ordersData.filter(o => {
                // Status
                if(statusFilter !== 'all') {
                    if(statusFilter === 'completed' && !o.status.includes('completed')) return false;
                    if(statusFilter === 'unpaid' && o.status !== 'unpaid_at_pos') return false;
                    if(statusFilter === 'active' && !['ready_to_serve','ready_for_pickup'].includes(o.status)) return false;
                    if(statusFilter === 'canceled' && !o.status.includes('cancel')) return false;
                }
                // Keyword
                if(keyword) {
                    const txt = JSON.stringify(o).toLowerCase();
                    if(!txt.includes(keyword.toLowerCase())) return false;
                }
                return true;
            });
            
            filtered.forEach(o => {
                const tr = document.createElement('tr');
                tr.className = 'clickable';
                tr.onclick = () => openOrderModal(o);
                
                const time = o.createdAt ? o.createdAt.toDate().toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'}) : '--:--';
                let total = 0;
                let summary = "";
                if(o.items) {
                    o.items.forEach(i => total += i.price*i.quantity);
                    summary = o.items.map(i=>`${i.name}x${i.quantity}`).join(', ');
                }
                
                tr.innerHTML = `
                    <td>${time}</td>
                    <td>${o.receiptNumber}</td>
                    <td>${summary.substring(0,20)}...</td>
                    <td>${getStatusBadge(o.status)}</td>
                    <td class="text-right">Â¥${total.toLocaleString()}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function getStatusBadge(s) {
            const map = {
                'unpaid_at_pos': {l:'æœªæ‰•ã„',c:'status-unpaid'},
                'ready_to_serve': {l:'èª¿ç†å®Œäº†',c:'status-preparing'},
                'ready_for_pickup': {l:'å‘¼å‡ºä¸­',c:'status-ready'},
                'completed_at_store': {l:'å—å–æ¸ˆ',c:'status-completed'},
                'cancelled': {l:'å–æ¶ˆ',c:'status-canceled'}
            };
            const info = map[s] || {l:s, c:'status-completed'};
            return `<span class="badge ${info.c}">${info.l}</span>`;
        }
        
        // --- Order Modal ---
        let selectedOrder = null;
        window.openOrderModal = (o) => {
            selectedOrder = o;
            document.getElementById('order-modal').style.display = 'flex';
            document.getElementById('order-receipt-no').innerText = `#${o.receiptNumber}`;
            document.getElementById('order-status-select').value = o.status;
            
            const list = document.getElementById('order-items-list');
            list.innerHTML = "";
            if(o.items) {
                o.items.forEach(i => {
                    list.innerHTML += `<div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px dashed #eee;">
                        <span>${i.name} x${i.quantity}</span>
                        <span>Â¥${(i.price*i.quantity).toLocaleString()}</span>
                    </div>`;
                });
            }
        };
        window.closeOrderModal = () => document.getElementById('order-modal').style.display = 'none';
        window.updateOrderStatus = async () => {
            const newStatus = document.getElementById('order-status-select').value;
            if(selectedOrder) {
                await updateDoc(doc(db, "orders", selectedOrder.id), { status: newStatus });
                closeOrderModal();
            }
        };
        
        window.openTraining = () => {
             if(!currentStoreId) return alert("åº—èˆ—IDãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“");
             // Open in new tab or same? Use new window to keep portal open.
             window.open(`training/index.html?storeId=${currentStoreId}`, '_blank');
        };

        // Global Assign (Modules scope)
        window.switchView = switchView; 
        
    </script>
  </body>
</html>