<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>モニター | 南陵祭2026</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@700;900&family=Noto+Sans+JP:wght@700;900&display=swap"
      rel="stylesheet"
    />
    <style>
      /* --- CSS Variables & Global Reset --- */
      :root {
        --bg-color: #ffffff;
        --text-color: #000000;
        --accent-color: #2e7d32; /* マックっぽい濃い緑 */
        --border-color: #e0e0e0;
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        --font-family: "Inter", "Noto Sans JP", sans-serif;
      }

      * {
        box-sizing: border-box;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: var(--font-family);
        background-color: var(--bg-color);
        color: var(--text-color);
        height: 100vh;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      /* --- View Management --- */
      .view {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease;
        z-index: 1;
        background-color: var(--bg-color);
      }

      .view.active {
        opacity: 1;
        visibility: visible;
        z-index: 10;
      }

      /* --- Common Buttons --- */
      .btn {
        border: none;
        border-radius: 8px;
        padding: 20px;
        font-size: 1.5rem;
        font-weight: bold;
        cursor: pointer;
        font-family: var(--font-family);
        box-shadow: var(--shadow);
      }
      .btn:active {
        transform: translateY(2px);
        box-shadow: none;
      }
      .btn-primary {
        background-color: var(--accent-color);
        color: #fff;
      }
      .btn-secondary {
        background-color: #f5f5f5;
        color: #333;
        border: 1px solid #ddd;
      }
      .btn-google {
        background-color: #fff;
        color: #555;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        border: 1px solid #ddd;
      }

      /* --- View 0: Login --- */
      #view-auth {
        justify-content: center;
        align-items: center;
      }
      .login-card {
        background: #fff;
        padding: 60px;
        border-radius: 20px;
        width: 100%;
        max-width: 500px;
        text-align: center;
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow);
      }

      /* --- View 1: IDLE (Monitor) --- */
      #view-idle {
        padding: 0;
        display: flex;
        flex-direction: column;
        background-color: #222;
        transition: zoom 0.2s ease;
      }

      .monitor-split {
        display: flex;
        flex: 1;
        overflow: hidden;
        height: 100%;
        width: 100%;
      }

      /* Panel Layout */
      .panel-column {
        display: flex;
        flex-direction: column;
        border-right: 4px solid #333;
        position: relative;
      }
      .panel-column:last-child {
        border-right: none;
      }
      
      .col-ready { flex: 2; }
      .col-preparing { flex: 1; background-color: #f0f0f0; }

      .panel-header {
        padding: 20px;
        font-size: 2.2rem;
        font-weight: 900;
        color: #fff;
        text-align: center;
        letter-spacing: 2px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        z-index: 10;
      }

      .header-preparing { background-color: #546e7a; }
      .header-ready { background-color: var(--accent-color); }

      .panel-content {
        flex: 1;
        padding: 30px;
        overflow-y: auto;
        position: relative;
      }

      /* Preparing List (Vertical) */
      .preparing-list {
        display: flex;
        flex-direction: column;
        gap: 15px;
        align-items: center; 
      }
      .item-preparing {
        font-size: 3rem;
        font-weight: 700;
        color: #555;
        width: 100%;
        text-align: center;
        border-bottom: 2px dashed #ccc;
        padding-bottom: 5px;
      }

      /* Ready Grid */
      .ready-grid {
        display: flex;
        flex-wrap: wrap;
        align-content: flex-start;
        gap: 20px;
        justify-content: center;
      }
      .item-ready {
        flex: 1 0 280px; 
        max-width: 400px;
        height: 160px;
        border: 5px solid var(--accent-color);
        background-color: #fff;
        color: #000;
        font-size: 6rem;
        font-weight: 900;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 16px;
        box-shadow: 0 8px 15px rgba(0,0,0,0.15);
        animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
      
      /* --- Employee Menu --- */
      .menu-btn {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 2000;
        background: #333;
        color: #fff;
        border: 2px solid #555;
        border-radius: 8px;
        width: 50px;
        height: 50px;
        font-size: 1.5rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0.3;
        transition: opacity 0.3s;
      }
      .menu-btn:hover { opacity: 1; }

      .side-menu {
        position: fixed;
        top: 0;
        right: -300px;
        width: 300px;
        height: 100%;
        background: #222;
        color: #fff;
        z-index: 2001;
        box-shadow: -5px 0 15px rgba(0,0,0,0.5);
        transition: right 0.3s ease;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      .side-menu.open { right: 0; }
      .menu-header {
        font-size: 1.2rem;
        font-weight: bold;
        border-bottom: 1px solid #555;
        padding-bottom: 10px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .menu-close { cursor: pointer; font-size: 1.5rem; }
      .menu-item { margin-bottom: 10px; }
      .zoom-controls {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin: 20px 0;
      }
      .btn-zoom {
        width: 50px;
        height: 50px;
        font-size: 1.5rem;
        border-radius: 50%;
        border: none;
        background: #444;
        color: #fff;
        cursor: pointer;
      }
      .btn-zoom:active { background: #666; }


      /* --- View 2: Input (Keypad) --- */
      #view-input {
        background: rgba(255, 255, 255, 0.95);
        justify-content: center;
        align-items: center;
      }
      .input-wrapper {
        max-width: 450px;
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      .display-screen {
        background: #f8f9fa;
        border: 2px solid #000;
        border-radius: 12px;
        height: 100px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 4rem;
        font-weight: 900;
      }
      .keypad {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
      }
      .key-btn {
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 8px;
        height: 80px;
        font-size: 2.5rem;
        font-weight: bold;
        box-shadow: 0 2px 0 #ddd;
      }
      .key-btn:active {
        transform: translateY(2px);
        box-shadow: none;
        background: #eee;
      }
      .key-enter {
        background: var(--accent-color);
        color: #fff;
        border: none;
        box-shadow: 0 4px 0 #1b5e20;
      }
      .key-clear {
        background: #ffebee;
        color: #c62828;
        border: 1px solid #ef9a9a;
      }
      .input-header-text {
        text-align: center;
        font-size: 1.5rem;
        font-weight: bold;
        color: #333;
      }

      /* --- View 3: Confirm --- */
      #view-confirm {
        justify-content: center;
        align-items: center;
        background: #f8f9fa;
      }
      .confirm-wrapper {
        background: #fff;
        width: 100%;
        max-width: 600px;
        border-radius: 16px;
        padding: 40px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        text-align: center;
      }
      .order-list {
        margin: 30px 0;
        text-align: left;
        border-top: 2px solid #eee;
        border-bottom: 2px solid #eee;
        padding: 20px 0;
      }
      .order-item {
        display: flex;
        justify-content: space-between;
        font-size: 1.4rem;
        padding: 10px 0;
        border-bottom: 1px dashed #eee;
      }
      .total-price {
        font-size: 3rem;
        font-weight: 900;
        color: #000;
        margin: 20px 0;
      }

      /* --- View 4: Complete --- */
      #view-complete {
        justify-content: center;
        align-items: center;
        text-align: center;
        background: #fff;
      }
      .success-icon {
        width: 180px;
        height: 180px;
        fill: var(--accent-color);
        margin-bottom: 20px;
        animation: popIn 0.5s;
      }
      .success-text {
        font-size: 3rem;
        font-weight: 900;
        color: #000;
      }

      @keyframes popIn {
        from {
          transform: scale(0.5);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }
      .hidden {
        display: none !important;
      }
      
      /* --- 店舗ログインモーダル --- */
      #store-login-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #eee;
        z-index: 15000;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
      }
      .store-login-card {
        background: white;
        padding: 40px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        max-width: 400px;
        width: 90%;
      }
      .store-login-input {
        width: 100%;
        padding: 12px;
        font-size: 1.2em;
        margin: 20px 0;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      .store-login-btn {
        width: 100%;
        padding: 12px;
        font-size: 1.2em;
        background: #333;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
  <body>
    <!-- 店舗ログインモーダル -->
    <div id="store-login-modal">
      <div class="store-login-card">
        <h2>店舗認証</h2>
        <p>セキュリティのため<br>店舗パスワードを入力してください</p>
        <p id="target-store-id-display" style="font-weight:bold; color:#555;"></p>
        <input type="password" id="store-password-input" class="store-login-input" placeholder="パスワード">
        <button class="store-login-btn" id="store-login-btn">認証する</button>
        <p id="store-login-error" style="color:red; margin-top:15px;"></p>
      </div>
    </div>

    <!-- View 0: Authentication -->
    <div id="view-auth" class="view active">
      <div class="login-card">
        <h1>Staff Login</h1>
        <p style="margin: 20px 0; color: #666">
          Store ID:
          <span id="auth-store-id" style="font-weight: bold; color: #000"
            >-</span
          >
        </p>
        <button
          id="btn-google-login"
          class="btn btn-google"
          style="width: 100%"
        >
          <img
            src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg"
            width="24"
            alt="G"
          />
          Googleでログイン
        </button>
      </div>
    </div>

    <!-- View 1: IDLE (Monitor Mode) -->
    <!-- View 1: IDLE (Monitor Mode) -->
    <!-- View 1: IDLE (Monitor Mode) -->
    <div id="view-idle" class="view">
      <!-- Employee Menu Trigger -->
      <button class="menu-btn" onclick="app.toggleMenu()">☰</button>
      
      <!-- Employee Side Menu -->
      <div id="side-menu" class="side-menu">
        <div class="menu-header">
           <span>従業員メニュー</span>
           <span class="menu-close" onclick="app.toggleMenu()">×</span>
        </div>
        <div class="menu-item">
            Store ID: <span id="menu-store-id" style="font-weight:bold">--</span>
        </div>
        <div class="menu-item">
            User: <span id="menu-user" style="font-weight:bold">--</span>
        </div>
        
        <div class="zoom-controls">
           <button class="btn-zoom" onclick="app.adjustZoom(-0.1)">-</button>
           <button class="btn-zoom" onclick="app.adjustZoom(0.1)">+</button>
        </div>

        <button onclick="app.logout()" class="logout-btn" style="width:100%; margin-top:auto;">ログアウト</button>
      </div>

      <div class="monitor-split">
        <!-- Ready Column (Left, Wide) -->
        <div class="panel-column col-ready">
          <div class="panel-header header-ready">
            お呼出中の番号 / Ready
          </div>
          <div class="panel-content" style="background:#fff;">
            <div id="grid-ready" class="ready-grid"></div>
          </div>
        </div>

        <!-- Preparing Column (Right, Narrow) -->
        <div class="panel-column col-preparing">
          <div class="panel-header header-preparing">
            準備中 / Preparing
          </div>
          <div class="panel-content" style="background:#f9f9f9;">
            <div id="list-preparing" class="preparing-list"></div>
          </div>
        </div>
      </div>

      <div class="monitor-footer">
        お手元のレシート番号をご参照ください / Please check your receipt number
      </div>
    </div>

    <!-- View 2: INPUT_MODE -->
    <div id="view-input" class="view">
      <div class="input-wrapper">
        <div class="input-header-text">受付番号を入力</div>
        <div id="input-display" class="display-screen"></div>
        <div
          id="input-msg"
          style="
            text-align: center;
            color: #d32f2f;
            height: 1.5em;
            font-weight: bold;
          "
        ></div>

        <div class="keypad">
          <button class="key-btn" onclick="app.keyPress('7')">7</button>
          <button class="key-btn" onclick="app.keyPress('8')">8</button>
          <button class="key-btn" onclick="app.keyPress('9')">9</button>
          <button class="key-btn" onclick="app.keyPress('4')">4</button>
          <button class="key-btn" onclick="app.keyPress('5')">5</button>
          <button class="key-btn" onclick="app.keyPress('6')">6</button>
          <button class="key-btn" onclick="app.keyPress('1')">1</button>
          <button class="key-btn" onclick="app.keyPress('2')">2</button>
          <button class="key-btn" onclick="app.keyPress('3')">3</button>
          <button class="key-btn key-clear" onclick="app.keyClear()">C</button>
          <button class="key-btn" onclick="app.keyPress('0')">0</button>
          <button class="key-btn key-enter" onclick="app.keyEnter()">OK</button>
        </div>
        <button
          class="btn btn-secondary"
          style="width: 100%; margin-top: 10px"
          onclick="app.transitionTo('idle')"
        >
          キャンセル
        </button>
      </div>
    </div>

    <!-- View 3: CONFIRM_MODE -->
    <div id="view-confirm" class="view">
      <div class="confirm-wrapper">
        <h2 style="font-size: 2rem; margin: 0">注文確認</h2>
        <div id="order-list" class="order-list"></div>
        <div style="font-size: 1rem; color: #666">合計金額</div>
        <div class="total-price">¥<span id="order-total">0</span></div>

        <div id="action-area">
          <button
            id="btn-pay-online"
            class="btn btn-primary"
            style="width: 100%; font-size: 1.8rem; padding: 25px"
          >
            受け取る (決済確定)
          </button>
          <div
            id="msg-pay-pos"
            class="hidden"
            style="
              font-size: 1.2rem;
              background: #eee;
              padding: 20px;
              border-radius: 8px;
            "
          >
            お会計はレジにてお願いします
          </div>
        </div>
        <button
          class="btn btn-secondary"
          style="margin-top: 20px; width: 100%"
          onclick="app.transitionTo('idle')"
        >
          戻る
        </button>
      </div>
    </div>

    <!-- View 4: COMPLETE_MODE -->
    <div id="view-complete" class="view">
      <svg class="success-icon" viewBox="0 0 24 24">
        <path
          d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm-1.25 17.292l-4.5-4.5 1.762-1.766L10.75 13.76l7.5-7.5 1.766 1.766-9.266 9.266z"
        />
      </svg>
      <div class="success-text">Thank You!</div>
      <p style="font-size: 1.5rem; color: #555">商品をお受け取りください</p>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getAuth,
        GoogleAuthProvider,
        signInWithPopup,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
      import {
        getFirestore,
        collection,
        query,
        where,
        onSnapshot,
        getDocs,
        doc,
        updateDoc,

        getDoc
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
      import {
        getFunctions,
        httpsCallable,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-functions.js";

      // Firebase設定
      const firebaseConfig = {
        apiKey: "AIzaSyA-Ijkbo-9rgrNKbDlRJ-rQVYdSXR_a9Do",
        authDomain: "nanryosai-2026-a4091.firebaseapp.com",
        projectId: "nanryosai-2026-a4091",
        storageBucket: "nanryosai-2026-a4091.appspot.com",
        messagingSenderId: "93228414556",
        appId: "1:93228414556:web:f64f90c13849fae9049899",
      };

      // URLパラメータ取得 (storeId)
      const urlParams = new URLSearchParams(window.location.search);
      const STORE_ID = urlParams.get("storeId") || "101";

      class KioskApp {
        constructor() {
          this.app = initializeApp(firebaseConfig);
          this.db = getFirestore(this.app);

          this.auth = getAuth(this.app);
          this.functions = getFunctions(this.app, 'asia-northeast1');

          this.currentInput = "";
          this.currentOrder = null;
          this.timerId = null;
          this.unsubOrderListener = null; 
          this.currentZoom = 1.0;

          // ... (existing code)

          this.views = {
            auth: document.getElementById("view-auth"),
            idle: document.getElementById("view-idle"),
            input: document.getElementById("view-input"),
            confirm: document.getElementById("view-confirm"),
            complete: document.getElementById("view-complete"),
          };

          document.getElementById("auth-store-id").innerText = STORE_ID;
          document.getElementById("menu-store-id").innerText = STORE_ID;
          this.init();
        }

        init() {
          // ... (existing init code)
          
          document
            .getElementById("btn-google-login")
            .addEventListener("click", () => {
              signInWithPopup(this.auth, new GoogleAuthProvider()).catch((e) =>
                alert(e.message)
              );
            });

          onAuthStateChanged(this.auth, (user) => {
            if (user) {
              const uName = user.email.split("@")[0];
              // document.getElementById("display-user") was removed in favor of menu-user
              const menuUser = document.getElementById("menu-user");
              if (menuUser) menuUser.innerText = uName;
              this.checkStoreLogin();
            } else {
              this.stopApp();
              this.transitionTo("auth");
              document.getElementById("store-login-modal").style.display = "none";
            }
          });

          // モニター画面全体のどこをタップしても入力画面へ (メニューなどを除く)
          this.views.idle.addEventListener("click", (e) => {
            // メニューやボタンクリック時は遷移しない
            if (e.target.closest(".menu-btn") || e.target.closest(".side-menu") || e.target.closest("button")) return;
            this.transitionTo("input");
          });

          // 店舗認証ボタン処理
          document.getElementById("store-login-btn").addEventListener("click", () => this.handleStoreLogin());
        }

        async checkStoreLogin() {
            const LS_KEY = "nanryosai_store_id";
            const cachedId = localStorage.getItem(LS_KEY);

            if (cachedId === STORE_ID) {
                // 認証済み
                this.startApp();
                this.transitionTo("idle");
            } else {
                // 未認証 -> モーダル表示
                const modal = document.getElementById("store-login-modal");
                document.getElementById("target-store-id-display").textContent = `Store ID: ${STORE_ID}`;
                modal.style.display = "flex";
            }
        }

        async handleStoreLogin() {
             const input = document.getElementById("store-password-input");
             const error = document.getElementById("store-login-error");
             const pass = input.value.trim();

             if (!pass) {
                 error.textContent = "パスワードを入力してください";
                 return;
             }
             
             const btn = document.getElementById("store-login-btn");
             btn.disabled = true;
             error.textContent = "認証中...";

             try {
                 const loginStore = httpsCallable(this.functions, 'loginStore');
                 const result = await loginStore({ storeId: STORE_ID, password: pass });

                 if (result.data.success) {
                     // 認証成功
                     localStorage.setItem("nanryosai_store_id", STORE_ID);
                     // Token Refresh
                     if(this.auth.currentUser) await this.auth.currentUser.getIdToken(true);

                     document.getElementById("store-login-modal").style.display = "none";
                     this.startApp();
                     this.transitionTo("idle");
                 }
             } catch (e) {
                 console.error(e);
                 error.textContent = "エラー: " + (e.message || "認証失敗");
                 btn.disabled = false;
             }
        }
        
        logout() {
          signOut(this.auth).catch((error) => {
            console.error("Sign out error", error);
          });
        }
        
        toggleMenu() {
            const menu = document.getElementById("side-menu");
            menu.classList.toggle("open");
        }
        
        adjustZoom(delta) {
            this.currentZoom = Math.round((this.currentZoom + delta) * 10) / 10;
            if (this.currentZoom < 0.5) this.currentZoom = 0.5;
            if (this.currentZoom > 2.0) this.currentZoom = 2.0;
            document.body.style.zoom = this.currentZoom;
        }

        startApp() {
          if (this.unsubReady || this.unsubPreparing) return;

          // 1. Ready (Call) Orders
          const qReady = query(
            collection(this.db, "orders"),
            where("storeId", "==", STORE_ID),
            where("status", "==", "ready_for_pickup")
            // Firestore doesn't support multiple properties orderBy easily with where clause without index
            // But we can sort on client side.
          );
          
          this.unsubReady = onSnapshot(qReady, (snapshot) => {
            const container = document.getElementById("grid-ready");
            if(container) {
                // Get data and sort by createdAt asc (unpaid/pending -> cooking -> ready)
                // Actually user said: "order number... pushed down".
                // If "pushed down", it means NEWEST at BOTTOM?
                // "1, 2, 3..." -> 1 is top, 3 is bottom.
                // So createdAt Ascending.
                const docs = [];
                snapshot.forEach(d => docs.push(d.data()));
                docs.sort((a,b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));

                container.innerHTML = ""; 
                docs.forEach((data) => {
                  const div = document.createElement("div");
                  div.className = "item-ready";
                  div.innerText = data.receiptNumber;
                  container.appendChild(div);
                });
            }
          });

          // 2. Preparing Orders
          const qPreparing = query(
            collection(this.db, "orders"),
            where("storeId", "==", STORE_ID),
            where("status", "in", ["unpaid_at_pos", "authorized", "cooking", "pending"]) 
          );

          this.unsubPreparing = onSnapshot(qPreparing, (snapshot) => {
            const container = document.getElementById("list-preparing");
            if(container) {
                const docs = [];
                snapshot.forEach(d => docs.push(d.data()));
                // Sort by createdAt ASC
                docs.sort((a,b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));

                container.innerHTML = "";
                docs.forEach((data) => {
                  const div = document.createElement("div");
                  div.className = "item-preparing";
                  div.innerText = data.receiptNumber;
                  container.appendChild(div);
                });
            }
          });
        }

        stopApp() {
          if (this.unsubReady) {
            this.unsubReady();
            this.unsubReady = null;
          }
          if (this.unsubPreparing) {
            this.unsubPreparing();
            this.unsubPreparing = null;
          }
        }

        transitionTo(stateName) {
          if (this.timerId) clearTimeout(this.timerId);
          
          // Clean up order listener if leaving confirm/input flow
          if (stateName !== "confirm" && this.unsubOrderListener) {
              this.unsubOrderListener();
              this.unsubOrderListener = null;
          }

          Object.values(this.views).forEach((el) =>
            el.classList.remove("active")
          );
          this.views[stateName].classList.add("active");

          if (stateName === "idle") {
            this.currentInput = "";
            this.updateInputDisplay();
          } else if (stateName === "input") {
            this.updateInputDisplay();
            this.resetTimer("idle", 30000);
          } else if (stateName === "confirm") {
            this.renderConfirmView();
            // confirm view updates are handled by the listener
          } else if (stateName === "complete") {
            this.resetTimer("idle", 8000);
          }
        }

        resetTimer(targetState, ms) {
          if (this.timerId) clearTimeout(this.timerId);
          this.timerId = setTimeout(() => {
            this.transitionTo(targetState);
          }, ms);
        }

        keyPress(char) {
          if (this.currentInput.length < 5) {
            this.currentInput += char;
            this.updateInputDisplay();
            this.resetTimer("idle", 30000); // Reset idle timer on interaction
          }
        }

        keyClear() {
          this.currentInput = "";
          this.updateInputDisplay();
          this.resetTimer("idle", 30000);
        }

        updateInputDisplay() {
          document.getElementById("input-display").innerText = this.currentInput;
          // Clear error message when typing
          if (this.currentInput.length > 0) {
             document.getElementById("input-msg").innerText = "";
          }
        }

        async keyEnter() {
          if (!this.currentInput) return;
          const num = parseInt(this.currentInput, 10);
          const msg = document.getElementById("input-msg");

          // Clean up any previous listener
          if (this.unsubOrderListener) {
            this.unsubOrderListener();
            this.unsubOrderListener = null;
          }

          try {
            const q = query(
              collection(this.db, "orders"),
              where("storeId", "==", STORE_ID),
              where("receiptNumber", "==", num),
              // We want to find the order even if it's already completed? 
              // Usually the user enters the number for a 'ready_for_pickup' order.
              // We'll search for 'ready_for_pickup' initially.
              where("status", "==", "ready_for_pickup")
            );
            
            // First, get the doc ID to set up a specific listener
            const snap = await getDocs(q);
            if (!snap.empty) {
                const docSnap = snap.docs[0];
                const orderId = docSnap.id;

                // Subscribe to this specific order
                this.unsubOrderListener = onSnapshot(doc(this.db, "orders", orderId), (docSnapshot) => {
                    if (!docSnapshot.exists()) {
                        // Document deleted?
                        msg.innerText = "注文が見つかりません";
                        this.transitionTo("input");
                        return;
                    }
                    
                    const data = docSnapshot.data();
                    this.currentOrder = { id: docSnapshot.id, ...data };

                    // Check status for auto-complete
                    if (data.status === "completed_at_store" || data.status === "completed_online") {
                        // Presenter or user completed it
                        
                        // Only transition if we are currently in confirm view or trying to get there
                        if (this.views.confirm.classList.contains("active") || this.views.input.classList.contains("active")) {
                             this.transitionTo("complete");
                        }
                    } else if (data.status === "ready_for_pickup") {
                        // If we are in input view, go to confirm
                         if (this.views.input.classList.contains("active")) {
                            this.transitionTo("confirm");
                         } else if (this.views.confirm.classList.contains("active")) {
                             // Re-render in case items changed
                             this.renderConfirmView();
                         }
                    } else {
                        // Other status? e.g. cancelled
                         msg.innerText = "ステータスが変更されました: " + data.status;
                         // Maybe go back to idle?
                    }
                });

            } else {
              msg.innerText = "番号が見つかりません";
              this.currentInput = "";
              document.getElementById("input-display").innerText = "";
            }
          } catch (e) {
            console.error(e);
            msg.innerText = "通信エラー";
          }
        }

        // --- Confirm Logic ---
        renderConfirmView() {
          const list = document.getElementById("order-list");
          const total = document.getElementById("order-total");
          const btn = document.getElementById("btn-pay-online");
          const msg = document.getElementById("msg-pay-pos");

          let html = "";
          let totalPrice = this.currentOrder.totalPrice || 0;

          if (this.currentOrder.items) {
            this.currentOrder.items.forEach((item) => {
              html += `
                        <div class="order-item">
                            <span style="font-weight:bold;">${item.name}</span>
                            <span>x${item.quantity}</span>
                        </div>`;
            });
          }
          list.innerHTML = html;
          total.innerText = totalPrice.toLocaleString();

          // ボタンのクローンと置換（イベントリスナー重複防止）
          const newBtn = btn.cloneNode(true);
          btn.parentNode.replaceChild(newBtn, btn);

          if (this.currentOrder.isPrepaid === true) {
            newBtn.style.display = "block";
            msg.classList.add("hidden");
            newBtn.addEventListener("click", () => this.executeComplete());
          } else {
            newBtn.style.display = "none";
            msg.classList.remove("hidden");
          }
        }

        async executeComplete() {
          if (!this.currentOrder) return;
          try {
            await updateDoc(doc(this.db, "orders", this.currentOrder.id), {
              status: "completed_online",
              updatedAt: new Date(),
            });
            this.transitionTo("complete");
          } catch (e) {
            alert("更新失敗: " + e.message);
          }
        }
      }

      window.app = new KioskApp();
    </script>
  </body>
</html>
