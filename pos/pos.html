<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>POS | 南陵祭2026</title>
    <style>
      :root {
        --bg-color: #333;
        --panel-bg: #f4f4f4;
        --selected-bg: #0d47a1;
        --text-color: #333;
        --shadow: 0 2px 0 rgba(0, 0, 0, 0.1);
      }

      * {
        box-sizing: border-box;
        user-select: none;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: "Helvetica Neue", Arial, sans-serif;
        height: 100vh;
        height: 100dvh;
        background-color: var(--bg-color);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      /* --- ログイン画面 --- */
      #login-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #eee;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      .login-card {
        background: white;
        padding: 40px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        text-align: center;
      }
      .google-btn {
        background: #4285f4;
        color: white;
        border: none;
        padding: 10px 20px;
        font-size: 16px;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 15px;
      }

      /* --- エラー画面 --- */
      #error-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #ffebee;
        z-index: 10000;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: #c62828;
        font-weight: bold;
        font-size: 1.5em;
        text-align: center;
        padding: 20px;
      }

      /* --- ローダー --- */
      #global-loader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 99999;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: white;
      }
      #global-loader.active {
        display: flex;
      }

      .spinner {
        width: 60px;
        height: 60px;
        border: 6px solid #f3f3f3;
        border-top: 6px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .loading-text {
        font-size: 1.5em;
        font-weight: bold;
        letter-spacing: 2px;
      }

      /* --- トップバー --- */
      .top-bar {
        height: 30px;
        background: #1a1a1a;
        color: #fff;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 15px;
        font-size: 0.9em;
        font-family: monospace;
        flex-shrink: 0;
      }
      .timer-display {
        color: #00e676;
        font-weight: bold;
      }

      /* --- アプリメイン画面 --- */
      #app-container {
        display: none;
        flex: 1;
        overflow: hidden;
      }

      /* 左側：注文リスト */
      .order-panel {
        height: 100%;
        overflow: hidden;
        width: 32%;
        background: #fff;
        display: flex;
        flex-direction: column;
        border-right: 4px solid #444;
      }
      .list-header {
        background: #333;
        color: #fff;
        padding: 10px;
        font-weight: bold;
        text-align: center;
        letter-spacing: 1px;
      }
      .order-list {
        min-height: 0;
        flex: 1;
        overflow-y: auto;
        padding: 0;
        margin: 0;
        list-style: none;
        background: #fff;
      }
      .order-item {
        padding: 10px 15px;
        border-bottom: 1px solid #ddd;
        cursor: pointer;
        font-size: 1.1em;
        color: #333;
      }
      .order-item.selected {
        background-color: var(--selected-bg);
        color: white;
      }
      .item-row {
        display: flex;
        align-items: baseline;
      }
      .item-qty {
        font-weight: 900;
        font-size: 1.3em;
        width: 40px;
        text-align: right;
        margin-right: 15px;
      }
      .item-name {
        font-weight: bold;
        flex: 1;
      }
      .item-price {
        font-size: 0.9em;
        font-weight: normal;
        margin-left: 10px;
      }
      .order-item.selected .item-qty {
        color: #ffeb3b;
      }
      .item-mods {
        padding-left: 55px;
        font-size: 0.85em;
        margin-top: 2px;
        display: flex;
        flex-direction: column;
      }
      .mod-line {
        font-weight: bold;
      }
      .mod-no {
        color: #d32f2f;
      }
      .mod-add {
        color: #2e7d32;
      }
      .order-item.selected .mod-no {
        color: #ff8a80;
      }
      .order-item.selected .mod-add {
        color: #b9f6ca;
      }
      .total-area {
        background: #222;
        color: #0f0;
        padding: 15px;
        font-size: 2.2em;
        text-align: right;
        font-family: "Courier New", monospace;
        font-weight: bold;
      }

      /* 右側：操作パネル */
      .control-panel {
        height: 100%;
        overflow: hidden;
        width: 68%;
        background: var(--panel-bg);
        padding: 8px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .modifier-row {
        display: flex;
        gap: 8px;
      }
      .mode-btn {
        flex: 0 0 80px;
        height: 60px;
        border: 1px solid #777;
        border-radius: 4px;
        background: linear-gradient(#fff, #eee);
        font-weight: bold;
        font-size: 1.2em;
        cursor: pointer;
        box-shadow: var(--shadow);
      }
      .mode-btn[data-mode="NO"].active {
        background: #d32f2f;
        color: white;
        border-color: #b71c1c;
      }
      .mode-btn[data-mode="ADD"].active {
        background: #2e7d32;
        color: white;
        border-color: #1b5e20;
      }

      .ingredient-container {
        flex: 1;
        display: flex;
        gap: 5px;
        overflow-x: auto;
        background: #e0e0e0;
        border: 1px solid #999;
        border-radius: 4px;
        padding: 4px;
        align-items: center;
      }
      .ing-btn {
        min-width: 80px;
        height: 100%;
        border: 1px solid #888;
        border-radius: 4px;
        background: white;
        font-weight: bold;
        font-size: 0.9em;
        cursor: pointer;
        box-shadow: var(--shadow);
        white-space: pre-wrap;
        line-height: 1.1;
      }
      .ing-btn:active {
        transform: translateY(2px);
        box-shadow: none;
      }
      .no-toppings-msg {
        width: 100%;
        text-align: center;
        color: #666;
        font-size: 0.9em;
      }

      .quantity-control-row {
        display: flex;
        gap: 10px;
        height: 60px;
        align-items: center;
        background: #ddd;
        border-radius: 6px;
        padding: 5px;
      }
      .qty-btn {
        height: 100%;
        flex: 1;
        font-size: 1.8em;
        font-weight: bold;
        border: 1px solid #888;
        border-radius: 4px;
        cursor: pointer;
        box-shadow: var(--shadow);
        background: linear-gradient(#fff, #f0f0f0);
      }
      .qty-btn:active {
        transform: translateY(2px);
        box-shadow: none;
      }
      .qty-btn.minus {
        color: #d32f2f;
      }
      .qty-btn.plus {
        color: #2e7d32;
      }
      .qty-display-area {
        flex: 0 0 80px;
        text-align: center;
        font-size: 2em;
        font-weight: bold;
        color: #333;
        background: white;
        height: 100%;
        line-height: 50px;
        border-radius: 4px;
        border: 1px solid #bbb;
      }
      .delete-btn {
        flex: 0 0 120px;
        height: 100%;
        background: #d32f2f;
        color: white;
        font-size: 1.1em;
        font-weight: bold;
        border: 1px solid #b71c1c;
        border-radius: 4px;
        cursor: pointer;
        box-shadow: var(--shadow);
        margin-left: 10px;
      }
      .delete-btn:active {
        transform: translateY(2px);
        box-shadow: none;
      }

      .product-grid {
        min-height: 0;
        flex: 1;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
        grid-auto-rows: 90px;
        gap: 8px;
        overflow-y: auto;
        align-content: start;
        padding-right: 4px;
      }
      .prod-btn {
        background: white;
        border: 1px solid #999;
        border-radius: 6px;
        padding: 5px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        position: relative;
        overflow: hidden;
        transition: all 0.2s;
      }
      .prod-btn:active {
        transform: scale(0.96);
        background: #eee;
      }
      .prod-name {
        font-weight: bold;
        line-height: 1.2;
        font-size: 0.95em;
      }
      .prod-price {
        font-size: 0.85em;
        margin-top: 5px;
        color: #555;
        font-weight: bold;
      }

      .prod-btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 6px;
        background: #999;
      }
      .prod-btn[data-type="burger"]::before {
        background: #ff9800;
      }
      .prod-btn[data-type="drink"]::before {
        background: #2196f3;
      }
      .prod-btn[data-type="side"]::before {
        background: #4caf50;
      }

      /* MOD: 売り切れ商品のスタイル */
      .prod-btn.disabled {
        background: #e0e0e0;
        cursor: not-allowed;
        opacity: 0.7;
        box-shadow: none;
      }
      .prod-btn.disabled .prod-name {
        color: #888;
      }
      .prod-btn.disabled::after {
        content: "SOLD OUT";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(-15deg);
        color: #d32f2f;
        font-weight: 900;
        font-size: 1.2em;
        border: 3px solid #d32f2f;
        padding: 2px 5px;
        background: rgba(255, 255, 255, 0.8);
        pointer-events: none;
      }

      .footer-actions {
        height: 70px;
        display: flex;
        gap: 10px;
        border-top: 1px solid #ccc;
        padding-top: 8px;
      }
      .action-btn {
        border: none;
        border-radius: 6px;
        color: white;
        font-weight: bold;
        font-size: 1.2em;
        cursor: pointer;
        box-shadow: var(--shadow);
      }
      .btn-clear {
        background: #555;
        width: 120px;
      }
      .btn-checkout {
        flex: 1;
        background: #2e7d32;
        font-size: 1.5em;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      /* --- モーダル (共通) --- */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
      }
      .modal-overlay.active {
        display: flex;
      }
      .modal-box {
        background: white;
        padding: 40px;
        border-radius: 12px;
        text-align: center;
        min-width: 450px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
      }
      .receipt-num {
        font-size: 5em;
        font-weight: bold;
        color: #333;
        margin: 20px 0;
      }
      .close-btn {
        padding: 10px 30px;
        font-size: 1.2em;
        cursor: pointer;
        border-radius: 6px;
        border: 1px solid #aaa;
        background: #eee;
      }
      .confirm-title {
        font-size: 1.5em;
        font-weight: bold;
        margin-bottom: 20px;
      }
      .confirm-total {
        font-size: 3em;
        font-weight: bold;
        color: #2e7d32;
        margin: 20px 0;
        font-family: "Courier New", monospace;
      }
      .confirm-text {
        font-size: 1.2em;
        color: #555;
        margin-bottom: 30px;
      }
      .modal-actions {
        display: flex;
        justify-content: center;
        gap: 20px;
      }
      .modal-btn {
        padding: 15px 40px;
        font-size: 1.2em;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: bold;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }
      .modal-btn:active {
        transform: translateY(2px);
        box-shadow: none;
      }
      .modal-btn.cancel {
        background: #999;
        color: white;
      }
      .modal-btn.confirm-checkout {
        background: #2e7d32;
        color: white;
      }
      .modal-btn.confirm-clear {
        background: #d32f2f;
        color: white;
      }

      /* --- 店舗ログインモーダル --- */
      #store-login-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #eee;
        z-index: 15000; /* エラー画面より上、ローダーより下 */
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
      }
      .store-login-card {
        background: white;
        padding: 40px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        max-width: 400px;
        width: 90%;
      }
      .store-login-input {
        width: 100%;
        padding: 12px;
        font-size: 1.2em;
        margin: 20px 0;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      .store-login-btn {
        width: 100%;
        padding: 12px;
        font-size: 1.2em;
        background: #333;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div id="global-loader">
      <div class="spinner"></div>
      <div class="loading-text" id="loader-text">読み込み中...</div>
    </div>

    <div id="error-screen">
      <p>
        店舗IDが指定されていません。<br />ポータル画面からアクセスしてください。
      </p>
    </div>

    <div id="login-screen">
      <div class="login-card">
        <h2>POS</h2>
        <p>スタッフログイン</p>
        <button id="google-login-btn" class="google-btn">
          Googleでログイン
        </button>
        <p id="login-error" style="color: red"></p>
      </div>
    </div>

    <div class="top-bar">
      <div id="clock-display">00:00:00</div>
      <div>
        経過時間: <span id="timer-display" class="timer-display">00:00</span>
      </div>
    </div>

    <div id="app-container">
      <div class="order-panel">
        <div class="list-header">注文リスト</div>
        <ul id="order-list" class="order-list"></ul>
        <div class="total-area" id="total-price">¥0</div>
      </div>

      <div class="control-panel">
        <div class="modifier-row">
          <button class="mode-btn" data-mode="NO" onclick="setMode('NO')">
            No<br /><small>抜き</small>
          </button>
          <button class="mode-btn" data-mode="ADD" onclick="setMode('ADD')">
            Add<br /><small>追加</small>
          </button>
          <div id="ingredient-container" class="ingredient-container">
            <div class="no-toppings-msg">商品を選択してください</div>
          </div>
        </div>

        <div class="quantity-control-row">
          <button class="qty-btn minus" onclick="changeQuantity(-1)">－</button>
          <div class="qty-display-area" id="current-qty-display">-</div>
          <button class="qty-btn plus" onclick="changeQuantity(1)">＋</button>
          <button class="delete-btn" onclick="deleteSelected()">削除</button>
        </div>

        <div id="product-grid" class="product-grid"></div>

        <div class="footer-actions">
          <button class="action-btn btn-clear" onclick="openClearModal()">
            全消去
          </button>
          <button class="action-btn btn-checkout" onclick="openCheckoutModal()">
            お会計
          </button>
        </div>
      </div>
    </div>

    <div id="checkout-confirm-modal" class="modal-overlay">
      <div class="modal-box">
        <div class="confirm-title">お会計確認</div>
        <div class="confirm-total" id="modal-total-price">¥0</div>
        <div class="confirm-text">この内容で会計を確定しますか？</div>
        <div class="modal-actions">
          <button class="modal-btn cancel" onclick="closeAllModals()">
            キャンセル
          </button>
          <button
            class="modal-btn confirm-checkout"
            onclick="processCheckout()"
          >
            確定する
          </button>
        </div>
      </div>
    </div>

    <div id="clear-confirm-modal" class="modal-overlay">
      <div class="modal-box">
        <div class="confirm-title" style="color: #d32f2f">警告</div>
        <div class="confirm-text">
          カートの中身を全て削除します。<br />よろしいですか？
        </div>
        <div class="modal-actions">
          <button class="modal-btn cancel" onclick="closeAllModals()">
            キャンセル
          </button>
          <button class="modal-btn confirm-clear" onclick="processClearCart()">
            削除する
          </button>
        </div>
      </div>
    </div>

    <div id="success-modal" class="modal-overlay">
      <div class="modal-box">
        <h2>注文を受け付けました</h2>
        <div class="receipt-num" id="receipt-display">---</div>
        <button class="close-btn" onclick="closeAllModals()">次の注文へ</button>
      </div>
    </div>

    <!-- 店舗ログインモーダル -->
    <div id="store-login-modal">
      <div class="store-login-card">
        <h2>店舗認証</h2>
        <p>セキュリティのため<br />店舗パスワードを入力してください</p>
        <p
          id="target-store-id-display"
          style="font-weight: bold; color: #555"
        ></p>
        <input
          type="password"
          id="store-password-input"
          class="store-login-input"
          placeholder="パスワード"
        />
        <button class="store-login-btn" id="store-login-btn">認証する</button>
        <p id="store-login-error" style="color: red; margin-top: 15px"></p>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
      import {
        getAuth,
        GoogleAuthProvider,
        signInWithPopup,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
      // MOD: onSnapshot をインポート
      import {
        getFirestore,
        collection,
        query,
        where,
        addDoc,
        serverTimestamp,
        onSnapshot,
        doc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
      import {
        getFunctions,
        httpsCallable,
      } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-functions.js";

      const firebaseConfig = {
        apiKey: "AIzaSyA-Ijkbo-9rgrNKbDlRJ-rQVYdSXR_a9Do",
        authDomain: "nanryosai-2026-a4091.firebaseapp.com",
        projectId: "nanryosai-2026-a4091",
        storageBucket: "nanryosai-2026-a4091.appspot.com",
        messagingSenderId: "93228414556",
        appId: "1:93228414556:web:f64f90c13849fae9049899",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const functions = getFunctions(app, "asia-northeast1");

      // State
      let products = [];
      let cart = [];
      let selectedUniqueId = null;
      let currentMode = null;
      let orderStartTime = null;
      let timerInterval = null;
      let isProcessing = false;
      let storeId = null;

      // MOD: リアルタイムリスナー解除用
      let unsubscribeProducts = null;

      // Elements
      const orderListEl = document.getElementById("order-list");
      const totalEl = document.getElementById("total-price");
      const modalTotalEl = document.getElementById("modal-total-price");
      const productGrid = document.getElementById("product-grid");
      const ingredientContainer = document.getElementById(
        "ingredient-container"
      );
      const modeBtns = document.querySelectorAll(".mode-btn");
      const qtyDisplay = document.getElementById("current-qty-display");
      const clockDisplay = document.getElementById("clock-display");
      const timerDisplay = document.getElementById("timer-display");
      const loader = document.getElementById("global-loader");
      const loaderText = document.getElementById("loader-text");
      const errorScreen = document.getElementById("error-screen");

      // Modals
      const checkoutModal = document.getElementById("checkout-confirm-modal");
      const clearModal = document.getElementById("clear-confirm-modal");
      const successModal = document.getElementById("success-modal");

      const urlParams = new URLSearchParams(window.location.search);
      storeId = urlParams.get("storeId");

      // Loader
      function showLoader(text = "処理中...") {
        loaderText.innerText = text;
        loader.classList.add("active");
        isProcessing = true;
      }
      function hideLoader() {
        loader.classList.remove("active");
        isProcessing = false;
      }

      // Auth
      document
        .getElementById("google-login-btn")
        .addEventListener("click", async () => {
          try {
            await signInWithPopup(auth, new GoogleAuthProvider());
          } catch (e) {
            document.getElementById("login-error").textContent = e.message;
          }
        });

      onAuthStateChanged(auth, (user) => {
        if (user) {
          if (!storeId) {
            document.getElementById("login-screen").style.display = "none";
            errorScreen.style.display = "flex";
            return;
          }
          // Googleログイン成功 -> 店舗パスワードチェックへ
          document.getElementById("login-screen").style.display = "none";
          checkStoreLogin();
        } else {
          document.getElementById("login-screen").style.display = "flex";
          document.getElementById("app-container").style.display = "none";
          document.getElementById("store-login-modal").style.display = "none"; // ログアウト時はモーダルも消す

          // ログアウト時は購読解除
          if (unsubscribeProducts) unsubscribeProducts();
        }
      });

      // 店舗認証チェック
      async function checkStoreLogin() {
        const LS_KEY = "nanryosai_store_id";
        const cachedId = localStorage.getItem(LS_KEY);

        if (cachedId === storeId) {
          // 認証済み
          document.getElementById("app-container").style.display = "flex";
          subscribeToProducts();
          startClock();
        } else {
          // 未認証 -> モーダル表示
          const modal = document.getElementById("store-login-modal");
          document.getElementById(
            "target-store-id-display"
          ).textContent = `Store ID: ${storeId}`;
          modal.style.display = "flex";
        }
      }

      // 店舗認証ボタン処理
      document
        .getElementById("store-login-btn")
        .addEventListener("click", async () => {
          const input = document.getElementById("store-password-input");
          const error = document.getElementById("store-login-error");
          const pass = input.value.trim();

          if (!pass) {
            error.textContent = "パスワードを入力してください";
            return;
          }

          const btn = document.getElementById("store-login-btn");
          btn.disabled = true;
          error.textContent = "認証中...";

          try {
            const loginStore = httpsCallable(functions, "loginStore");
            const result = await loginStore({
              storeId: storeId,
              password: pass,
            });

            if (result.data.success) {
              // 認証成功
              localStorage.setItem("nanryosai_store_id", storeId);
              // Token Refresh for Claims
              await auth.currentUser.getIdToken(true);

              document.getElementById("store-login-modal").style.display =
                "none";
              document.getElementById("app-container").style.display = "flex";
              subscribeToProducts();
              startClock();
            }
          } catch (e) {
            console.error(e);
            error.textContent =
              "エラー: " + (e.message || "認証に失敗しました");
            btn.disabled = false;
          }
        });

      // Clock
      function startClock() {
        setInterval(() => {
          const now = new Date();
          clockDisplay.textContent = now.toLocaleTimeString();
        }, 1000);
      }
      function startOrderTimer() {
        if (orderStartTime) return;
        orderStartTime = Date.now();
        timerDisplay.textContent = "00:00";
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
          const diff = Math.floor((Date.now() - orderStartTime) / 1000);
          const mm = String(Math.floor(diff / 60)).padStart(2, "0");
          const ss = String(diff % 60).padStart(2, "0");
          timerDisplay.textContent = `${mm}:${ss}`;
        }, 1000);
      }
      function resetOrderTimer() {
        clearInterval(timerInterval);
        orderStartTime = null;
        timerDisplay.textContent = "00:00";
      }

      // MOD: リアルタイムデータ取得
      function subscribeToProducts() {
        showLoader("商品データを\n同期しています");

        // isAvailableのフィルタを外し、この店舗の全商品を取得する
        const q = query(
          collection(db, "items"),
          where("storeId", "==", storeId)
        );

        // onSnapshotで監視
        unsubscribeProducts = onSnapshot(
          q,
          (snapshot) => {
            products = [];
            snapshot.forEach((doc) => {
              const data = doc.data();
              products.push({
                id: doc.id,
                name: data.name,
                price: Number(data.price),
                allowedToppings: data.allowedToppings || [],
                isAvailable: data.isAvailable, // 追加: 可否ステータス
              });
            });

            renderProductGrid();
            hideLoader();
          },
          (error) => {
            console.error("Error getting products:", error);
            productGrid.innerHTML = `<p style="color:red">同期エラー: ${error.message}</p>`;
            hideLoader();
          }
        );
      }

      function renderProductGrid() {
        productGrid.innerHTML = "";
        if (products.length === 0) {
          productGrid.innerHTML = "<p>商品がありません</p>";
          return;
        }

        products.forEach((p) => {
          const btn = document.createElement("div");
          btn.className = "prod-btn";

          // 売り切れ商品の制御
          if (!p.isAvailable) {
            btn.classList.add("disabled");
            btn.onclick = (e) => e.preventDefault(); // クリック無効
          } else {
            btn.onclick = () => addToCart(p);
          }

          let type = "other";
          if (p.name.match(/バーガー|マック|牛|サンド/)) type = "burger";
          else if (p.name.match(/ドリンク|コーラ|茶|水/)) type = "drink";
          else if (p.name.match(/ポテト|ナゲット/)) type = "side";
          btn.setAttribute("data-type", type);

          btn.innerHTML = `<span class="prod-name">${p.name}</span><span class="prod-price">¥${p.price}</span>`;
          productGrid.appendChild(btn);
        });
      }

      // Cart Logic
      window.addToCart = (product) => {
        if (isProcessing) return;
        // ガード: 売り切れ商品は追加させない
        if (!product.isAvailable) return;

        if (cart.length === 0) startOrderTimer();

        const existingItem = cart.find(
          (item) =>
            item.productId === product.id && item.customizations.length === 0
        );
        if (existingItem) {
          existingItem.quantity++;
          selectItem(existingItem.uniqueId);
        } else {
          const newItem = {
            uniqueId: Date.now() + Math.random(),
            productId: product.id,
            name: product.name,
            price: product.price,
            quantity: 1,
            customizations: [],
            allowedToppings: product.allowedToppings,
          };
          cart.push(newItem);
          selectItem(newItem.uniqueId);
        }
        renderCart();
      };

      function selectItem(uniqueId) {
        selectedUniqueId = uniqueId;
        currentMode = null;
        renderCart();
        updateModeButtons();
        renderDynamicToppingButtons();
        updateQtyDisplay();
      }

      function updateQtyDisplay() {
        if (!selectedUniqueId) {
          qtyDisplay.innerText = "-";
          return;
        }
        const item = cart.find((i) => i.uniqueId === selectedUniqueId);
        qtyDisplay.innerText = item ? item.quantity : "-";
      }

      window.changeQuantity = (delta) => {
        if (!selectedUniqueId) return;
        const idx = cart.findIndex((i) => i.uniqueId === selectedUniqueId);
        if (idx === -1) return;
        const item = cart[idx];
        const newQty = item.quantity + delta;

        if (newQty < 1) {
          cart.splice(idx, 1);
          selectedUniqueId = null;
        } else {
          item.quantity = newQty;
        }
        updateQtyDisplay();
        renderCart();
        renderDynamicToppingButtons();
      };

      window.deleteSelected = () => {
        if (!selectedUniqueId) return;
        const idx = cart.findIndex((i) => i.uniqueId === selectedUniqueId);
        if (idx === -1) return;
        cart.splice(idx, 1);
        selectedUniqueId = null;
        renderCart();
        renderDynamicToppingButtons();
        updateQtyDisplay();
      };

      function renderDynamicToppingButtons() {
        ingredientContainer.innerHTML = "";
        if (!selectedUniqueId) {
          ingredientContainer.innerHTML =
            '<div class="no-toppings-msg">商品を選択してください</div>';
          return;
        }
        const item = cart.find((i) => i.uniqueId === selectedUniqueId);
        if (!item || !item.allowedToppings.length) {
          ingredientContainer.innerHTML =
            '<div class="no-toppings-msg">トッピング不可</div>';
          return;
        }
        item.allowedToppings.forEach((toppingName) => {
          const btn = document.createElement("button");
          btn.className = "ing-btn";
          btn.innerText = toppingName;
          btn.onclick = () => applyIngredient(toppingName);
          ingredientContainer.appendChild(btn);
        });
      }

      window.setMode = (mode) => {
        if (!selectedUniqueId) return;
        currentMode = currentMode === mode ? null : mode;
        updateModeButtons();
      };

      window.applyIngredient = (ingName) => {
        if (!selectedUniqueId) return;
        if (!currentMode) {
          alert("先にモード(No, Add)を選択してください");
          return;
        }
        let idx = cart.findIndex((i) => i.uniqueId === selectedUniqueId);
        if (idx === -1) return;
        let item = cart[idx];

        if (item.quantity > 1) {
          item.quantity--;
          const newItem = {
            ...item,
            uniqueId: Date.now() + Math.random(),
            quantity: 1,
            customizations: [...item.customizations],
          };
          cart.push(newItem);
          item = newItem;
          selectedUniqueId = newItem.uniqueId;
        }

        const newMod = { mode: currentMode, target: ingName };
        const exIdx = item.customizations.findIndex(
          (c) => c.target === ingName
        );
        if (exIdx > -1) item.customizations[exIdx] = newMod;
        else item.customizations.push(newMod);

        currentMode = null;
        renderCart();
        updateModeButtons();
        updateQtyDisplay();
      };

      function renderCart() {
        orderListEl.innerHTML = "";
        let total = 0;
        cart.forEach((item) => {
          total += item.price * item.quantity;
          const li = document.createElement("li");
          li.className = `order-item ${
            item.uniqueId === selectedUniqueId ? "selected" : ""
          }`;
          li.onclick = () => selectItem(item.uniqueId);

          const modsHtml = item.customizations
            .map((c) => {
              const cls = c.mode === "NO" ? "mod-no" : "mod-add";
              return `<span class="mod-line ${cls}">${c.mode} ${c.target}</span>`;
            })
            .join("");

          li.innerHTML = `
                    <div class="item-row">
                        <span class="item-qty">${item.quantity}</span>
                        <span class="item-name">${item.name}</span>
                        <span class="item-price">¥${item.price}</span>
                    </div>
                    <div class="item-mods">${modsHtml}</div>
                `;
          orderListEl.appendChild(li);
        });
        totalEl.innerText = `¥${total.toLocaleString()}`;
      }

      function updateModeButtons() {
        modeBtns.forEach((btn) => {
          if (btn.dataset.mode === currentMode) btn.classList.add("active");
          else btn.classList.remove("active");
        });
      }

      // Modals
      window.closeAllModals = () => {
        if (isProcessing) return;
        checkoutModal.classList.remove("active");
        clearModal.classList.remove("active");
        successModal.classList.remove("active");
      };

      window.openCheckoutModal = () => {
        if (cart.length === 0) return;
        modalTotalEl.innerText = totalEl.innerText;
        checkoutModal.classList.add("active");
      };

      window.processCheckout = async () => {
        if (isProcessing) return;
        showLoader("注文を送信中...\n(少々お待ちください)");

        try {
          const getNextReceiptNumber = httpsCallable(
            functions,
            "getNextReceiptNumber"
          );
          const result = await getNextReceiptNumber({ orderType: "POS" });
          const receiptNumber = result.data.receiptNumber;

          const orderData = {
            items: cart.map((i) => ({
              productId: i.productId,
              name: i.name,
              price: i.price,
              quantity: i.quantity,
              customizations: i.customizations,
            })),
            totalPrice: cart.reduce((s, i) => s + i.price * i.quantity, 0),
            status: "unpaid_at_pos",
            createdAt: serverTimestamp(),
            receiptNumber: receiptNumber,
            storeId: storeId,
          };

          await addDoc(collection(db, "orders"), orderData);

          closeAllModals();
          document.getElementById(
            "receipt-display"
          ).innerText = `No. ${orderData.receiptNumber}`;
          successModal.classList.add("active");

          cart = [];
          selectedUniqueId = null;
          renderCart();
          renderDynamicToppingButtons();
          updateQtyDisplay();
          resetOrderTimer();
        } catch (e) {
          console.error("Error:", e);
          alert("エラーが発生しました。\n" + e.message);
          closeAllModals();
        } finally {
          hideLoader();
        }
      };

      window.openClearModal = () => {
        if (cart.length === 0) return;
        clearModal.classList.add("active");
      };

      window.processClearCart = () => {
        cart = [];
        selectedUniqueId = null;
        currentMode = null;
        renderCart();
        renderDynamicToppingButtons();
        updateModeButtons();
        updateQtyDisplay();
        resetOrderTimer();
        closeAllModals();
      };
    </script>
  </body>
</html>
