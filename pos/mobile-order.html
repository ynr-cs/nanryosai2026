<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Mobile Order | 南陵祭2026</title>
    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />
    <!-- Animate.css -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap"
      rel="stylesheet"
    />

    <style>
      /* =========================================
         1. Variables & Base
         ========================================= */
      :root {
        /* Colors */
        --primary-color: #1a1a1a; /* Deep Premium Black */
        --accent-color: #e53935; /* Vibrant Red */
        --brand-color: #ff9800; /* Warm Orange */
        --bg-color: #f0f2f5; /* Default Light */
        --card-bg: #ffffff;

        /* Text */
        --text-main: #2d3436;
        --text-sub: #636e72;
        --font-main:
          "Noto Sans JP", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;

        /* Dimensions */
        --radius-lg: 20px;
        --radius-md: 16px;
        --radius-sm: 10px;
        --shadow-soft: 0 10px 30px rgba(0, 0, 0, 0.08);
        --shadow-card: 0 4px 12px rgba(0, 0, 0, 0.05);
      }

      /* Dark Mode Overrides (System Setting) */
      @media (prefers-color-scheme: dark) {
        :root:not([data-theme="light"]) {
          --bg-color: #0f172a;
          --card-bg: #1e293b;
          --text-main: #f1f5f9;
          --text-sub: #94a3b8;
          --primary-color: #334155;
          --shadow-soft: 0 10px 30px rgba(0, 0, 0, 0.5);
          --shadow-card: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        :root:not([data-theme="light"]) .btn-primary-custom {
          color: #fff !important;
        }
        :root:not([data-theme="light"]) .btn-close {
          filter: invert(1) grayscale(100%) brightness(200%);
        }
      }

      /* Explicit Dark Theme Override */
      [data-theme="dark"] {
        --bg-color: #0f172a;
        --card-bg: #1e293b;
        --text-main: #f1f5f9;
        --text-sub: #94a3b8;
        --primary-color: #334155;
        --shadow-soft: 0 10px 30px rgba(0, 0, 0, 0.5);
        --shadow-card: 0 4px 12px rgba(0, 0, 0, 0.3);
      }
      [data-theme="dark"] .btn-primary-custom {
        color: #fff !important;
      }
      [data-theme="dark"] .btn-close {
        filter: invert(1) grayscale(100%) brightness(200%);
      }

      /* Explicit Light Theme Override */
      [data-theme="light"] {
        --bg-color: #f0f2f5;
        --card-bg: #ffffff;
        --text-main: #2d3436;
        --text-sub: #636e72;
        --shadow-soft: 0 10px 30px rgba(0, 0, 0, 0.08);
        --shadow-card: 0 4px 12px rgba(0, 0, 0, 0.05);
      }

      body {
        background-color: var(--bg-color);
        color: var(--text-main);
        font-family: var(--font-main);
        margin: 0;
        height: 100dvh;
        width: 100vw;
        overflow: hidden;

        display: flex;
        flex-direction: column;
        justify-content: flex-start; /* Ensure start from top */
        align-items: center; /* Center horizontally */

        /* Padding is handled by style.css */
        box-sizing: border-box;
      }

      /* =========================================
         2. App Layout Container
         ========================================= */
      #app-container {
        width: 100%;
        max-width: 500px; /* Max width for PC */
        height: 100%; /* Force full height usage of flex space */
        flex: 1 1 auto; /* Grow to fill space */
        margin: 0 auto; /* Horizontal centering */

        overflow: hidden; /* Internal scrolling */
        background: var(--bg-color);
        position: relative;
        z-index: 1;
        display: flex;
        flex-direction: column;

        /* Subtle device boundary on PC */
        box-shadow: 0 0 40px rgba(0, 0, 0, 0.1);
      }

      @media (max-width: 500px) {
        #app-container {
          max-width: 100%;
          box-shadow: none;
        }
      }

      /* Loading Overlay */
      #global-loader {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--bg-color);
        z-index: 9999;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 20px;
      }
      .premium-loader {
        position: relative;
        width: 60px;
        height: 60px;
      }
      .premium-loader:before,
      .premium-loader:after {
        content: "";
        position: absolute;
        border-radius: 50%;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
      .premium-loader:before {
        width: 100%;
        height: 100%;
        border: 4px solid var(--brand-color);
        opacity: 0.6;
        animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
      }
      .premium-loader:after {
        width: 60%;
        height: 60%;
        background: var(--brand-color);
        animation: pulse-dot 1.5s cubic-bezier(0.455, 0.03, 0.515, 0.955)
          infinite;
        box-shadow: 0 0 15px var(--brand-color);
      }
      .loader-text {
        font-weight: 700;
        letter-spacing: 0.1em;
        font-size: 0.9rem;
        color: var(--text-sub);
        text-transform: uppercase;
        animation: fade-text 1.5s ease-in-out infinite alternate;
      }
      @keyframes pulse-ring {
        0% {
          width: 60%;
          height: 60%;
          opacity: 1;
        }
        100% {
          width: 150%;
          height: 150%;
          opacity: 0;
        }
      }
      @keyframes pulse-dot {
        0% {
          width: 60%;
          height: 60%;
        }
        50% {
          width: 80%;
          height: 80%;
        }
        100% {
          width: 60%;
          height: 60%;
        }
      }
      @keyframes fade-text {
        0% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }

      /* =========================================
         3. Screen Management
         ========================================= */
      .screen {
        display: none;
        flex: 1; /* Take all available space */
        flex-direction: column;
        padding: 24px;
        padding-bottom: 80px; /* Extra space for bottom nav clearance inside scrolling area */
        overflow-y: auto; /* Internal scroll */
        -webkit-overflow-scrolling: touch;
      }

      .screen.active {
        display: flex;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* =========================================
         4. UI Components
         ========================================= */
      /* Buttons */
      .btn-primary-custom {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 18px;
        border-radius: var(--radius-lg);
        font-weight: 700;
        width: 100%;
        font-size: 1.05rem;
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        transition:
          transform 0.2s,
          box-shadow 0.2s;
        letter-spacing: 0.05em;
      }
      .btn-primary-custom:active:not(:disabled) {
        transform: scale(0.96);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .btn-primary-custom:disabled {
        background: #ced4da;
        box-shadow: none;
        cursor: not-allowed;
      }

      /* Store Cards */
      .store-card {
        background: var(--card-bg);
        border-radius: var(--radius-md);
        border: none;
        padding: 20px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 20px;
        box-shadow: var(--shadow-card);
        cursor: pointer;
        transition:
          transform 0.2s,
          box-shadow 0.2s;
      }
      .store-card:active {
        transform: scale(0.97);
        background: #fff;
      }
      .store-img {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        object-fit: cover;
        background: #eee;
        box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.05);
      }
      .store-info h3 {
        font-size: 1.15rem;
        font-weight: 800;
        margin: 0 0 4px 0;
        color: var(--text-main);
      }

      /* Menu Cards */
      .menu-card {
        background: var(--card-bg);
        border-radius: var(--radius-md);
        overflow: hidden;
        box-shadow: var(--shadow-card);
        border: none;
        display: flex;
        flex-direction: column;
        transition:
          transform 0.2s,
          box-shadow 0.2s;
        height: 100%;
      }
      .menu-card:active {
        transform: scale(0.96);
      }
      .menu-img-box {
        position: relative;
        padding-top: 80%;
        background: #f1f3f5;
        overflow: hidden;
      }
      .menu-img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        opacity: 0;
        transition: opacity 0.4s ease;
        z-index: 2;
      }
      .menu-img.loaded,
      #modal-item-img.loaded {
        opacity: 1 !important;
      }
      .menu-info {
        padding: 16px;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }

      /* Image Loader Spinner */
      .img-loader {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1;
      }

      /* Badges */
      .sold-out-badge {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.7);
        z-index: 10;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .sold-out-text {
        background: #333;
        color: white;
        padding: 5px 15px;
        font-weight: 900;
        transform: rotate(-10deg);
      }

      /* =========================================
         5. Page Specific Styles
         ========================================= */
      /* Login Step */
      #step-login {
        justify-content: center;
        align-items: center;
        text-align: center;
      }
      .login-hero {
        margin-bottom: 40px;
      }
      .login-logo {
        font-size: 3rem;
        margin-bottom: 10px;
      }

      /* Terms Step */
      .terms-warning-box {
        background: #ffebee;
        border: 2px solid var(--accent-color);
        border-radius: var(--radius-md);
        padding: 20px;
        margin: 20px 0;
      }
      .warning-title {
        color: var(--accent-color);
        font-weight: 900;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
      }
      .warning-list {
        text-align: left;
        margin-bottom: 0;
        padding-left: 20px;
        font-weight: 700;
        color: #b71c1c;
      }
      .warning-list li {
        margin-bottom: 10px;
      }
      .ban-warning {
        font-size: 1.1em;
        background: #b71c1c;
        color: white;
        padding: 10px;
        border-radius: 8px;
        margin-top: 10px;
        font-weight: 900;
      }

      /* Customization / Toppings */
      .mode-toggle {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }
      .mode-btn {
        flex: 1;
        padding: 10px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        background: var(--card-bg);
        font-weight: bold;
        color: var(--text-sub);
        transition: all 0.2s;
      }
      .mode-btn.active[data-mode="NO"] {
        border-color: #d32f2f;
        background: #d32f2f;
        color: white;
      }
      .mode-btn.active[data-mode="ADD"] {
        border-color: #2e7d32;
        background: #2e7d32;
        color: white;
      }
      .topping-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 20px;
      }
      .topping-btn {
        padding: 8px 15px;
        border: 1px solid var(--border-color);
        border-radius: 20px;
        background: var(--card-bg);
        color: var(--text-main);
        font-size: 1.1rem;
        font-weight: bold;
        transition: all 0.2s;
      }
      .topping-btn:active {
        background: var(--border-color);
      }
      .topping-btn.mod-selected-no {
        background: rgba(211, 47, 47, 0.2);
        border-color: #d32f2f;
        color: #ef5350;
      }
      .topping-btn.mod-selected-add {
        background: rgba(46, 125, 50, 0.2);
        border-color: #2e7d32;
        color: #66bb6a;
      }
      .active-mods-display {
        min-height: 40px;
        background: #fce4ec;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 20px;
      }
      .mod-tag {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        margin-right: 5px;
        margin-bottom: 5px;
        font-weight: bold;
        color: white;
      }
      .mod-tag.no {
        background: #d32f2f;
      }
      .mod-tag.add {
        background: #2e7d32;
      }

      /* =========================================
         6. Cart & Checkout Components
         ========================================= */
      /* Bottom Bar */
      .bottom-cart-bar {
        position: fixed;
        bottom: 24px;
        left: 50%;
        transform: translateX(-50%);
        width: 100%;
        max-width: 440px;
        background: #2d3436; /* Premium Dark */
        color: white;
        z-index: 1050;
        border-radius: 100px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25);
        display: none; /* Flex when visible */
        justify-content: space-between;
        align-items: center;
        padding: 8px 8px 8px 24px;
        cursor: pointer;
        transition:
          transform 0.2s,
          background 0.2s;
      }
      .bottom-cart-bar:active {
        transform: translateX(-50%) scale(0.98);
        background: #212529;
      }
      .cart-left-section {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .cart-icon-box {
        position: relative;
        font-size: 1.4rem;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .cart-badge {
        position: absolute;
        top: -6px;
        right: -8px;
        background: var(--accent-color);
        color: white;
        font-size: 0.75rem;
        font-weight: bold;
        min-width: 20px;
        height: 20px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        border: 2px solid #2d3436;
      }
      .cart-total-price {
        font-size: 1.25rem;
        font-weight: 800;
        font-family: var(--font-main);
        letter-spacing: 0.02em;
      }
      .btn-checkout-action {
        background: var(--brand-color);
        color: white;
        font-weight: 800;
        border: none;
        border-radius: 50px;
        padding: 14px 28px;
        display: flex;
        align-items: center;
        gap: 6px;
        box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4);
        transition:
          transform 0.2s,
          background 0.2s;
      }
      .btn-checkout-action:active {
        transform: scale(0.95);
        background: #f57c00;
      }

      /* Cart Item in Modal */
      .cart-item {
        background: var(--card-bg);
        border-radius: var(--radius-md);
        padding: 16px;
        margin-bottom: 12px;
        box-shadow: var(--shadow-card);
        border: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: transform 0.2s;
      }
      .cart-item:active {
        transform: scale(0.98);
      }
      .cart-item-details h5 {
        font-size: 1.05rem;
        margin: 0 0 4px 0;
        font-weight: 700;
        color: var(--text-main);
      }
      .cart-item-price {
        font-weight: bold;
        color: var(--text-main);
        font-size: 0.95rem;
      }
      .cart-item-mods {
        margin-top: 6px;
      }
      .cart-del-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #ffebee;
        color: #d32f2f;
        border: none;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.1rem;
        transition: background 0.2s;
      }
      .cart-del-btn:active {
        background: #ffcdd2;
      }

      .cart-total-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 10px 0;
      }
      .cart-total-label {
        font-size: 1.1rem;
        font-weight: bold;
        color: var(--text-sub);
      }
      .cart-total-value {
        font-size: 2rem;
        font-weight: 800;
        color: var(--text-main);
      }

      /* =========================================
         7. Modals (Custom Styles)
         ========================================= */
      .modal.bottom-sheet .modal-dialog {
        margin: 0;
        position: fixed;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 100%;
        max-width: 480px;
      }
      .mobile-fullscreen-modal .modal-dialog {
        width: 100%;
        max-width: 480px;
        margin: 0 auto;
        height: 100%;
        padding: 0;
      }
      .mobile-fullscreen-modal .modal-content {
        height: 100%;
        border-radius: 0;
        border: none;
        display: flex;
        flex-direction: column;
      }
      .modal-backdrop.show {
        opacity: 0.2;
      }

      /* Make modal-body flex-grow and remove large padding */
      .mobile-fullscreen-modal .modal-body {
        flex-grow: 1;
        overflow-y: auto;
        padding: 20px; /* Reduced padding */
      }

      /* Reset modal-footer to static position */
      .mobile-fullscreen-modal .modal-footer {
        position: static;
        margin-top: auto;
        padding: 15px 20px; /* Add some padding */
      }

      /* =========================================
         8. Layout Overrides for App Shell Integration
         ========================================= */

      /* 
         The App Shell (style.css) adds padding-top and padding-bottom to BODY.
         So normally content sits strictly between Header and Bottom Nav.
         
         However, for the immersive Mobile Order UI, we want:
         1. The "App Container" to fill that exact available space.
         2. Internal scrolling within the container, not the body.
      */

      /* Ensure body doesn't scroll, only the container */
      body {
        overflow: hidden;
      }

      #app-container {
        /* This will naturally fill the flex space provided by body (which has padding) */
        flex: 1; /* Grow to fill the vertical space between header and footer */
        height: auto; /* Let flex handle the height */
        width: 100%;
        max-width: 500px; /* Width increased to 500px as requested */
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        overflow: hidden; /* Ensure inner content doesn't spill out and cause body scroll */

        /* Reset any transforms from previous scripts if they interfere */
        transform-origin: top center;
        background: var(--bg-color); /* Ensure background is solid */
        border-right: 1px solid rgba(0, 0, 0, 0.05); /* Subtle border for desktop view */
        border-left: 1px solid rgba(0, 0, 0, 0.05);
      }

      /* Screens take full available height of the container */
      .screen {
        padding: 20px; /* Standard internal padding */
        padding-bottom: 40px; /* Reduced padding since container will end above the nav */
      }

      /* Menu Screen specific: Remove default padding to allow sticky header to hit top edge of container */
      #step-menu {
        padding: 0;
      }

      /* Sticky Header stays at top of CONTAINER, not viewport */
      #menu-header.sticky-top {
        top: 0 !important;
        z-index: 100;
      }

      /* Grid needs padding for the floating content */
      #menu-grid {
        padding: 15px;
        padding-bottom: 140px; /* Clear the cart bar */
      }

      /* Cart bar position relative to container */
      .bottom-cart-bar {
        position: absolute; /* Absolute within #app-container */
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 400px;
        z-index: 1050;
      }
    </style>
  </head>
  <body>
    <div id="app-container">
      <!-- =========================================
           Screen 1: Loading
           ========================================= -->
      <div id="global-loader">
        <div class="premium-loader"></div>
        <div class="loader-text">Loading...</div>
      </div>

      <!-- =========================================
           Screen 2: Login
           ========================================= -->
      <div id="step-login" class="screen">
        <div
          class="login-hero"
          style="font-family: &quot;Noto Sans JP&quot;, sans-serif"
        >
          <p
            style="
              color: var(--text-sub);
              margin-bottom: 0.5rem;
              font-weight: 500;
            "
          >
            南陵祭2026
          </p>
          <h1
            style="
              font-size: 2.5rem;
              font-weight: 700;
              margin-bottom: 1.5rem;
              color: var(--text-main);
            "
          >
            モバイルオーダー
          </h1>
          <p
            style="
              color: var(--text-sub);
              font-size: 0.875rem;
              line-height: 1.6;
            "
          >
            モバイルオーダー機能を使うには<br />
            ログインしてください
          </p>
        </div>
        <button id="btn-login" class="btn-primary-custom">
          <i class="bi bi-google me-2"></i> Google でログイン
        </button>
        <div
          class="mt-4 p-3 rounded text-start"
          style="
            background: var(--item-fill);
            font-size: 0.85rem;
            border: 1px solid var(--border-color);
          "
        >
          <strong
            class="d-block mb-2"
            style="font-size: 0.95rem; color: #ff4757"
            >⚠️ 推奨ブラウザについて</strong
          >
          <p class="mb-3" style="color: var(--text-main)">
            本システムの利用には、以下のブラウザを推奨しています。
          </p>

          <p class="fw-bold mb-1" style="color: var(--text-main)">
            ✅ 推奨ブラウザ
          </p>
          <ul class="mb-3 ps-3" style="color: var(--text-main)">
            <li>Google Chrome</li>
          </ul>
          <p class="mb-0 small" style="color: var(--text-sub)">
            ※
            その他の環境やアプリ内ブラウザ（LINE/Instagram等）では、正常にログインできない場合があります。
          </p>
          <div
            class="mt-2 pt-2"
            style="border-top: 1px dashed var(--border-color)"
          >
            <small style="color: var(--text-sub)"
              >動作しない場合は
              <a
                href="https://docs.google.com/forms/d/e/1FAIpQLSf7PQQPMjnIGnzr_dYKwudQllR7w0b9poia4n7XI_ktmkgkOQ/viewform?usp=header"
                id="bug-report-link-mobile"
                target="_blank"
                style="color: #4dabf7; text-decoration: underline"
                >不具合報告フォーム</a
              >
              までご連絡ください。</small
            >
          </div>
        </div>
      </div>

      <!-- =========================================
           Screen 3: Notifications
           ========================================= -->
      <div id="step-notification" class="screen text-center">
        <div class="mt-5 mb-4">
          <div class="mb-3">
            <i class="bi bi-bell-fill text-warning" style="font-size: 4rem"></i>
          </div>
          <h2 class="fw-bold">通知の設定</h2>
          <p class="text-muted mt-3">
            商品の準備ができたら<br />
            プッシュ通知でお知らせします。
          </p>
          <p class="text-muted small">
            次の画面で表示されるポップアップで<br />
            <strong>「許可」</strong>を選択してください。
          </p>
        </div>
        <div class="mt-auto pb-4">
          <button id="btn-req-notification" class="btn-primary-custom mb-3">
            通知を受け取る
          </button>
          <button
            class="btn btn-link text-secondary text-decoration-none"
            onclick="skipNotification()"
          >
            通知を受け取らない
          </button>
        </div>
      </div>

      <!-- =========================================
           Screen 4: Terms & Agreement
           ========================================= -->
      <div id="step-terms" class="screen">
        <div class="text-center mt-3 mb-2">
          <i
            class="bi bi-shield-exclamation text-danger"
            style="font-size: 2.5rem"
          ></i>
          <h3 class="fw-bold mt-1 mb-0">利用規約の確認</h3>
        </div>

        <div class="terms-warning-box p-3 my-2">
          <div class="warning-title mb-2 fs-6">
            <i class="bi bi-exclamation-triangle-fill"></i> 注意事項
          </div>
          <ul class="warning-list small mb-2">
            <li>注文確定後のキャンセルはできません</li>
            <li>受け取りは「呼出」から15分以内</li>
            <li>返金対応は致しかねます</li>
          </ul>
          <div class="ban-warning text-center p-2 fs-6 mt-2">
            違反時は全サービスから<br />永久BANします
          </div>
        </div>

        <div class="mt-auto pb-2">
          <div
            class="form-check mb-3 d-flex justify-content-center gap-2 align-items-center"
          >
            <input
              class="form-check-input"
              type="checkbox"
              id="check-terms"
              style="transform: scale(1.2)"
            />
            <label class="form-check-label fw-bold small" for="check-terms"
              >上記内容を理解し、同意します</label
            >
          </div>
          <button id="btn-agree-terms" class="btn-primary-custom py-3" disabled>
            同意して次へ
          </button>
        </div>
      </div>

      <!-- =========================================
           Screen 5: Store Selection
           ========================================= -->
      <div id="step-stores" class="screen">
        <h2 class="fw-bold mb-4">店舗を選択</h2>
        <div id="store-list">
          <!-- JS Injected -->
        </div>
      </div>

      <!-- =========================================
           Screen 6: Menu (Grid)
           ========================================= -->
      <div id="step-menu" class="screen">
        <div
          id="menu-header"
          class="p-3 sticky-top shadow-sm d-flex align-items-center justify-content-between"
          style="background: var(--card-bg); color: var(--text-main)"
        >
          <h5 class="m-0 fw-bold" id="menu-store-name">Store Name</h5>
          <button
            class="btn btn-sm btn-outline-secondary rounded-circle"
            onclick="backToStores()"
          >
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
        <div
          id="menu-grid"
          class="p-3"
          style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px"
        >
          <!-- JS Injected -->
        </div>
      </div>

      <!-- =========================================
           Screen 7: Checkout (Confirmation)
           ========================================= -->
      <div id="step-checkout" class="screen">
        <h2 class="fw-bold mb-4">注文内容の確認</h2>
        <div
          class="card mb-3 shadow-sm border-0"
          style="background: var(--card-bg); color: var(--text-main)"
        >
          <div class="card-body">
            <h6 class="small" style="color: var(--text-sub)">受け取り店舗</h6>
            <h4 class="fw-bold" id="checkout-store-name">Store Name</h4>
          </div>
        </div>
        <div
          class="card mb-3 shadow-sm border-0"
          style="background: var(--card-bg); color: var(--text-main)"
        >
          <div
            class="card-header border-bottom-0 fw-bold"
            style="background: var(--card-bg); color: var(--text-main)"
          >
            注文商品
          </div>
          <div class="card-body p-0">
            <div id="checkout-items-list" class="list-group list-group-flush">
              <!-- Injected -->
            </div>
          </div>
        </div>
        <div
          class="d-flex justify-content-between align-items-center mb-4 px-2"
        >
          <span class="fw-bold fs-5">合計金額</span>
          <span class="fw-bold fs-2 text-danger" id="checkout-total">¥0</span>
        </div>
        <div class="alert alert-danger small" role="alert">
          <i class="bi bi-exclamation-triangle-fill me-1"></i>
          <strong>確定後のキャンセル・返金はできません。</strong><br />
          調理完了通知が届いてから15分以内に受け取りに来てください。
        </div>
        <button class="btn-primary-custom mb-3" onclick="finalizeOrder()">
          注文を確定する
        </button>
        <button
          class="btn btn-link text-secondary w-100"
          onclick="backToMenu()"
        >
          メニューに戻る
        </button>
      </div>

      <!-- =========================================
           Global Components: Bottom Bar
           ========================================= -->
      <div id="bottom-bar" class="bottom-cart-bar" onclick="openCart()">
        <div class="cart-left-section">
          <div class="cart-icon-box">
            <i class="bi bi-cart-fill"></i>
            <span class="cart-badge" id="bar-count-badge">0</span>
          </div>
          <span class="cart-total-price" id="bar-total">¥0</span>
        </div>
        <button
          class="btn-checkout-action"
          onclick="
            event.stopPropagation();
            checkout();
          "
        >
          レジへ
          <i class="bi bi-arrow-right-short" style="font-size: 1.2rem"></i>
        </button>
      </div>

      <!-- =========================================
           Modals (Inside Container)
           ========================================= -->
      <!-- Item Details Modal (Fullscreen) -->
      <div
        class="modal fade mobile-fullscreen-modal"
        id="itemModal"
        tabindex="-1"
        data-bs-backdrop="false"
        style="position: absolute"
      >
        <div class="modal-dialog">
          <div
            class="modal-content border-0"
            style="background: var(--bg-color)"
          >
            <div
              class="modal-header border-0 shadow-sm"
              style="background: var(--card-bg); color: var(--text-main)"
            >
              <button
                type="button"
                class="btn btn-link p-0 me-3"
                data-bs-dismiss="modal"
                style="font-size: 1.5rem; color: var(--text-main)"
              >
                <i class="bi bi-chevron-left"></i>
              </button>
              <h5
                class="modal-title fw-bold flex-grow-1 text-center pe-4"
                id="modal-item-name"
              >
                商品名
              </h5>
            </div>
            <div
              class="modal-body p-0"
              style="background: var(--bg-color); flex: 1; overflow-y: auto"
            >
              <div
                class="text-center py-2 mb-3 shadow-sm position-relative"
                style="
                  background: var(--card-bg);
                  min-height: 200px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                "
              >
                <div class="img-loader">
                  <div
                    class="spinner-border text-secondary"
                    role="status"
                  ></div>
                </div>
                <img
                  id="modal-item-img"
                  src=""
                  class="img-fluid"
                  style="
                    max-width: 80%;
                    max-height: 200px;
                    object-fit: contain;
                    opacity: 0;
                    transition: opacity 0.3s;
                  "
                />
              </div>
              <div class="px-3 mb-4">
                <p
                  class="small"
                  style="color: var(--text-sub)"
                  id="modal-item-desc"
                >
                  注文後の調理となります。<br />※画像はイメージです。
                </p>
              </div>
              <div class="px-3">
                <div
                  id="customization-area"
                  class="p-3 rounded-3 shadow-sm mb-3"
                  style="background: var(--card-bg); color: var(--text-main)"
                >
                  <div
                    class="d-flex align-items-center justify-content-between"
                    data-bs-toggle="collapse"
                    data-bs-target="#customization-collapse"
                    aria-expanded="false"
                    aria-controls="customization-collapse"
                    style="cursor: pointer"
                  >
                    <div class="d-flex align-items-center">
                      <i class="bi bi-gear-fill me-2 text-primary"></i>
                      <span class="fw-bold">カスタマイズ</span>
                    </div>
                    <i
                      class="bi bi-chevron-down"
                      style="color: var(--text-sub)"
                    ></i>
                  </div>
                  <div class="collapse mt-3" id="customization-collapse">
                    <div class="mode-toggle mb-3">
                      <button
                        class="mode-btn w-100 py-2"
                        data-mode="NO"
                        onclick="setMode('NO')"
                      >
                        <i class="bi bi-dash-circle me-1"></i> 抜き
                      </button>
                      <button
                        class="mode-btn w-100 py-2"
                        data-mode="ADD"
                        onclick="setMode('ADD')"
                      >
                        <i class="bi bi-plus-circle me-1"></i> 追加
                      </button>
                    </div>
                    <p class="small mb-2 ms-1" style="color: var(--text-sub)">
                      <i class="bi bi-info-circle me-1"></i
                      >先に「抜き」か「追加」を選んでください
                    </p>
                    <div class="topping-list" id="topping-list"></div>
                    <div
                      class="active-mods-display mt-3"
                      id="active-mods-display"
                      style="display: none"
                    >
                      <small class="d-block mb-1" style="color: var(--text-sub)"
                        >選択中の変更:</small
                      >
                      <div id="active-mods-list"></div>
                    </div>
                  </div>
                </div>
              </div>
              <div style="height: 100px"></div>
            </div>
            <div
              class="modal-footer border-top d-block p-3"
              style="
                background: var(--card-bg);
                border-top-color: var(--border-color) !important;
              "
            >
              <div class="d-flex justify-content-between align-items-end mb-2">
                <div>
                  <span
                    class="fs-2 fw-bold"
                    id="modal-item-price"
                    style="color: var(--text-main)"
                    >¥0</span
                  >
                </div>
                <div
                  class="d-flex align-items-center rounded-pill px-2 py-1 border"
                  style="
                    background: var(--bg-color);
                    border-color: var(--border-color) !important;
                  "
                >
                  <button
                    class="btn btn-sm"
                    onclick="adjustQty(-1)"
                    style="
                      font-size: 1.2rem;
                      width: 30px;
                      color: var(--text-sub);
                    "
                  >
                    -
                  </button>
                  <span
                    class="mx-3 fw-bold fs-5"
                    id="modal-item-qty"
                    style="color: var(--text-main)"
                    >1</span
                  >
                  <button
                    class="btn btn-sm text-primary"
                    onclick="adjustQty(1)"
                    style="font-size: 1.2rem; width: 30px"
                  >
                    +
                  </button>
                </div>
              </div>
              <div class="d-flex gap-2 mt-3">
                <button
                  class="btn btn-warning w-100 py-3 rounded-pill fw-bold text-dark shadow-sm"
                  onclick="commitAddToCart()"
                >
                  カートに追加
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Cart Modal (Bottom Sheet) -->
      <div
        class="modal fade bottom-sheet"
        id="cartModal"
        tabindex="-1"
        data-bs-backdrop="false"
        style="position: absolute"
      >
        <div class="modal-dialog">
          <div
            class="modal-content"
            style="background: var(--card-bg); color: var(--text-main)"
          >
            <div
              class="modal-header"
              style="border-bottom-color: var(--border-color)"
            >
              <h5 class="modal-title fw-bold">カート</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
              ></button>
            </div>
            <div class="modal-body p-3" style="background: var(--bg-color)">
              <div id="cart-list"></div>
              <div class="cart-total-row mt-4 px-2">
                <span class="cart-total-label">合計金額</span>
                <span class="cart-total-value" id="cart-total-modal">¥0</span>
              </div>
            </div>
            <div
              class="modal-footer d-block border-top-0 p-3 pt-0"
              style="
                background: var(--bg-color);
                padding-bottom: 120px !important;
              "
            >
              <button
                class="btn-primary-custom"
                style="background: var(--brand-color); margin-bottom: 10px"
                onclick="checkout()"
              >
                レジにすすむ <i class="bi bi-chevron-right ms-1"></i>
              </button>
              <button
                class="btn w-100 small"
                style="font-size: 0.9rem; color: var(--text-sub)"
                onclick="clearCart()"
              >
                カートを空にする
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- End App Container -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
      /* 1. Firebase Imports */
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
      import {
        getAuth,
        GoogleAuthProvider,
        signInWithPopup,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
      import {
        getFirestore,
        collection,
        getDocs,
        doc,
        getDoc,
        setDoc,
        serverTimestamp,
        writeBatch,
        query,
        where,
      } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
      import {
        getMessaging,
        getToken,
      } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-messaging.js";
      import {
        getStorage,
        ref as sRef,
        getDownloadURL,
      } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-storage.js";
      import {
        getFunctions,
        httpsCallable,
      } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-functions.js";
      import {
        initializeAppCheck,
        ReCaptchaEnterpriseProvider,
      } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app-check.js";

      /* 2. Configuration */
      const firebaseConfig = {
        apiKey: "AIzaSyA-Ijkbo-9rgrNKbDlRJ-rQVYdSXR_a9Do",
        authDomain: "nanryosai-2026-a4091.firebaseapp.com",
        projectId: "nanryosai-2026-a4091",
        storageBucket: "nanryosai-2026-a4091.firebasestorage.app",
        messagingSenderId: "93228414556",
        appId: "1:93228414556:web:f64f90c13849fae9049899",
      };
      const VAPID_KEY =
        "BI-HfOk34KQVIoJK_8KnKplz3l31I9VLWOJKF7mHBARF-XmgVjpRSyVoSfSnoVZDS7orz-OO8yq-S32STZU30Po";

      // Initialize Services
      const app = initializeApp(firebaseConfig);

      // App Check (Localhost Debug)
      if (
        location.hostname === "localhost" ||
        location.hostname === "127.0.0.1"
      ) {
        // 'true' に設定すると、ブラウザごとに一意のデバッグトークンが生成され、コンソールに出力されます。
        // これにより、他の開発者がコードをプルしても、各自の環境で個別に Firebase にトークンを登録して開発を継続できます。
        self.FIREBASE_APPCHECK_DEBUG_TOKEN = true;
      }
      const appCheck = initializeAppCheck(app, {
        provider: new ReCaptchaEnterpriseProvider(
          "6LdVI4sqAAAAABsFgjK80A2MAiCg7X9K7uJ-gYQ6",
        ),
        isTokenAutoRefreshEnabled: true,
      });

      const auth = getAuth(app);
      const db = getFirestore(app);
      const messaging = getMessaging(app);
      const storage = getStorage(app);
      const functions = getFunctions(app, "asia-northeast1");

      /* 3. Global State */
      let currentUser = null;
      let currentStoreId = null;
      let products = [];
      let cart = [];

      // Modal State
      let selectingProduct = null;
      let selectingQty = 1;
      let currentMode = null;
      let currentMods = [];

      // Bootstrap Modals
      let itemModal, cartModal;

      // DOM Elements
      const loader = document.getElementById("global-loader");

      /* 4. Core Lifecycle & Auth */
      function init() {
        onAuthStateChanged(auth, (user) => {
          currentUser = user;
          if (user) {
            checkFlow();
          } else {
            showScreen("step-login");
            loader.style.display = "none";
          }
        });
      }

      async function checkFlow() {
        // iOS Detection: iPhone/iPod or iPad, and also Skip Mac (Macintosh)
        const isIOS =
          /iPhone|iPad|iPod/i.test(navigator.userAgent) ||
          /Macintosh/i.test(navigator.userAgent);

        // Initial status save
        // If iOS/Mac, notificationEnabled is FALSE.
        // If Android/PC, depends on current permission (only 'granted' is true).
        const currentPerm = !isIOS ? Notification.permission : "unsupported";
        await updateUserProfile({
          deviceType: isIOS ? "ios_or_mac" : "other",
          notificationEnabled: currentPerm === "granted",
          permissionStatus: currentPerm,
        });

        // Notification Check: Skip if iOS or already decided
        if (!isIOS && Notification.permission === "default") {
          showScreen("step-notification");
        } else {
          // Grant or Deny or iOS -> Terms
          if (!isIOS && Notification.permission === "granted")
            await saveToken();
          showScreen("step-terms");
        }
        loader.style.display = "none";
      }

      // Handlers
      document.getElementById("btn-login").onclick = async () => {
        const btn = document.getElementById("btn-login");

        // 1. In-App Browser Check
        const ua = navigator.userAgent || navigator.vendor || window.opera;
        const isInApp =
          ua.indexOf("FBAN") > -1 ||
          ua.indexOf("FBAV") > -1 ||
          ua.indexOf("Instagram") > -1 ||
          ua.indexOf("Line") > -1;
        if (isInApp) {
          alert(
            "⚠️ 注意: アプリ内ブラウザではログインが正常に動作しない場合があります。\n\nもしログインできない場合は、右上のメニューから「ブラウザで開く」を選択してください。",
          );
        }

        // 2. UI Feedback
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML =
          '<span class="spinner-border spinner-border-sm me-2"></span> 処理中...';

        try {
          const provider = new GoogleAuthProvider();
          // Force account selection to avoid "auto-login loop" issues and "blank popup" confusion
          provider.setCustomParameters({
            prompt: "select_account",
          });

          const result = await signInWithPopup(auth, provider);

          // Explicitly trigger UI update to prevent "Reload required" issues
          currentUser = result.user;
          await checkFlow();
        } catch (e) {
          console.error(e);
          if (e.code === "auth/popup-blocked") {
            alert(
              "ポップアップがブロックされました。\nブラウザの設定でポップアップを許可するか、外部ブラウザで開いてください。",
            );
          } else if (
            e.code === "auth/cancelled-popup-request" ||
            e.code === "auth/popup-closed-by-user"
          ) {
            // User closed it intentionally, do nothing or show subtle toast
            console.log("Login cancelled by user");
          } else {
            alert("ログインエラー: " + e.message);
          }

          // Reset Button only on error
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      };

      document.getElementById("btn-req-notification").onclick = async () => {
        try {
          const p = await Notification.requestPermission();
          if (p === "granted") {
            await saveToken(); // This sets notificationEnabled: true
          } else {
            // Denied or dismissed
            await updateUserProfile({
              notificationEnabled: false,
              permissionStatus: p,
            });
          }
        } catch (e) {
          console.warn(e);
        }
        showScreen("step-terms");
      };

      window.skipNotification = async () => {
        await updateUserProfile({
          notificationEnabled: false,
          permissionStatus: "skipped",
        });
        showScreen("step-terms");
      };

      document.getElementById("check-terms").onchange = (e) => {
        document.getElementById("btn-agree-terms").disabled = !e.target.checked;
      };

      document.getElementById("btn-agree-terms").onclick = async () => {
        loader.style.display = "flex";
        await loadStores();
        if (!currentStoreId) {
          showScreen("step-stores");
        }
        loader.style.display = "none";
      };

      async function updateUserProfile(additionalData = {}) {
        if (!currentUser) return;
        try {
          const baseData = {
            email: currentUser.email,
            displayName: currentUser.displayName,
            lastLogin: serverTimestamp(),
            ...additionalData,
          };
          await setDoc(doc(db, "users", currentUser.uid), baseData, {
            merge: true,
          });
        } catch (e) {
          console.error("User save failed", e);
        }
      }

      async function saveToken() {
        try {
          const swReg = await navigator.serviceWorker.register(
            "./firebase-messaging-sw.js",
          );
          const token = await getToken(messaging, {
            vapidKey: VAPID_KEY,
            serviceWorkerRegistration: swReg,
          });
          if (token && currentUser) {
            await setDoc(
              doc(db, "users", currentUser.uid),
              {
                fcmToken: token,
                notificationEnabled: true,
                lastLogin: serverTimestamp(),
                permissionStatus: "granted",
              },
              { merge: true },
            );
          }
        } catch (e) {
          console.warn("Token save failed", e);
        }
      }

      /* 5. Feature: Stores */
      async function loadStores() {
        const list = document.getElementById("store-list");
        list.innerHTML = "";
        try {
          const snap = await getDocs(collection(db, "stores"));
          if (snap.empty) {
            list.innerHTML = "<p>店舗が見つかりません</p>";
            return;
          }

          const urlParams = new URLSearchParams(window.location.search);
          const targetStoreId = urlParams.get("store");
          let targetStoreName = null;

          snap.forEach((d) => {
            const data = d.data();
            // Check for auto-select
            if (d.id === targetStoreId) {
              targetStoreName = data.name;
            }

            const imgSrc = `../images/${d.id}.png`;
            const el = document.createElement("div");
            el.className = "store-card animate__animated animate__fadeInUp";
            el.innerHTML = `
              <img src="${imgSrc}" class="store-img" onerror="this.onerror=null;this.src='../images/noimage.png'">
              <div class="store-info">
                 <h3>${data.name}</h3>
                 <small style="color: var(--text-sub);">${data.teamName || ""}</small>
              </div>
            `;
            el.onclick = () => selectStore(d.id, data.name);
            list.appendChild(el);
          });

          // Auto Redirect if matched
          if (targetStoreId && targetStoreName) {
            selectStore(targetStoreId, targetStoreName);
          }
        } catch (e) {
          list.innerHTML = `<p class="text-danger">読み込み失敗: ${e.message}</p>`;
        }
      }

      window.selectStore = (storeId, storeName) => {
        currentStoreId = storeId;
        document.getElementById("menu-store-name").textContent = storeName;
        showScreen("step-menu");
        loadMenu(storeId);
      };

      window.backToStores = () => {
        currentStoreId = null;
        showScreen("step-stores");
        document.getElementById("bottom-bar").style.display = "none";
      };

      /* 6. Feature: Menu & Logic */
      window.loadMenu = async (storeId) => {
        const grid = document.getElementById("menu-grid");
        grid.innerHTML = `
          <div style="grid-column: 1 / -1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px; gap: 20px;">
            <div class="premium-loader"></div>
            <div class="loader-text">Loading Menu...</div>
          </div>
        `;
        products = [];
        initLazyLoader();

        try {
          const q = query(
            collection(db, "items"),
            where("storeId", "==", storeId),
          );
          const snap = await getDocs(q);
          grid.innerHTML = "";

          snap.forEach((d) => {
            const p = d.data();
            p.id = d.id;
            products.push(p);

            const isSoldOut = p.isAvailable === false;
            const el = document.createElement("div");
            el.className = "menu-card animate__animated animate__fadeIn";
            if (isSoldOut) el.style.opacity = "0.7";

            el.innerHTML = `
              <div class="menu-img-box" style="background: var(--bg-color);">
                 ${isSoldOut ? '<div class="sold-out-badge"><span class="sold-out-text">SOLD OUT</span></div>' : ""}
                 <div class="img-loader">
                   <div class="spinner-border text-secondary" role="status" style="width: 2rem; height: 2rem;"></div>
                 </div>
                 <img class="menu-img" id="img-${p.id}">
              </div>
              <div class="menu-info">
                 <div class="fw-bold text-truncate">${p.name}</div>
                 <div class="fw-bold mt-1">¥${p.price}</div>
              </div>
            `;

            const imgEl = el.querySelector(".menu-img");
            lazyLoadImage(imgEl, p);

            el.onclick = () => {
              if (!isSoldOut) openItemModal(p);
            };
            grid.appendChild(el);
          });

          if (products.length === 0) grid.innerHTML = "<p>商品がありません</p>";
          updateBottomBar();
        } catch (e) {
          console.error(e);
          grid.innerHTML = "<p>読み込み失敗</p>";
        }
      };

      /* 7. Feature: Item Details (Modal) */
      window.openItemModal = (product) => {
        selectingProduct = product;
        selectingQty = 1;
        currentMode = null;
        currentMods = [];

        document.getElementById("modal-item-name").textContent = product.name;
        document.getElementById("modal-item-price").textContent =
          `¥${product.price}`;
        document.getElementById("modal-item-qty").textContent = selectingQty;

        const imgEl = document.getElementById("modal-item-img");
        setProductImage(imgEl, product);

        renderCustomizationUI();

        const collapseEl = document.getElementById("customization-collapse");
        if (collapseEl) collapseEl.classList.remove("show");

        if (!itemModal)
          itemModal = new bootstrap.Modal(document.getElementById("itemModal"));
        itemModal.show();
      };

      function renderCustomizationUI() {
        const area = document.getElementById("customization-area");
        const list = document.getElementById("topping-list");
        const allowed = selectingProduct.allowedToppings || [];

        if (allowed.length === 0) {
          area.style.display = "none";
        } else {
          area.style.display = "block";
          list.innerHTML = "";
          allowed.forEach((t) => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "topping-btn";
            btn.dataset.target = t;
            btn.textContent = t;
            btn.onclick = () => toggleMod(t);
            list.appendChild(btn);
          });
          updateModeBtns();
          renderActiveMods();
          updateToppingBtnStyles();
        }
        document.getElementById("active-mods-display").style.display = "none";
      }

      window.setMode = (mode) => {
        currentMode = currentMode === mode ? null : mode;
        updateModeBtns();
      };

      function updateModeBtns() {
        document.querySelectorAll(".mode-btn").forEach((btn) => {
          if (btn.dataset.mode === currentMode) btn.classList.add("active");
          else btn.classList.remove("active");
        });
      }

      function updateToppingBtnStyles() {
        document
          .querySelectorAll("#topping-list .topping-btn")
          .forEach((btn) => {
            const target = btn.dataset.target;
            const mod = currentMods.find((m) => m.target === target);
            btn.classList.remove("mod-selected-no", "mod-selected-add");
            if (mod) {
              if (mod.mode === "NO") btn.classList.add("mod-selected-no");
              if (mod.mode === "ADD") btn.classList.add("mod-selected-add");
            }
          });
      }

      function toggleMod(target) {
        if (!currentMode) {
          const modeContainer = document.querySelector(".mode-toggle");
          modeContainer.classList.remove(
            "animate__animated",
            "animate__headShake",
          );
          void modeContainer.offsetWidth; // Reflow
          modeContainer.classList.add(
            "animate__animated",
            "animate__headShake",
          );
          return;
        }
        const existingIdx = currentMods.findIndex((m) => m.target === target);
        if (existingIdx >= 0) {
          const existing = currentMods[existingIdx];
          if (existing.mode === currentMode) currentMods.splice(existingIdx, 1);
          else existing.mode = currentMode;
        } else {
          currentMods.push({ mode: currentMode, target: target });
        }
        renderActiveMods();
        updateToppingBtnStyles();
      }

      function renderActiveMods() {
        const div = document.getElementById("active-mods-list");
        div.innerHTML = "";
        currentMods.forEach((m) => {
          const span = document.createElement("span");
          span.className = `mod-tag ${m.mode.toLowerCase()}`;
          const modeText = m.mode === "NO" ? "抜き" : "追加";
          span.textContent = `${m.target} ${modeText}`;
          div.appendChild(span);
        });
        div.parentElement.style.display = currentMods.length ? "block" : "none";
      }

      window.adjustQty = (delta) => {
        selectingQty += delta;
        if (selectingQty < 1) selectingQty = 1;
        document.getElementById("modal-item-qty").textContent = selectingQty;
        document.getElementById("modal-item-price").textContent =
          `¥${selectingProduct.price * selectingQty}`;
      };

      /* 8. Feature: Cart Logic */
      window.commitAddToCart = () => {
        const sortedNewMods = [...currentMods].sort((a, b) =>
          (a.mode + a.target).localeCompare(b.mode + b.target),
        );
        const newModsStr = JSON.stringify(sortedNewMods);

        const existing = cart.find((c) => {
          if (c.productId !== selectingProduct.id) return false;
          const cMods = [...c.customizations].sort((a, b) =>
            (a.mode + a.target).localeCompare(b.mode + b.target),
          );
          return JSON.stringify(cMods) === newModsStr;
        });

        if (existing) {
          existing.quantity += selectingQty;
        } else {
          cart.push({
            uniqueId: Date.now() + Math.random(),
            productId: selectingProduct.id,
            name: selectingProduct.name,
            price: selectingProduct.price,
            quantity: selectingQty,
            customizations: sortedNewMods,
            allowedToppings: selectingProduct.allowedToppings || [],
          });
        }
        updateBottomBar();
        itemModal.hide();
      };

      window.openCart = () => {
        renderCartList();
        if (!cartModal)
          cartModal = new bootstrap.Modal(document.getElementById("cartModal"));
        cartModal.show();
      };

      function renderCartList() {
        const list = document.getElementById("cart-list");
        list.innerHTML = "";
        let total = 0;
        cart.forEach((c, idx) => {
          total += c.price * c.quantity;
          const el = document.createElement("div");
          el.className = "cart-item animate__animated animate__fadeInUp";
          el.style.animationDelay = `${idx * 0.05}s`;

          let modsHtml = c.customizations
            .map((m) => {
              const modeText = m.mode === "NO" ? "抜き" : "追加";
              return `<span class="badge me-1" style="background: var(--border-color); color: var(--text-sub); font-size:0.75rem; font-weight:normal; opacity:0.8;">${m.target} ${modeText}</span>`;
            })
            .join("");

          el.innerHTML = `
             <div class="cart-item-details">
                <h5>${c.name}</h5>
                <div class="cart-item-price">¥${c.price} x ${c.quantity}</div>
                <div class="cart-item-mods">${modsHtml}</div>
             </div>
             <button class="cart-del-btn" onclick="removeFromCart(${idx})"><i class="bi bi-trash"></i></button>
          `;
          list.appendChild(el);
        });
        document.getElementById("cart-total-modal").textContent = `¥${total}`;
        if (cart.length === 0)
          list.innerHTML =
            "<p class='p-4 text-center text-muted'>カートは空です</p>";
      }

      window.removeFromCart = (idx) => {
        cart.splice(idx, 1);
        renderCartList();
        updateBottomBar();
        if (cart.length === 0) cartModal.hide();
      };

      window.clearCart = () => {
        if (confirm("本当に削除しますか？")) {
          cart = [];
          renderCartList();
          updateBottomBar();
          cartModal.hide();
        }
      };

      /* 9. Feature: Checkout */
      window.backToMenu = () => {
        showScreen("step-menu");
        updateBottomBar();
      };

      window.checkout = () => {
        if (cartModal) cartModal.hide();

        document.getElementById("checkout-store-name").textContent =
          document.getElementById("menu-store-name").textContent;
        const list = document.getElementById("checkout-items-list");
        list.innerHTML = "";
        let total = 0;

        cart.forEach((c) => {
          total += c.price * c.quantity;
          let modsHtml = c.customizations
            .map((m) => {
              const colorClass =
                m.mode === "NO"
                  ? "text-danger border-danger"
                  : "text-success border-success";
              const modeText = m.mode === "NO" ? "抜き" : "追加";
              return `<span class="badge border ${colorClass} me-1 mb-1" style="background: var(--bg-color); font-size:0.8rem">${m.target} ${modeText}</span>`;
            })
            .join("");

          const div = document.createElement("div");
          div.className =
            "list-group-item p-3 border-0 border-bottom d-flex justify-content-between align-items-start";
          div.style.background = "var(--card-bg)";
          div.style.color = "var(--text-main)";
          div.style.borderColor = "var(--border-color)";
          div.innerHTML = `
            <div class="me-3" style="flex: 1;">
              <div class="fw-bold mb-2" style="font-size: 1.15rem;">${c.name}</div>
              <div class="mb-2 d-flex flex-wrap">${modsHtml || '<span class="text-muted small">変更なし</span>'}</div>
              <div class="small d-flex align-items-center" style="color: var(--text-sub);">
                <span class="me-2">¥${c.price}</span>
                <span class="badge border" style="background: var(--bg-color); color: var(--text-main); border-color: var(--border-color) !important;">x${c.quantity}</span>
              </div>
            </div>
            <div class="fw-bold fs-5 text-nowrap mt-1">¥${c.price * c.quantity}</div>
          `;
          list.appendChild(div);
        });

        document.getElementById("checkout-total").textContent = `¥${total}`;
        document.getElementById("bottom-bar").style.display = "none";
        showScreen("step-checkout");
      };

      window.finalizeOrder = async () => {
        if (!confirm("本当に注文を確定してよろしいですか？")) return;
        loader.style.display = "flex";
        try {
          const cartRef = collection(db, `users/${currentUser.uid}/cart`);
          const batch = writeBatch(db);
          const oldSnap = await getDocs(cartRef);
          oldSnap.forEach((d) => batch.delete(d.ref));

          cart.forEach((c) => {
            batch.set(doc(cartRef), {
              productId: c.productId,
              quantity: c.quantity,
              customizations: c.customizations,
              updatedAt: serverTimestamp(),
            });
          });
          await batch.commit();

          const createOnlineOrder = httpsCallable(
            functions,
            "createOnlineOrder",
          );
          const result = await createOnlineOrder({ storeId: currentStoreId });
          if (!result.data.success)
            throw new Error(result.data.error || "Order Failed");

          window.location.href = `status.html?orderId=${result.data.orderId}`;
        } catch (e) {
          console.error(e);
          alert("注文処理に失敗しました: " + e.message);
          loader.style.display = "none";
        }
      };

      /* 10. Utils & Helpers */
      function showScreen(id) {
        document
          .querySelectorAll(".screen")
          .forEach((el) => el.classList.remove("active"));
        document.getElementById(id).classList.add("active");
        const bar = document.getElementById("bottom-bar");
        if (id !== "step-menu") bar.style.display = "none";
        window.scrollTo(0, 0);
      }

      function updateBottomBar() {
        const bar = document.getElementById("bottom-bar");
        const activeScreen = document.querySelector(".screen.active");
        if (
          !activeScreen ||
          activeScreen.id !== "step-menu" ||
          cart.length === 0
        ) {
          bar.style.display = "none";
        } else {
          bar.style.display = "flex";
          let total = 0;
          let count = 0;
          cart.forEach((c) => {
            total += c.price * c.quantity;
            count += c.quantity;
          });
          document.getElementById("bar-total").textContent = `¥${total}`;
          const badge = document.getElementById("bar-count-badge");
          if (badge) badge.textContent = count;
        }
      }

      // Scaling
      function adjustScale() {
        const app = document.getElementById("app-container");
        const isMobile = window.innerWidth <= 480;

        if (isMobile) {
          // Mobile: Standard flow, fill parent flex space
          app.style.height = "100%";
          app.style.flex = "1";
          app.style.transform = "none";
          app.style.zoom = "1";
          app.style.marginTop = "0";
        } else {
          // PC/Tablet: Simulating a phone device
          // Force the container to "Fit" strictly BETWEEN header and the Bottom Nav (Order Button)

          // 1. Define the usable height ABOVE the bottom nav
          // Window Height - (Header ~60px) - (Bottom Nav ~90px) - (Margins ~30px)
          const availableHeight = window.innerHeight - 180;

          // 2. Define standard Phone Aspect Ratio Height
          // Reverted to 840 to fit more vertical content (preventing customization button cut-off)
          const baseHeight = 840;

          let scale = Math.min(1, availableHeight / baseHeight);

          // Fix dimensions to the base phone size, then scale it
          app.style.flex = "none";
          app.style.height = `${baseHeight}px`;
          // max-width is handled by CSS (500px)

          app.style.transform = `scale(${scale})`;
          app.style.transformOrigin = "top center";

          // Adjust zoom to reset if mixed
          app.style.zoom = "1";
        }
      }
      window.addEventListener("resize", adjustScale);
      window.addEventListener("load", adjustScale);

      // Image Handling
      let imageObserver;
      function initLazyLoader() {
        if ("IntersectionObserver" in window) {
          imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                const imgEl = entry.target;
                const product = JSON.parse(imgEl.dataset.product);
                setProductImage(imgEl, product);
                observer.unobserve(imgEl);
              }
            });
          });
        }
      }

      function lazyLoadImage(imgEl, product) {
        if (imageObserver) {
          imgEl.dataset.product = JSON.stringify(product);
          imageObserver.observe(imgEl);
        } else {
          setProductImage(imgEl, product);
        }
      }

      async function setProductImage(imgEl, product) {
        imgEl.classList.remove("loaded");
        const loader = imgEl.parentElement.querySelector(".img-loader");
        if (loader) loader.style.display = "block";

        imgEl.onload = () => {
          imgEl.classList.add("loaded");
          if (loader) loader.style.display = "none";
        };

        const pathOrUrl = product.imageURL || product.imageUrl;
        if (!pathOrUrl) {
          imgEl.src = "../images/noimage.png";
          return;
        }

        const CACHE_KEY = `img_cache_${pathOrUrl}`;
        const cachedUrl = sessionStorage.getItem(CACHE_KEY);
        if (cachedUrl) {
          imgEl.src = cachedUrl;
          return;
        }

        if (pathOrUrl.startsWith("http") || pathOrUrl.startsWith("data:")) {
          imgEl.src = pathOrUrl;
        } else {
          try {
            const url = await getDownloadURL(sRef(storage, pathOrUrl));
            imgEl.src = url;
            try {
              sessionStorage.setItem(CACHE_KEY, url);
            } catch (e) {}
          } catch (e) {
            console.warn("Storage image load failed:", pathOrUrl, e);
            imgEl.src = "../images/noimage.png";
          }
        }
        imgEl.onerror = () => {
          imgEl.src = "../images/noimage.png";
          imgEl.classList.add("loaded");
          if (loader) loader.style.display = "none";
        };
      }

      init();
    </script>
    <script>
      window.CURRENT_PAGE = "order";
    </script>
    <script type="module" src="../main/app-shell.js"></script>
  </body>
</html>
