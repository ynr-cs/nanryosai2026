# Mobile Order & Status 開発コンテキスト

本ドキュメントは、モバイルオーダー機能 (`mobile-order.html`) および 注文ステータス確認機能 (`status.html`) の開発ガイドラインです。

## 1. モバイルオーダー (`mobile-order.html`) フロー定義

**基本方針**: ユーザーはまず認証を行い、規約に同意した上で店舗・商品を選択する。アプリらしいリッチな体験（SPA 的挙動）を提供する。

### 1.1 順序フロー

1.  **Loading (Initial)**
    - **挙動**: アプリ起動時、中央にスピナーを表示し、認証状態を確認するまで画面を隠す。

2.  **Google ログイン (Login First)**
    - **理由**: Firestore セキュリティルールの観点から、商品データや店舗データへのアクセスには認証が必須であるため。
    - **挙動**: 未ログインであればログイン画面を表示。ログイン完了後に次へ進む。

3.  **通知許可 (Notification)**
    - **目的**: 調理完了時の呼び出し通知用。
    - **挙動**: 許可のメリット（調理完了通知）を説明する専用画面を挟み、ボタン押下でブラウザのダイアログを表示。
    - **データ**: 許可された場合、FCM トークンを `users/{uid}` に保存。

4.  **規約同意 (Terms of Service) [重要]**
    - **表示内容**: 以下の規約を **大きく** 表示し、同意チェックボックスのチェックを必須とする。
      1.  **注文確定後のキャンセル不可**
      2.  **受け取りは呼び出し後 15 分以内**（経過後は即廃棄）
      3.  **違反時のペナルティ**: 料金徴収の上、今後コンピュータ科学部制作サービスからアカウント永久 BAN
    - **挙動**: チェックを入れるまでボタンが有効化されない。

5.  **店舗選択 (Store Select)**
    - カード型リストで店舗を表示。店舗選択でその店舗のメニュー画面へ。

6.  **メニュー画面 (Menu Grid)**
    - **UI**: 商品画像をメインにした 2 列グリッド表示。
    - **UX**:
      - **Lazy Loading**: `IntersectionObserver` を用いた画像の遅延読み込み。
      - **Skeleton/Spinner**: 画像読み込み中は回転するスピナーを表示し、読み込み完了後にフワッと表示 (Fade-in)。
    - **在庫**: 在庫切れ商品は選択不可かつ「SOLD OUT」バッジ表示。

7.  **商品詳細・カスタマイズ (Item Detail Modal)**
    - **UI**: モバイルアプリのようなフルスクリーンモーダル（下からスライドイン）。
    - **画像表示**: ここでもスピナーによるローディング表示を実装。「画像はイメージです」の注釈。
    - **カスタマイズ**:
      - 「抜き」「追加」のモード選択式 UI。
      - 選択したオプションは色分けされたタグ (`currentMods`) として可視化。
    - **アクション**: 「カートに追加」でメニュー画面に戻る。

8.  **カート (Bottom Cart Bar)**
    - **UI**: 画面下部に**浮遊するカプセル型のバー**（メニュー画面でのみ表示）。
    - **表示**: カートアイコン（バッジ付き）、合計金額、レジへ進むボタン。
    - **アクション**:
      - バー全体タップ: カート詳細モーダル（削減・削除）を表示。
      - 「レジへ」ボタン: 注文確認画面へ直行。

9.  **注文確認 (Checkout Screen)**
    - **表示**: 受け取り店舗名、注文商品リスト（オプション詳細含む）、合計金額。
    - **最終確認**: 「注文を確定する」押下時にブラウザ標準アラート (`confirm`) を実施。
    - **完了**: 処理成功時に `status.html?orderId={...}` へリダイレクト。

---

## 2. 実装詳細要件

### 2.1 データ構造 (Customization)

`pos.html` の仕様に準拠する。

```javascript
// Cart Item Structure
{
  uniqueId: "timestamp_random",
  productId: "item_id",
  name: "商品名",
  price: 100,
  quantity: 1,
  // カスタマイズ配列
  customizations: [
     { mode: "NO", target: "ケチャップ" },
     { mode: "ADD", target: "ピクルス" }
  ]
}
```

### 2.2 デザインシステム

- **テーマカラー**: Premium Black (`#1a1a1a`), Vibrant Red (`#e53935`), Warm Orange (`#ff9800`)。
- **コンポーネント**: Bootstrap 5 をベースに、角丸 (`border-radius: 16px+`) や 影 (`box-shadow`) を多用したモダンデザイン。

---

## 3. 注文ステータス確認 (`status.html`)

- **役割**: 調理状況のリアルタイム確認。
- **機能**:
  - Firestore `onSnapshot` によるリアルタイム更新。
  - ステータス可視化 (Waiting -> Cooking -> Ready -> Completed)。
  - 呼出番号 (Receipt Number) の表示。

---

## 4. 最新の開発履歴 (2025-12-30 更新)

### 4.1 UI/UX の大幅改善 (完成)

- **商品詳細モーダルの UX 向上**: 画像ローディング時のスピナー表示とフェードインアニメーションを追加し、体感速度を向上。
- **ボトムバーの最終デザイン**: 画面一杯の固定バーから、**浮遊感のあるカプセル型デザイン**に刷新。直感的で「今風」な見た目を実現。
- **全体的なアニメーション**: 画面遷移 (`fadeIn`) やリスト表示 (`fadeInUp`) に軽快なアニメーションを適用。

### 4.2 コードベースのリファクタリング

`mobile-order.html` は単一ファイル構成を維持しつつ、保守性を高めるために以下の構造に再整理されました。

1.  **CSS セクション**:
    - **Variables**: 色やサイズを変数化。
    - **Base/Layout**: アプリコンテナ、スクリーン管理。
    - **Components**: ボタン、カード、バッジ等の共通パーツ。
    - **Pages**: 各画面固有のスタイル。
2.  **HTML セクション**:
    - `div#app-container` 内に各画面 (`div.screen`) を配置し、JS で `active` クラスを切り替える SPA 構成。
    - モーダルはコンテナ外（または末尾）に配置。
3.  **JS セクション**:
    - **Imports**: Firebase SDK 等。
    - **State**: `currentUser`, `cart`, `products` 等の管理。
    - **Flow Control**: ログイン -> 通知 -> 規約 -> 店舗選択 のフロー制御。
    - **Features**: `Stores`, `Menu (Grid)`, `Item Detail`, `Cart`, `Checkout` ご実に関数をグループ化。

### 4.3 堅牢性の確保

- **バリデーション**: カート投入時や注文確定前のチェックロジックを実装。
- **エラーハンドリング**: 画像読み込み失敗時のフォールバック、通信エラー時のアラート表示。

### 4.4 認証・動作環境への対応 (2026-01-10 更新)

- **認証における UX 改善**:
  - アプリ内ブラウザ (LINE/Instagram) での起動時に警告アラートを表示。
  - GitHub Pages 環境を考慮し、認証方式を `signInWithPopup` に統一。
  - ログイン画面に「推奨ブラウザ (Chrome)」および「不具合報告フォーム」への案内を追加し、問い合わせ負荷を軽減。

---

## 5. 今後のタスク (Next Steps)

1.  **実機テスト**: iOS/Android 実機、特に「戻る」操作やキーボード表示時の挙動確認。
2.  **`status.html` 結合テスト**: 注文完了後のリダイレクトとステータス表示の連動確認。
3.  **本番データ投入**: メニュー画像や店舗データの整備。

### 4.5 ストア自動選択機能 (2026-02-02 更新)

- **概要**: URLパラメータ `?store={storeId}` を指定することで、特定の店舗のメニュー画面を直接開くことが可能になりました。
- **フローへの影響**:
  - ログイン・規約同意フローは通常通り維持されます。
  - 規約同意後の遷移先が、通常は「店舗選択画面」ですが、パラメータ指定時は「該当店舗のメニュー画面」に自動遷移（店舗選択画面がスキップ）されます。
- **実装詳細**:
  - `loadStores()` 内でパラメータ解析と自動選択を実行。
  - 同意ボタン (`btn-agree-terms`) のハンドラで `currentStoreId` の有無を確認し、画面遷移先を制御。
