# マップ機能 (MapLibre GL JS) 実装コンテキスト

## 1. 概要

ユーザーからの「Mapplicのようなリッチな3Dマップが欲しい」という要望に基づき、MapLibre GL JSを採用したインタラクティブな校内マップ機能を実装する。
以前の「平面図（黒い線画）」が見づらいという課題を解決し、スマホでも軽快に動作する3D表現を目指す。

## 2. 技術スタック

- **ライブラリ**: `maplibre-gl-js` (v3.x)
- **データ形式**: GeoJSON (Polygon / Point)
- **表示方式**:
  - **背景**: 昨年のマップ画像 (`map-1f.png` 等) を `image` ソースとして配置。
  - **建物**: GeoJSONのポリゴンデータを `fill-extrusion` レイヤーで高さをつけて表示。
  - **ピン**: 企画データ (`data.js`) に基づくHTMLマーカー、またはSymbolレイヤー。

## 3. ディレクトリ構造

```
main/
├── map.html               # マップ表示用メインページ
├── map_admin/
│   └── editor.html        # [開発用] 地図データ作成ツール
├── assets/
│   ├── css/
│   │   └── map_style.css  # マップ専用スタイル
│   ├── js/
│   │   └── map_logic.js   # マップ制御ロジック
│   └── images/
│       └── map/           # マップ画像 (map-1f.png 等)
└── data/
    └── geojson/           # [予定] 作成された地図データ
        ├── floor_1.geojson
        └── ...
```

## 4. データ作成フロー (Map Editor)

GeoJSONの手書きは困難であるため、専用ツール (`main/map_admin/editor.html`) を使用する。

1. **ツールの起動**: ブラウザで `editor.html` を開く。
2. **描画**: マップ画像を背景に、Mapbox GL Draw 機能を使って部屋の形（ポリゴン）をトレースする。
3. **属性設定**: 各ポリゴンに以下のプロパティを設定する。
   - `name`: 部屋名 (例: "3年1組")
   - `category`: 色分け用カテゴリ (`class`, `food`, `stage` 等)
   - `height`: 3D表示時の高さ (0-100)
4. **エクスポート**: 「GeoJSONをダウンロード」ボタンで `.geojson` ファイルとして保存。
5. **配置**: 保存したファイルを `main/data/geojson/` に配置し、本番マップ (`map.html`) から読み込む。

## 5. 今後の課題・拡張予定

- [ ] **頂点スナップ機能**: エディタでの描画時に、隣接する部屋の頂点にスナップさせる機能の実装（隙間防止）。
- [ ] **スマホ最適化**: インタラクション（タップ、ピンチズーム）の感度調整。
- [ ] **スタイル調整**: `fill-extrusion-color` をカテゴリごとに最適化し、見やすい配色にする。

## 6. 関連ファイル

- `main/map_admin/editor.html`: データ作成ツール
- `main/map.html`: 実際の表示ページ (統合予定)
