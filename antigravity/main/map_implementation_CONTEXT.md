# 🗺️ マップ機能 総合開発ドキュメント

> このドキュメントは3Dキャンパスマップ開発の全体像を記録する永続ドキュメントです。
> 新しい会話を始める際は、まずこのファイルを参照してください。

---

## 📌 プロジェクト概要

**目標**: 横浜南陵高校の文化祭（南陵祭'26）用の3Dインタラクティブキャンパスマップを開発する。

**開発期間**: 9ヶ月（2026年文化祭まで）

**背景**:

- 昨年のマップ（Leaflet.js + 平面図）が「見づらい」「重なりがわかりにくい」と不評
- ユーザーから「Mapplic」のようなリッチな3D表現が欲しいとの要望
- testmap2.htmlの高品質な3Dモール実装を見て、これをベースに開発することを決定

---

## 📁 関連ファイル一覧

### 本番ファイル

| ファイル                                                                                                                                             | 説明                      | 状態        |
| ---------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------- | ----------- |
| [main/map3d.html](file:///c:/Users/uokun/OneDrive/Desktop/%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/ynr-cs/nanryosai-2026/nanryosai-2026/main/map3d.html) | **本番3Dマップ**          | ✅ 作成済み |
| [main/map.html](file:///c:/Users/uokun/OneDrive/Desktop/%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/ynr-cs/nanryosai-2026/nanryosai-2026/main/map.html)     | 旧2D/3Dハイブリッドマップ | 📦 参考用   |

### データファイル

| ファイル                                                                                                                                                         | 説明                           |
| ---------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------ |
| [main/data/data.js](file:///c:/Users/uokun/OneDrive/Desktop/%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/ynr-cs/nanryosai-2026/nanryosai-2026/main/data/data.js)         | 今年度の企画データ（作成予定） |
| [main/lastyear/data.js](file:///c:/Users/uokun/OneDrive/Desktop/%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/ynr-cs/nanryosai-2026/nanryosai-2026/main/lastyear/data.js) | 昨年度の企画データ（参照用）   |

### 画像ファイル

| ファイル                                                                                                                                                                                 | 説明        |
| ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------- |
| [main/assets/images/map/map-1f.png](file:///c:/Users/uokun/OneDrive/Desktop/%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/ynr-cs/nanryosai-2026/nanryosai-2026/main/assets/images/map/map-1f.png) | 1階フロア図 |
| [main/assets/images/map/map-2f.png](file:///c:/Users/uokun/OneDrive/Desktop/%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/ynr-cs/nanryosai-2026/nanryosai-2026/main/assets/images/map/map-2f.png) | 2階フロア図 |
| [main/assets/images/map/map-3f.png](file:///c:/Users/uokun/OneDrive/Desktop/%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/ynr-cs/nanryosai-2026/nanryosai-2026/main/assets/images/map/map-3f.png) | 3階フロア図 |
| [main/assets/images/map/map-4f.png](file:///c:/Users/uokun/OneDrive/Desktop/%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/ynr-cs/nanryosai-2026/nanryosai-2026/main/assets/images/map/map-4f.png) | 4階フロア図 |
| [main/assets/images/map/map-5f.png](file:///c:/Users/uokun/OneDrive/Desktop/%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/ynr-cs/nanryosai-2026/nanryosai-2026/main/assets/images/map/map-5f.png) | 5階フロア図 |

### 実験・参考ファイル

| ファイル                                                                                                                                                                         | 説明                           | 技術       |
| -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------ | ---------- |
| [map-experiments/testmap2.html](file:///c:/Users/uokun/OneDrive/Desktop/%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/ynr-cs/nanryosai-2026/nanryosai-2026/map-experiments/testmap2.html) | **ベースにした高品質3Dマップ** | Three.js   |
| [map-experiments/testmap1.html](file:///c:/Users/uokun/OneDrive/Desktop/%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/ynr-cs/nanryosai-2026/nanryosai-2026/map-experiments/testmap1.html) | AI Concierge付き3Dマップ       | Three.js   |
| [main/lastyear/map.htm](file:///c:/Users/uokun/OneDrive/Desktop/%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/ynr-cs/nanryosai-2026/nanryosai-2026/main/lastyear/map.htm)                 | 昨年のマップ実装               | Leaflet.js |

---

## 🏫 学校レイアウト情報

### 建物構成

| 建物       | 階数 | 用途                     |
| ---------- | ---- | ------------------------ |
| 生徒棟     | 5F   | 教室（1〜3年）、特別教室 |
| 体育館     | 1F   | ステージ発表メイン会場   |
| 職員室棟   | 2F   | 職員室、文化祭本部       |
| 武道場     | 1F   | 柔道場・剣道場           |
| 健康福祉棟 | 1F   | 保健室など               |
| 校庭       | -    | 3年生の模擬店テント      |

### 配置図（ユーザー提供）

ユーザーがGoogle Mapsから建物の形をトレースして提供。

```
                    ┌─────────────┐
                    │   校庭      │  (右上/北東)
                    └─────────────┘
        ┌─────────┐
        │ 体育館  │                    (生徒棟の北)
        └─────────┘
    ┌───────────────────────────────┐
    │                               │
    │        生徒棟 (コの字型)       │  (中央)
    │                               │
    └───────────────────────────────┘
      ┌──────┐    ┌──────┐
      │武道場│    │職員室│             (生徒棟の南)
      └──────┘    └──────┘
    ◇ 健康福祉棟                      (最南、斜め)
```

### フロア構成（生徒棟）

| フロア | 内容                                  |
| ------ | ------------------------------------- |
| 5F     | 図書室                                |
| 4F     | 1年生教室（1-1〜1-7）                 |
| 3F     | 2年生教室（2-1〜2-7）、美術室、生物室 |
| 2F     | 部活動展示、茶道部、書道室            |
| 1F     | 昇降口、3年生模擬店（外テント）       |

---

## 📊 データ構造

### 企画データ (data.js)

```javascript
const projectData = [
  {
    id: "1-1",
    name: "1年1組「タケムランド」",
    catchphrase: "人生変えませんか?",
    place: "4階",
    floor: 4,
    mapX: 160, // 画像座標X
    mapY: 833, // 画像座標Y
    tags: ["1年生", "体験・ゲーム"],
    description: "カジノへようこそ!...",
    image: "images/ira/1-1.jpg",
    contentType: "gallery",
    gallery: [],
  },
  // ...
];
```

### ステージデータ (stageData)

```javascript
const stageData = [
  {
    id: "day1-keion-1",
    groupId: "keion",
    groupName: "軽音楽部",
    name: "ライブ",
    place: "体育館",
    locationId: "gymnasium",
    time: "10:30 - 11:20",
    tags: ["DAY1", "ステージ", "音楽", "部活動"],
    // ...
  },
  // ...
];
```

---

## 🔧 技術スタック

### 採用技術

| 項目         | 技術             | 理由                            |
| ------------ | ---------------- | ------------------------------- |
| 3D描画       | **Three.js**     | testmap2.htmlで実績あり、高品質 |
| カメラ制御   | OrbitControls    | ドラッグ・ズーム・回転          |
| レイキャスト | Raycaster        | マウスクリック検出              |
| UI           | vanilla HTML/CSS | 軽量、依存なし                  |

### 検討したが不採用の技術

| 技術              | 不採用理由                   |
| ----------------- | ---------------------------- |
| MapLibre GL JS    | 建物の自由配置がやりにくい   |
| Leaflet.js        | 昨年採用したが不評（2D限定） |
| CSS 3D Transforms | 表現力に限界                 |

---

## ✅ 実装済み機能

| 機能                     | ファイル             | 状態 |
| ------------------------ | -------------------- | ---- |
| 3D建物表示               | map3d.html           | ✅   |
| フロア切り替え (1F-5F)   | map3d.html           | ✅   |
| 建物選択ボタン           | map3d.html           | ✅   |
| クリックで情報パネル表示 | map3d.html           | ✅   |
| 企画データ連携           | map3d.html + data.js | ✅   |
| ズーム/回転/パン操作     | map3d.html           | ✅   |
| ホバーエフェクト         | map3d.html           | ✅   |

---

## 🛠️ 3Dマップエディタ機能詳細

本番環境のマップに表示する建物データを作成・編集するための専用ツールです。
`http://localhost:3000/map_editor/` で起動します。

### 🌏 編集環境

- **無限のフィールド**: 20000m x 20000m の広大なグリッド。学校全体だけでなく周辺地域も余裕でカバーできます。
- **自由なカメラ**:
  - **ズーム**: 0.05倍（超広角）〜50倍（超接写）まで制限なく拡大縮小可能。
  - **操作**: 頂点編集モード中でも、ハンドル操作時以外は自由に視点移動・回転ができます。

### 🏗️ モデリング操作

- **四角形押し出し（直感3ステップ）**:
  1. **準備**: 青い辺ハンドルをクリック（誤爆防止）
  2. **始点**: 辺上の好きな場所をクリック（🟢マーカー）
  3. **幅**: 別の場所をクリックして幅を決定（📏 ライン表示）
  4. **奥行**: マウスで伸ばしてクリックで確定
- **インテリジェントスナップ**:
  - **ローカル軸対応**: 斜めに配置した建物でも、その建物にとっての「直角」「平行」に吸着します。
  - **直線補正**: 辺の途中の頂点をドラッグすると、180度（一直線）になる位置でピタッと止まります。
  - **数値確認**: ドラッグ中、リアルタイムで角度（例: `90.0°`）を表示します。

### 💾 データ管理・その他

- **JSON入出力**: 浮動小数点誤差を許さず、精密な座標データを保存・読み込み可能。
- **背景トレース**: 航空写真などを背景に敷いて、不透明度やスケールを調整しながらなぞるだけでマップが作れます。
- **自動保存**: 作業内容はブラウザに自動保存され、リロードしても消えません。

---

## 🚧 開発予定

建物内部の教室もエディタで配置:

```json
{
  "buildingId": "student",
  "floor": 4,
  "rooms": [
    {
      "id": "1-1",
      "name": "1年1組",
      "x": -70,
      "z": 0,
      "width": 20,
      "height": 14
    }
  ]
}
```

### Phase 3: UI/UX改善

- モバイル対応（タッチ操作最適化）
- 検索・フィルター機能
- アニメーション・トランジション
- 詳細パネルの充実

### Phase 4: AI連携（オプション）

testmap1.htmlにあったAI Concierge機能を統合検討。

---

## 🔗 会話履歴メモ

| 日付       | 内容                                            |
| ---------- | ----------------------------------------------- |
| 2026-01-29 | testmap2, map.html, lastyear/map.htm を調査     |
| 2026-01-29 | testmap2ベースでmap3d.html作成                  |
| 2026-01-29 | ユーザーから配置図受領、建物レイアウト反映      |
| 2026-01-29 | ビジュアルエディタ構想→別会話で開発予定         |
| 2026-01-29 | **3Dマップエディタ開発完了** (main/map_editor/) |

---

## 📝 次にこのドキュメントを開いた人へ

1. まず `map3d.html` を `npx serve main -p 3000` で起動して現状確認
2. **建物配置を調整するなら `http://localhost:3000/map_editor/` を使用**
3. エディタでJSONをエクスポートし、`map3d.html` の `BUILDINGS` 定数を更新
4. 企画データの座標マッピング（mapX/mapY → 3D座標）を改善する
