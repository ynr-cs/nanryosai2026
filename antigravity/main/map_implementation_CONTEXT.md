# 🗺️ 3Dマップ機能 技術実装詳細書 (v0.6.0)

> このドキュメントは、南陵祭2026プロジェクトにおける3Dマップ機能（表示・編集・データ構造）に関する**技術的な詳細仕様**を網羅したものです。
> 開発者は機能追加やバグ修正の前に必ず本書を参照し、一貫性を維持してください。

---

## 🏗️ 1. アーキテクチャ概要

本システムは、ユーザーがブラウザ上で直感的に3Dマップを操作できる「ビューア」と、開発者（および実行委員）がマップデータを作成するための「エディタ」の2部構成となっています。

| コンポーネント | パス                             | 技術スタック                                     | 役割                                                       |
| -------------- | -------------------------------- | ------------------------------------------------ | ---------------------------------------------------------- |
| **Viewer**     | `main/map3d.html`                | Three.js (r128), OrbitControls                   | 一般公開用。軽量高速な表示、企画検索、ナビゲーション。     |
| **Editor**     | `main/map_editor/`               | Three.js (r128), DragControls, TransformControls | データ作成用。多角形モデリング、背景トレース、JSON入出力。 |
| **Data**       | `main/map_editor/buildings.json` | JSON                                             | 建物形状、座標、メタデータを格納する単一の真実（SSOT）。   |

---

## 📊 2. データ構造仕様

v0.2.0 より、建物の表現形式を「単純な矩形」から「自由な多角形」へ移行しました。また、v0.5.0より「道路」データがノード・セグメント形式へ拡張され、ベジェ曲線に対応しました。

### 🏢 Building Object Schema

```json
{
  "id": "student-building", // 一意のID
  "name": "生徒棟", // 表示名
  "x": 120.5, // 座標系の基準点（ワールドX座標）
  "z": -45.2, // 座標系の基準点（ワールドZ座標）
  "width": 50.0, // バウンディングボックスの幅（概算）
  "depth": 30.0, // バウンディングボックスの奥行（概算）
  "floors": 5, // 階数（高さ計算に使用: floors * 3m）
  "rotation": 15.0, // Y軸回転角度（度数法）
  "color": 15658734, // 表示色
  "path": [
    // 多角形の頂点座標配列（ローカル座標系）
    { "x": -25.0, "z": -15.0 },
    { "x": 25.0, "z": -15.0 },
    { "x": 25.0, "z": 0.0 },
    { "x": 10.0, "z": 15.0 },
    { "x": -25.0, "z": 15.0 }
  ]
}
```

### 🛣️ Road Object Schema (v0.5.0+)

v0.5.0（Road Toolの高度化）により建設UXを大幅に改善し、ノード・セグメント・制御点によるベジェ曲線をフルサポートしました。

```json
{
  "id": "road-main-street",
  "type": "road",
  "width": 6.0,
  "nodes": [
    { "id": "node_1", "x": 10.0, "z": 50.0 },
    { "id": "node_2", "x": 100.0, "z": 50.0 }
  ],
  "segments": [{ "from": "node_1", "to": "node_2", "control": "node_ctrl_id" }]
}
```

- **建設ロジック (RoadToolManager)**:
  - **Snapping**: 1. Node (2m) > 2. Angle (90/180 deg) > 3. Grid (1m)。
  - **相対角度拘束**: 既存道路からの連続敷設時、180度方向（直進）への自動スナップを優先。
  - **UX Design (v0.2.26)**:
    - **Initial Mode**: 起動時は `EDIT`（選択）モードをデフォルトとし、誤操作を防止。
    - **Right-Click**: 作業のキャンセル・リセットのみを行い、モード遷移を自動で行わない。
    - **カメラ操作連動**: ドラッグ終了時の微小移動（5px以内）のみをクリックとして判定し、カメラ操作中の誤爆を排除。
  - **Deletion (v0.2.20)**:
    - 道路端に応じた動的な閾値判定と、矩形交差判定による範囲削除を実装。

### 📐 座標系とPivot管理

回転時の位置ズレを防ぐため、以下のロジックを適用しています。

1. **回転座標の整合性 (v0.2.3)**:
   Three.js の右手系座標系に合わせ、回転行列の符号を厳密に管理。回転した建物でも頂点ハンドルが正しい位置に追従します。
2. **重心補正 (Planned)**:
   頂点変形時にPivotがずれないよう、重心を自動計算して座標系を正規化する `recenterBuilding` ロジックの導入を検討。

---

## 🛠️ 3. エディタ機能詳細

### 🖱️ 操作モード

- **選択モード (EDIT)**:
  - 建物の水平移動（ドラッグ）、プロパティ直接編集。
- **道路敷設モード (LINE/CURVE)**:
  - 3ステップ入力（始点→制御点→終点）による Cities: Skylines 風の建設体験。
- **頂点編集モード (Vertex Edit)**:
  - **頂点移動**: 黄色ハンドル (🟡) をドラッグして形状変形。
  - **頂点追加**: 辺中央の青ハンドル (🔵) をクリックして頂点挿入。
  - **頂点削除 (v0.2.27)**: 黄色ハンドル (🟡) を**右クリック**で削除。※最低3頂点を維持。

---

## 💾 データ永続化

LocalStorage (`mapEditorData`) に建物、道路、背景画像の設定（キャリブレーション含）が自動保存されます。

---

## 📝 5. 今後の拡張ロードマップ (TODO)

学校マップを「実用的な運営ツール」として完成させるために実装すべき要素を以下に整理します。

### 5.1 空間・形状表現の高度化

- [ ] **広場・広域スペースの処理**: 道路（線）だけでなく、オープンスペースや中庭などを表現する「面」データの実装。建物の描画ロジックを流用した「塗りつぶしエリア」の概念を導入する。
- [ ] **ピロティ (1F吹き抜け) の対応**: 建物データ構造に `bottomHeight`（底面高）を導入し、1階部分が吹き抜けでその下を道路が通れる多層構造をサポートする。
- [ ] **敷地境界 (Site Boundary)**: 学校の敷地範囲を視覚化し、データの管理範囲を示すポリゴンレイヤー。

### 5.2 ランドマークと設備

- [ ] **校門 (Gates)**: 正門・裏門など、特定の外観（Mesh）を持つシンボリックなオブジェクトの配置。
- [ ] **バス停 (Bus Stops)**: 敷地周辺および校内の交通接点を配置可能にする。
- [ ] **接続点 (Entrance/Exit)**: 校舎への入口・出口をノードとして定義。道路網とシームレスにスナップ（自動接続）する仕組みの構築。

### 5.3 建物内部とディテール

- [ ] **フロア別・部屋別データ**: 建物内部に `rooms` 配列を持たせ、教室内までナビゲート可能にする（将来構想）。
- [ ] **テクスチャマッピング**: 外壁や地面へのリアルなテクスチャ適用。
- [ ] **ナビゲーションメッシュ (NavMesh)**: キャラクター移動時の障害物判定用データの生成。

---

## 🔗 参照リンク

- [CHANGELOG.md](../../CHANGELOG.md): バージョンごとの技術詳細ログ
- [editor.js](../main/map_editor/editor.js): エディタの全ロジック
- [map3d.html](../main/map3d.html): 本番ビューア
