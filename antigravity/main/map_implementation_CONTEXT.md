# 🗺️ 3Dマップ機能 技術実装詳細書 (v0.2.0)

> このドキュメントは、南陵祭2026プロジェクトにおける3Dマップ機能（表示・編集・データ構造）に関する**技術的な詳細仕様**を網羅したものです。
> 開発者は機能追加やバグ修正の前に必ず本書を参照し、一貫性を維持してください。

---

## 🏗️ 1. アーキテクチャ概要

本システムは、ユーザーがブラウザ上で直感的に3Dマップを操作できる「ビューア」と、開発者（および実行委員）がマップデータを作成するための「エディタ」の2部構成となっています。

| コンポーネント | パス                             | 技術スタック                                     | 役割                                                       |
| -------------- | -------------------------------- | ------------------------------------------------ | ---------------------------------------------------------- |
| **Viewer**     | `main/map3d.html`                | Three.js (r128), OrbitControls                   | 一般公開用。軽量高速な表示、企画検索、ナビゲーション。     |
| **Editor**     | `main/map_editor/`               | Three.js (r128), DragControls, TransformControls | データ作成用。多角形モデリング、背景トレース、JSON入出力。 |
| **Data**       | `main/map_editor/buildings.json` | JSON                                             | 建物形状、座標、メタデータを格納する単一の真実（SSOT）。   |

---

## 📊 2. データ構造仕様

v0.2.0 (2026-02-05) より、建物の表現形式を「単純な矩形」から「自由な多角形」へ移行しました。これに伴い、データ構造も大幅に拡張されています。

### 🏢 Building Object Schema

```json
{
  "id": "student-building", // 一意のID（プログラム参照用）
  "name": "生徒棟", // 表示名
  "x": 120.5, // 【重要】建物の回転中心（Pivot）のワールドX座標 (メートル)
  "z": -45.2, // 【重要】建物の回転中心（Pivot）のワールドZ座標 (メートル)
  "width": 50.0, // バウンディングボックスの幅（概算用）
  "depth": 30.0, // バウンディングボックスの奥行（概算用）
  "floors": 5, // 階数（高さ計算に使用: floors * 3m）
  "rotation": 15.0, // Y軸回転角度（度数法: 0〜360）
  "color": 15658734, // 表示色（10進数: 0xEEEEEE）
  "path": [
    // 【v0.2.0新設】多角形の頂点座標配列（ローカル座標系）
    { "x": -25.0, "z": -15.0 },
    { "x": 25.0, "z": -15.0 },
    { "x": 25.0, "z": 0.0 }, // L字型などの複雑な形状を表現可能
    { "x": 10.0, "z": 15.0 },
    { "x": -25.0, "z": 15.0 }
  ]
}
```

### 📐 座標系とPivot管理 (Critical Logic)

v0.2.0以前のバグ（回転時に建物が大きく振れる現象）を解決するため、**重心(Centroid)ベースの座標管理**を導入しました。

1. **データ正規化 (`recenterBuilding`)**:
   - 頂点編集が行われるたびに、`path` の全頂点の重心 $(cx, cz)$ を計算します。
   - すべての頂点を $(-cx, -cz)$ 移動させ、`path` の重心をローカル原点 $(0,0)$ に合わせます。
   - 移動した分だけ、ワールド座標 $(x, z)$ を回転を考慮して補正します。
   - **結果**: ユーザーがどんな形に変形させても、回転軸（Pivot）は常に建物の「へそ」に維持されます。

2. **描画時の補正 (`createBuildingMesh`)**:
   - `ExtrudeGeometry` はShapeの原点に基づいてメッシュを生成しますが、内部計算で微妙なズレが生じることがあります。
   - 生成されたGeometryのBoundingBox中心を計算し、それを打ち消す逆オフセットをMeshのPositionに加算することで、見た目上の位置ズレを完全に防いでいます。

---

## 🛠️ 3. エディタ機能詳細 (v0.2.0)

### 🖱️ 操作モード

- **選択モード (Default)**:
  - 建物をクリックして選択。
  - `DragControls` により、建物を水平面(XZ)上で自由にドラッグ移動。
  - プロパティパネルで数値による精密配置。

- **頂点編集モード (Vertex Edit)**:
  - **頂点移動**: 黄色のハンドル (🟡) をドラッグして形状を変形。
  - **頂点追加**: 辺の中央にある緑色のハンドル (🟢) をクリックすると、その位置に新しい頂点が挿入され、即座に編集可能になります。
  - **スナップ**: `Shift` キーを押しながらドラッグ（または設定で常時ON）すると、1m単位などきりの良い座標に吸着します。

### 🗺️ 背景画像トレースシステム

現実の地図を正確に再現するための強力な支援機能です。

1. **Google Maps URL解析**:
   - 入力: `https://.../@35.123,139.456,111m/...` (新しい高度形式) または `...18z` (ズーム形式)
   - ロジック: 緯度と高度/ズームレベルから `metersPerPixel` を逆算し、背景画像の表示サイズを自動決定します。
2. **キャリブレーション**:
   - 地図上の「校舎の端から端まで」など、実距離がわかっている2点をクリック。
   - 「ここは50m」と入力すると、背景画像のスケールが逆算され、完璧な縮尺に補正されます。

3. **クリップボード・ペースト**:
   - ブラウザで地図を表示 → `PrintScreen` → エディタ上で `Ctrl+V`。
   - ファイル保存の手間なく、即座にトレース作業を開始できます。

---

## 🎨 4. レンダリング仕様

Three.js r128 を使用し、軽量かつ視認性の高い描画を行っています。

- **マテリアル**: `MeshLambertMaterial` (透明度0.9) を採用。重なり合っても背後がうっすら見えるため位置関係が把握しやすい。
- **エッジライン**: `EdgesGeometry` を使用して建物の輪郭を白線で強調。
- **影 (Shadow Map)**: 建物が地面に影を落とすことで、浮遊感（高さの認識）をユーザーに与えます。
- **照明**:
  - `AmbientLight`: 全体を柔らかく照らす。
  - `DirectionalLight`: 太陽光に相当。影を生成する。

---

## 📝 5. 今後の拡張ロードマップ

1. **フロア別・部屋別データの実装**:
   - 現在は「建物」単位ですが、次のステップで「階数ごと」さらに「教室ごと」の区画データを内部に持つ構造へアップグレードします。
   - `buildings.json` 内に `rooms` 配列を持たせる設計です。

2. **テクスチャマッピング**:
   - 現在の単色表示から、レンガやコンクリートなどのテクスチャ貼り付けに対応予定。

3. **ナビゲーションメッシュ (NavMesh)**:
   - 3D空間内をキャラクター（アバター）が歩き回る際、壁にぶつかったり階段を登ったりするための移動可能領域データの生成。

---

## 🔗 参照リンク

- [CHANGELOG.md](../../CHANGELOG.md): バージョンごとの変更履歴
- [editor.js](../main/map_editor/editor.js): エディタの全ロジック
- [map3d.html](../main/map3d.html): 本番ビューア
