# data.js コンテキストドキュメント

このファイルは、`main/data/data.js` 及び関連するデータ構造、同期ロジックについて、今後の開発担当者（AI 含む）に引き継ぐための重要事項をまとめたものです。

## ファイルの役割

- **`main/data/data.js`**: プロジェクト（クラス企画、部活動、ステージ）のマスターデータです。
- 開発時および初期表示時のデータソースとして機能します。
- `admin_sync.html` を介して Firestore に同期されますが、同期ロジックにはフィルタリングが存在します。

## データ構造: `projectData`

`projectData` 配列は、クラス企画、部活動（展示・食品・ステージ）のすべての団体データを含みます。

### 主要フィールド

| フィールド名  | 説明                                                          | 例                                               |
| :------------ | :------------------------------------------------------------ | :----------------------------------------------- |
| `id`          | **一意の識別子**。詳細ページの URL パラメータ等に使用。       | `301` (クラス), `keion` (軽音), `brass` (吹奏楽) |
| `loginId`     | ログイン用 ID（`id`と同一の場合もあるが、異なる場合もある）。 | `class301`, `keion`                              |
| `groupName`   | 団体名（クラス名や部活名）。                                  | `3年1組`, `軽音楽部`                             |
| `name`        | 企画名。                                                      | `やきそばスター`, `南陵ライブ2026`               |
| `place`       | **デフォルトの場所表記**。一覧画面に表示される。              | `中庭テントA`, `視聴覚室・体育館`                |
| `contentType` | 企画の種類。`menu` (販売あり) または `gallery` (展示・発表)。 | `menu`, `gallery`                                |
| `menu`        | 販売メニューの配列。`contentType: 'menu'` の場合に使用。      | `[{ name: "焼きそば", price: "300円", ... }]`    |
| `schedule`    | **[NEW]** 日別・時間別の活動場所定義。                        | (後述)                                           |

### ID 命名規則 (2026 年版)

- **クラス**: `101` ～ `308` (数値文字列)
- **部活動・その他**: **意味のある英単語 ID** を使用。
  - 旧: `901`, `902` ...
  - 新: `kado` (華道), `bijutsu` (美術), `keion` (軽音), `brass` (吹奏楽)

### `schedule` プロパティ (マルチロケーション対応)

複数の活動場所を持つ団体（軽音楽部、吹奏楽部など）のために導入されました。
これにより、1 つの団体 ID (`keion`) でページを統一しつつ、日時によって場所を出し分けることが可能です。

```javascript
schedule: [
  { day: 1, place: "特別棟 3F 視聴覚室", floor: 3, time: "10:00-15:00" },
  { day: 2, place: "体育館", floor: 1, time: "10:00-13:00" },
];
```

- フロントエンド実装時は、`day` パラメータに応じてこの配列から適切な `place` を取得してください。
- `schedule` が存在しない団体は、ルートの `place` プロパティを使用します。

## データ構造: `stageData` (レガシー/簡易表示用)

`stageData` 配列は、トップページのスクローラー（タイムスケジュール）表示用として残されています。
`projectData` と一部重複していますが、現状は **トップページ表示専用** として独立して管理されています。
将来的には `projectData` の `schedule` から動的に生成することも検討されていますが、現在は静的に定義されています。

**注意**: `stageData` 側の ID は `brass_d1` (Day1 吹奏楽), `keion_d2` (Day2 軽音) のように、**イベント単位** で ID が振られています。

## Firestore 同期ロジック (`admin_sync.html`)

`admin_sync.html` の `syncStores` / `syncItems` 関数によって Firestore と同期されます。

### 重要なフィルタリングルール

- **`contentType: 'menu'` の団体のみ** が `stores` および `items` コレクションに同期されます。
- 展示・発表系 (`gallery`) の団体は、オーダー機能不要のため Firestore には同期されません（現状の仕様）。
- もし展示団体の混雑状況などを Firestore で管理する場合は、このフィルタリングロジックの変更が必要です。

## その他注意点

- `generate_hash.js` などのユーティリティスクリプトが存在しますが、これらは本番稼働用ではなく開発ツールです。
- `map.html` はまだ実装されていない（または主要パスにない）可能性があります。`schedule` プロパティを活用したマップ実装が待たれます。

## 現在の課題と対策 (2025/01/10 - Debugging Admin Page)

### 課題: `stores_test` へのデータ移行と `loginId` 欠損

- **現象**: テスト環境 (`stores_test`) で `loginId` が空になる問題が発生。
- **原因**: `stores_test` は初期状態で空であり、画面上のデータ（`data.js` 由来）で上書きしていたが、`data.js` に `loginId` が含まれていない場合、空文字で上書きされていた。
- **対策**:
  1. **`data.js` の更新**: `loginId` フィールドをマスタデータに追加済み。
  2. **Admin ツールの改良**: `admin_sync.html` に **「本番から読込」** ボタンを追加。
- **推奨ワークフロー (データ移行)**:
  1. 「本番から読込」で `stores` (本番) のデータを取得（`loginId` 含む）。
  2. 「テストモード」にチェックを入れる。
  3. 「Firestore 同期」を実行し、取得したデータを `stores_test` に安全にコピーする。

### 課題: 店舗用パスワード（Secret）の管理 [RESOLVED] (2025/01/14)

- **以前の課題**:

  - `admin_sync.html` ではパスワード (`store_secrets`) を設定できず、開発者が手動でハッシュ生成スクリプトを回す必要があった。

- **解決策 (実装済み)**:
  `admin_sync.html` にパスワード設定機能を統合しました。

  1.  **Backend (Cloud Functions)**:

      - `createStoreSecret`: 単一店舗のパスワードを設定。
      - `batchUpdateStoreSecrets`: 複数店舗のパスワードを一括設定（最大 500 件）。
      - **セキュリティ**: どちらも Super Admin (`ynrcs1000@gmail.com`) のみ実行可能。

  2.  **Frontend (`admin_sync.html`)**:
      - **個別設定**: 店舗一覧の各行に「鍵アイコン (🔑)」を追加。クリックでパスワードを設定（デフォルト値は ID と同じ）。
      - **一括同期**: ツールバーに「🔑 全パスワード一括同期」ボタンを追加。表示中の全店舗のパスワードを「ID と同じ値」に一括リセット・保存する。

- **運用**:
  - 新規店舗追加時は、リストに追加した後、その行の鍵アイコンを押すだけでパスワード設定が完了する。
  - テスト環境構築時などは「一括同期」ボタンで全店舗のパスワードを即座に初期化できる。

### 課題: `data.js` 内の不要な `image` プロパティ削除 (2025/01/14)

- **現象**: `data.js` に `image: "images/..."` という記述があったが、これは古い仕様または不要なデータであった。
- **仕様確認**: `index.html` 等のフロントエンド実装では、団体 ID (`id`) に基づいて画像を自動解決している（例: `id="301"` -> `images/301.png`）。
- **問題点**: 誤ったパスやプレースホルダー URL (`placehold.co`) が `image` プロパティに残っていると、同期時に Firestore に不正なデータが書き込まれるリスクがあった。
- **対策**:
  1. **`data.js` の修正**: `image` プロパティを削除。`menu` 内の `imageUrl` は商品画像として必要なので残すが、プレースホルダーは削除（空文字化）。
  2. **`admin_sync.html` の修正**: Firestore 同期ロジックから `image` フィールドの参照を削除。
- **今後の運用**:
  - 団体のメイン画像（サムネイル）は、`images/{id}.png` として配置するだけで自動的に適用される。
  - `data.js` に画像パスを記述する必要はない。
