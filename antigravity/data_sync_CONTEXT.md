# データ同期アーキテクチャ分析レポート

本ドキュメントは、`data.js`、`admin_sync.html`、および Firebase (Firestore) 間のデータ同期メカニズムに関する詳細な分析結果です。`antigravity/main/data_CONTEXT.md` の内容も統合されています。

## 1. 全体像と役割分担

本システムのデータ管理は、開発効率と本番運用のバランスを取るため、以下の3層構造を採用しています。

| 層              | コンポーネント         | 役割                                                          | 永続性      |
| :-------------- | :--------------------- | :------------------------------------------------------------ | :---------- |
| **開発/マスタ** | `main/data/data.js`    | 開発用シードデータ、コードベース管理される正本。Git管理対象。 | **Static**  |
| **ブリッジ**    | `main/admin_sync.html` | `data.js` と Firestore を手動で同期する管理ツール。           | Temporary   |
| **本番運用**    | **Firestore**          | アプリ (`mobile-order.html`) が実際に参照するデータソース。   | **Dynamic** |

## 2. 同期の詳細仕様

**重要:** `data.js` の全てのデータが Firestore に同期されるわけではありません。用途（モバイルオーダー）に必要なデータのみが選択的に同期されます。

### A. 店舗情報 (`syncStores`)

`data.js` の `projectData` から Firestore `stores` コレクションへの同期。

- **同期対象:** `contentType: 'menu'` の団体のみ。
  - 展示 (`gallery`) やステージ発表のみの団体は、現状モバイルオーダー機能を使用しないため、Firestore には同期されません。
- **フィールドマッピング:**
  - 以下のようにフィールド名が変換、または**除外**されます。

| data.js (`projectData`) | Sync Logic (`admin_sync.html`) | Firestore (`stores`) | 備考                          |
| :---------------------- | :----------------------------- | :------------------- | :---------------------------- |
| `id`                    | (`doc.id` として使用)          | **Document ID**      | 例: `301`, `brass`            |
| `groupName`             | `→`                            | `name`               | **名称変更** (例: 3年1組)     |
| `name`                  | `→`                            | `teamName`           | **名称変更** (例: やきそば屋) |
| `description`           | `→`                            | `description`        |                               |
| `loginId`               | `→`                            | `loginId`            |                               |
| `place`                 | **除外**                       | -                    | モバイルオーダーでは未使用    |
| `floor`                 | **除外**                       | -                    | モバイルオーダーでは未使用    |
| `catchphrase`           | **除外**                       | -                    | Web広報用（同期対象外）       |
| `tags`                  | **除外**                       | -                    | Web広報用（同期対象外）       |
| `schedule`              | **除外**                       | -                    | Web広報用（同期対象外）       |
| `image` (廃止)          | **参照なし**                   | -                    | `images/{id}.png` を自動解決  |

### B. メニュー情報 (`syncItems`)

- **完全洗い替え**: 指定店舗 (`storeId`) に紐づく `items` ドキュメントは、同期時に**一度すべて削除され、`data.js` の内容で再作成**されます。Firsestore 上での手動編集は保存されません。
- **価格データ**: 文字列（`"300円"`）から数値（`300`）への変換が行われます。
- **商品画像**: `data.js` に `imageUrl` (Firebase Storage URL) が含まれている場合は同期されます。

### C. パスワード管理 (`store_secrets`)

- `data.js` にはパスワードを含みません（セキュリティリスク回避）。
- `admin_sync.html` 上の機能で、Cloud Functions を経由して Firestore `store_secrets` コレクション（管理者のみ読み書き可）に設定します。
- **一括同期**: テスト環境構築用として、全店舗のパスワードを `storeId` と同じ値にリセットする機能があります。

## 3. 画像管理ワークフロー (Image Management)

画像の種類によって、管理方法と保存場所が異なります。

| 種類             | 保存場所              | ファイル形式 | 管理／アップロード方法                                                                                                                 |
| :--------------- | :-------------------- | :----------- | :------------------------------------------------------------------------------------------------------------------------------------- |
| **店舗アイコン** | ローカル (`/images/`) | `ID.png`     | Git管理。開発者が手動で `nanryosai-2026/images/` フォルダに配置・コミットする。アプリは `images/{id}.png` を自動参照。                 |
| **商品写真**     | Cloud Storage         | `.webp`      | **店舗ポータル (`pos/portal.html`)** 経由でアップロード。クライアントで圧縮・変換され、Storage URL が Firestore `items` に保存される。 |

### 商品写真運用の注意点

- `admin_sync.html` で「Firestore同期 (メニュー)」を実行すると、Firestore 上の `items` が再作成されるため、**ポータルでアップロードした写真のリンク情報が一時的に消えるリスク**があります。
- **正しい運用フロー**:
  1.  `data.js` でメニューの基本情報（名前・価格）を定義＆同期。
  2.  各店舗がポータル (`pos/portal.html`) にログインし、写真をアップロード。
  3.  **重要**: 将来的に `data.js` を更新する際は、Firestore から最新データ（写真URL含む）を「Import」してから `data.js` を再生成する必要があります。そうしないと、写真リンクが消失します。

## 4. 運用・開発フローに関する知見

### ID 命名規則 (2026年度版)

- **クラス**: `301` などの数値文字列。
- **部活**: `kado` (華道), `keion` (軽音) などの英単語 ID。
  - ※ 旧仕様（`900` 番台）から変更されています。

### 画像の扱い

- 以前は `data.js` に `image` プロパティがありましたが、現在は廃止されています。
- フロントエンド (`mobile-order.html`) は `images/{id}.png` を自動的に参照します。同期時に画像パスデータは Firestore に保存されません。

### テスト環境 (`_test` コレクション)

- `admin_sync.html` の「テストモード」チェックボックスにより、同期先を `stores_test`, `items_test` に切り替え可能です。
- 「本番から読込」機能を使うことで、本番データ (`stores`) を一旦ローカルに取り込み、テストモードで同期することで、安全にテストデータを作成できます。

## 5. 結論

- **モバイルオーダーアプリは Firestore 依存**: アプリの動作確認には Firestore へのデータ同期が必須です。
- **情報の一元管理は `data.js`**: マスタデータはコードベースで管理されていますが、同期ロジックによる「フィルタリング（情報の切り捨て）」があることを認識しておく必要があります。
- **データフローの双方向性**: 基本は `data.js` -> Firestore ですが、商品写真のみ Firestore (Portal) -> `data.js` (Export) という逆流が必要になります。

## 参照ファイル

- `main/data/data.js`
- `main/admin_sync.html`
- `pos/mobile-order.html`
- `pos/portal.html` (商品画像アップロード)
