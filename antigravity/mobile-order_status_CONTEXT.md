# Mobile Order & Status 開発コンテキスト

本ドキュメントは、モバイルオーダー機能 (`mobile-order.html`) および 注文ステータス確認機能 (`status.html`) の開発経緯、実装詳細、決定事項、および今後の課題をまとめたものです。

---

## 1. モバイルオーダー (`mobile-order.html`)

### 1.1 役割とコンセプト

- **役割**: 利用者（一般客）が自身のスマートフォンから店舗の商品を注文するための画面。
- **コンセプト**: 「直感的で、迷わず、気持ちよく使える」。マクドナルド公式アプリを参考にしたモダンな UI/UX。

### 1.2 実装機能・UI 改善点

- **店舗選択画面**:
  - カード型デザイン（ハイブリッドカード）採用。
  - 店舗のロゴ、名称、取り扱い商品の一部（プレビュータグ）を表示し、選択しやすく改善。
  - ページ内遷移（SPA 風挙動）により、シームレスにメニュー画面へ移動。
- **メニュー画面**:
  - カテゴリフィルタを廃止し、2 列グリッドレイアウトで商品画像を大きく表示。
  - **商品画像表示ロジック（決定事項）**:
    1. **`items` コレクションの `imageUrl` フィールド**: これがあれば最優先で使用。
    2. **`image` プロパティ**: なければこのファイル名の画像を `../images/` から探す。
    3. **ローカル画像**: なければ `../images/{商品名}.png` を探す。
    4. **No Image**: 最終的に見つからなければ `../images/noimage.png` を表示。
    - **背景色**: 商品カードの画像エリアは背景色指定なし（白/透明）。
  - **売り切れ表示**: `isAvailable: false` の場合、画像上に「SOLD OUT」バッジを表示。
  - **ナビゲーション**: ヘッダーの店舗アイコンは `../images/{storeId}.png` を使用。× ボタンで店舗選択画面へスムーズに戻る (`deselectStore()`)。
- **オンボーディング**:
  - 初回アクセス時に表示。スクロール不要の 1 画面完結型に変更。
  - 通知許可と利用規約への同意を管理。
- **カート・注文**:
  - ボトムシート風のモーダルでカート内容を確認。
  - Google ログイン必須。注文データは Firestore の `orders` コレクションへ保存。

### 1.3 インフラ設定

- **Firebase Storage**:
  - 商品・店舗画像のホスティング先。
  - バケット名: `nanryosai-2026-a4091.firebasestorage.app`
  - CORS 設定: 全ドメイン許可 (`colors.json` 適用済み)。
- **App Check**:
  - 不正利用防止。開発環境 (`localhost`) ではデバッグトークン `b2ce898f-cc5b-4314-9d62-05da17bc3a4b` を使用して認証回避。

---

## 2. 注文ステータス確認 (`status.html`)

### 2.1 役割

- **役割**: 注文完了後のユーザーが、調理状況や呼び出し状況をリアルタイムで確認するための画面。
- **アクセス方法**: URL パラメータ `?orderId={注文ID}` を付与してアクセス。

### 2.2 実装機能

- **リアルタイム更新**: Firestore の `onSnapshot` を使用し、注文ステータスの変化を即座に画面に反映。
- **ステータス表示 (色とアイコンの変化)**:
  - `waiting` (調理待ち): グレー / 砂時計アイコン
  - `cooking` (調理中): 黄色 / 炎アイコン（パルスアニメーション）
  - `ready` (呼出中): 赤 / メガホンアイコン（点滅アニメーション）
  - `completed` (受渡完了): 緑 / チェックアイコン
- **注文詳細表示**:
  - 注文した商品一覧と合計金額を表示。
  - レシート番号 (`receiptNumber`) を大きく表示し、呼び出し時の参照用とする。
- **認証制御**:
  - `orderId` で指定されたドキュメントの閲覧にはログインが必要（Firestore セキュリティルールに基づく）。
  - 未ログイン時はログインボタンを表示。

---

## 3. 未解決のタスク・既知の課題

### 優先度高

1. **データ不整合の解消**:
   - `stores` コレクションの `storeId` と、画像ファイル名の整合性確認 (`../images/{storeId}.png`)。
   - 商品データの `imageUrl` フィールドの登録（現状はローカル画像や `noimage.png` にフォールバックしている）。
2. **本番環境確認**:
   - `firebase.json` のデプロイ設定確認。
   - セキュリティルール (`firestore.rules`, `storage.rules`) の本番運用向け厳格化。

### 優先度中

3. **コードのリファクタリング**:
   - `mobile-order.html` の JS コードが肥大化（約 1000 行超）。モジュール分割 (`import` 活用) やビルドツールの導入を検討。
4. **ステータス画面の改善**:
   - `status.html` にも `mobile-order.html` と同様のデザインシステム（フォント、カラーパレット）を適用し、統一感を出す（現状は独自のスタイル）。

---

## 4. 開発履歴要約 (直近)

- **Phase 1**: `mobile-order.html` の完全 UI リニューアル（マクドナルド風）。
- **Phase 2**: レスポンシブ対応の強化。PC 閲覧時にスマホアプリ風のレイアウト（幅固定・中央寄せ）になるようコンテナを導入。
- **Phase 3**: Firebase Storage 画像連携の実装、CORS エラー/ReCAPTCHA エラーの解消。コンテキストドキュメントの整備。
