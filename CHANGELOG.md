# 変更履歴 (Change Log)

本プロジェクトにおけるすべての重要な変更はこのファイルに記録されます。

フォーマットは [Keep a Changelog](https://keepachangelog.com/ja/1.0.0/) に基づき、
バージョン管理は [Semantic Versioning](https://semver.org/spec/v2.0.0.html) に準拠します。

## [0.3.0] 道路ツールの実装 - 2026-02-05

### メタ情報

- **AIモデル**: Antigravity (Gemini)
- **筆者**: AI

### 追加 (Added)

- **道路作成機能**:
  - サイドバーに「新規道路」ボタンを追加。
  - 幅を持った帯状のメッシュ（Y=0.02）として描画し、自由に配置可能にした。
- **道路の頂点編集**:
  - 建物の頂点編集モードを拡張し、道路のパス（経路）もドラッグで変更できるようにした。
  - グリッドスナップに対応（道路はワールド座標系でスナップ）。

### 変更 (Changed)

- **エディタコアのリファクタリング**:
  - `selectedBuilding` に依存していたロジックを修正し、`selectedRoad` との共存・切り替えを可能にした。
  - プロパティパネルを動的に切り替え、道路選択時は幅のみ編集可能にした。

## [0.2.3] 回転座標変換のバグ修正 - 2026-02-05

### メタ情報

- **AIモデル**: Antigravity (Gemini)
- **筆者**: AI

### 修正 (Fixed)

- **座標変換関数の符合修正**:
  - **背景/原因**: `localToWorld` および `worldToLocal` 関数において、回転行列の符号が Three.js の座標系（Y軸回転：右手法）と逆になっていた。これにより、回転した建物の頂点ハンドルが誤った位置に表示され、ドラッグ操作も逆方向に飛ぶ現象が発生していた。
  - **解決策**: Three.js の `Euler` (XYZ順) および `Matrix4` の内部計算と一致するように、回転行列の $sin$ 項の符号を反転させた。
  - **得られた知見**: 3Dライブラリ（Three.js）と独自計算を混用する場合、回転軸と符号の定義（右手法か左手法か）を厳密に一致させる必要がある。

## [0.2.2] ワークフローの強化（パッチノート記録の義務化） - 2026-02-05

### メタ情報

- **AIモデル**: Antigravity (Gemini)
- **筆者**: AI

### 変更 (Changed)

- **「1タスク = 1パッチ」ルールの導入**:
  - **背景/原因**: AIの会話が新しくなると過去のデバッグ知見が失われ、同様のバグ（例：特定条件下での頂点編集の不具合）に何度も直面する問題があった。
  - **解決策**: 1つのタスク（依頼）を完了するごとに必ずバージョン（v0.x.X）のパッチ番号を上げること、および `CHANGELOG.md` に技術的な背景・原因・解決策を濃密に記述することを `SKILL.md` で義務化した。
  - **得られた知見**: `antigravity/` 配下の複数ファイルに知見を分散させるとAIが混乱するため、`CHANGELOG.md` を「技術的な航海日誌」として唯一の真実（SSOT）に設定するのが最も効率的である。

## [0.2.1] 背景トレース保存機能の実装 - 2026-02-05

### メタ情報

- **AIモデル**: Antigravity (Gemini)
- **筆者**: AI

### 追加 (Added)

- **背景トレースの永続化**:
  - 設定した背景画像（DataURL形式）およびキャリブレーション設定（幅、位置、回転、透明度）を `localStorage` に保存。
  - 次回起動時に、前回作業していた地図の状態が自動で復元される機能。
- **UI/UXの改善**:
  - `loadBgImage` 時に現在のチェックボックスの状態（表示/非表示）を尊重するように修正。読み込み直後に意図せず画像が表示されてしまう挙動を防止。

### 修正 (Fixed)

- **回転した建物の頂点編集バグ**:
  - グリッドスナップがワールド座標基準で行われていたため、回転した建物の頂点をドラッグすると意図しない位置にズレる問題を修正。ローカル座標基準でスナップするように変更。

## [0.2.0] 3Dマップエディタの大規模機能強化 - 2026-02-05

### メタ情報

- **AIモデル**: Antigravity (Gemini)
- **筆者**: AI + Uokun

### 追加 (Added)

- **多角形（ExtrudeGeometry）のサポート**:
  - 建物の形状を従来の「矩形（BoxGeometry）」から「自由な多角形（ExtrudeGeometry）」ベースに刷新。
  - **頂点編集モード**: 各頂点の位置を個別にドラッグして調整可能に。
  - **頂点追加機能**: 辺の中央にあるハンドル（緑色）をクリックして、新しい角を自由に追加可能に。
- **背景画像トレース機能の強化**:
  - **Google Maps URL連携**: URL（`...z` 形式および `...m` 形式）を入力するだけで、縮尺（m/px）を自動推定・適用する機能。
  - **Google Earth URL連携**: URL（`...d` 形式）からカメラ距離を解析し、表示幅を自動設定する機能。
  - **クリップボード貼り付け (Ctrl+V)**: ブラウザ上の地図画像をスクリーンショットし、エディタに直接ペーストして背景として設定可能に。
  - **キャリブレーション**: 画像上の2点間をクリックし、実距離を入力することでスケールを正確に補正する機能。
  - **プレースホルダー表示**: URL入力時に、次に何をすべきか（スクショ貼り付け）を案内するガイド画像を表示。
- **UI/UXの改善**:
  - **メートル単位への完全移行**: すべての座標・サイズ表示を「メートル(m)」基準に統一し、Google Earth等の実測値と整合。
  - **プロパティパネル**: 各座標や回転、階数の数値を直接入力・編集可能に。
  - **ステータスバー**: 現在の操作（ドラッグ中、頂点編集中など）や解析結果をリアルタイムに表示。

### 変更 (Changed)

- `map_implementation_CONTEXT.md`: 最新の仕様（多角形データ構造 `path` プロパティの追加など）を反映して更新。
- **内部座標系の刷新**:
  - 建物の重心（Centroid）を常に基準点（Pivot）とするようにロジックを変更。
  - 頂点編集中に形状が変わっても、回転軸がずれないように自動補正(`recenterBuilding`)する仕組みを導入。

### 修正 (Fixed)

- **重大なバグ修正**:
  - 頂点編集モード中に建物を移動できてしまう/パラメーターが効かなくなる問題を修正。
  - 頂点ハンドル再生成時にドラッグ操作が中断される不具合を修正。
  - ExtrudeGeometry使用時に選択枠（白枠）とメッシュの位置がずれる描画上の不整合を修正。
  - `ReferenceError` (未定義関数) によるクラッシュを修正。

---

## [0.1.1] 移行フェーズの完了とクリーンアップ - 2026-02-05

### メタ情報

- **AIモデル**: Antigravity (Gemini)
- **筆者**: AI

### 削除 (Removed)

- `antigravity/v0.1.0_MIGRATION_CHECKLIST.md`: 全ファイルの移行（ヘッダー付与）が完了したため削除。

### 追加 (Added)

- `antigravity/migration_CONTEXT.md`: v0.1.0 移行作業の完了記録と、今後の運用方針をまとめた知見。

---

## [0.1.0] 変更履歴システムの始動 - 2026-02-05

### メタ情報

- **AIモデル**: Gemini
- **筆者**: Uokun

### 追加 (Added)

- `CHANGELOG.md` の作成と運用ルールの策定
- Semantic Versioning (v0.1.0) の導入
- `404.html`: 存在しないページへのアクセス時に表示されるエラーページ (v0.1.0 バージョンヘッダー適用)
- `debug_firestore_custom.js`: Firestore のデータを取得・確認するためのデバッグ用ユーティリティスクリプト (v0.1.0 バージョンヘッダー適用)
- `generate_hash.js`: 店舗用パスワードのハッシュとソルトを生成するためのユーティリティスクリプト (v0.1.0 バージョンヘッダー適用)
- `functions/index.js`: 受付番号発行、注文作成、決済処理、店舗認証などのコアロジックを担う Cloud Functions (v0.1.0 バージョンヘッダー適用)
- `main/index.html`: カウントダウン、リアルタイム情報、モバイルオーダー紹介、企画ハイライトを含むトップページ (v0.1.0 バージョンヘッダー適用)
- `main/style.css`: デザインシステム、ダークモード対応、共通コンポーネント、アニメーションを定義するベーススタイルシート (v0.1.0 バージョンヘッダー適用)
- `main/app-shell.js`: ヘッダー、ボトムナビゲーション、認証状態の監視、テーマ切り替えなどのアプリ共通シェル機能 (v0.1.0 バージョンヘッダー適用)
- `main/auth.js`: Firebase Authentication を使用した Google ログイン、ログアウト、ユーザー状態の監視を担うモジュール (v0.1.0 バージョンヘッダー適用)
- `main/account.html`: ユーザープロフィール、注文履歴、通知設定、アカウント管理を行うマイページ (v0.1.0 バージョンヘッダー適用)
- `main/admin_sync.html`: 企画データやメニュー情報の編集、Firestoreへの同期、data.jsの生成を行う管理ツール (v0.1.0 バージョンヘッダー適用)
- `main/detail.html`: 企画や模擬店の詳細情報、メニューリスト、ギャラリー、モバイルオーダー連携ボタンを表示する詳細ページ (v0.1.0 バージョンヘッダー適用)
- `main/map.html`: 校内の各フロア（1F〜5F）を3Dパース表示し、企画場所や施設の位置を確認できるフロアマップ 。実験段階の機能であり、`map-experiments/` フォルダと連携して開発中(v0.1.0 バージョンヘッダー適用)
- `main/map3d.html`: Three.js を使用した校内（キャンパス全体、生徒棟、体育館等）の3Dモデル探索が可能な立体マップ。実験段階の機能であり、`map-experiments/` フォルダと連携して開発中 (v0.1.0 バージョンヘッダー適用)
- `main/mobile-order-guide.html`: モバイルオーダーシステムのアーキテクチャ、セキュリティ設計、技術スタックを解説する技術仕様書 (v0.1.0 バージョンヘッダー適用)
- `main/projects-list.html`: 企画・展示の横断検索、カテゴリ・団体別フィルタリング、並び替え、表示形式（グリッド/リスト）切り替えが可能な企画一覧ページ (v0.1.0 バージョンヘッダー適用)
- `main/terms.html`: 注文後の商品の受け取り期限（15分）、禁止事項、免責事項、個人情報の取り扱いなどを定めた利用規約ページ (v0.1.0 バージョンヘッダー適用)
- `main/firebase-messaging-sw.js`: プッシュ通知をバックグラウンドで受信し、通知を表示するためのサービスワーカー (v0.1.0 バージョンヘッダー適用)
- `main/data/data.js`: 企画情報、メニュー、展示ギャラリー、ステージスケジュールなどの全コンテンツデータを保持するマスターデータファイル (v0.1.0 バージョンヘッダー適用)
- `pos/portal.html`: 各店舗の売上統計、商品管理、注文検索、および各運営画面（POS/キッチン等）へのアクセスを統合した管理用ポータル (v0.1.0 バージョンヘッダー適用)
- `pos/mobile-order.html`: 来場者がスマートフォンから商品を注文・決済するためのモバイルオーダー・クライアントUI (v0.1.0 バージョンヘッダー適用)
- `pos/monitor.html`: 調理完了・準備中の注文番号をリアルタイムに表示し、来場者へ商品の受け取りを促す digital signage 画面 (v0.1.0 バージョンヘッダー適用)
- `pos/kitchen.html`: 調理中の注文を一覧表示し、経過時間の監視やステータス更新（調理完了）を行う厨房用モニター画面 (v0.1.0 バージョンヘッダー適用)
- `pos/presenter.html`: 商品の受け渡し口で、お客様の呼び出しや対面決済（現金・QR）、受取完了処理を行うプレゼンター用画面 (v0.1.0 バージョンヘッダー適用)
- `pos/status.html`: 注文後の来場者が、調理・準備の進捗状況をリアルタイムに確認できるマイページ用注文ステータス画面 (v0.1.0 バージョンヘッダー適用)
- `pos/pos.html`: 店舗スタッフが対面で注文を受け付け、レジ会計処理を行うためのPOSシステム画面 (v0.1.0 バージョンヘッダー適用)
- `pos/simulator.html`: モバイルオーダーやSOK（券売機）の注文データをランダム生成し、Firestoreへ書き込む開発用注文シミュレーター (v0.1.0 バージョンヘッダー適用)
- `pos/animation.html`: 調理中、準備中、商品完成などの注文ステータスを可視化するアニメーション確認用画面 (v0.1.0 バージョンヘッダー適用)
- `pos/firebase-messaging-sw.js`: 店舗運営用（POS）セクションにおいて、プッシュ通知をバックグラウンドで受信するためのサービスワーカー (v0.1.0 バージョンヘッダー適用)
- `pos/training/index.html`: レジ担当、キッチン担当、呼び出し担当などの各ロールごとに操作方法を学習できるPOSトレーニングポータル (v0.1.0 バージョンヘッダー適用)
- `pos/training/kitchen.html`: 調理中の注文確認、カスタマイズ（抜き・追加）の把握、調理完了操作の流れを練習するためのキッチン担当用トレーニング画面 (v0.1.0 バージョンヘッダー適用)
- `pos/training/manager.html`: 売上確認、在庫切れ（Sold Out）設定、注文キャンセルなどの管理者・責任者限定機能を練習するための管理ポータルシミュレーター (v0.1.0 バージョンヘッダー適用)
- `pos/training/pos.html`: 模擬店スタッフが商品選択、カスタマイズ適用、会計確定までのレジ操作フローを習得するためのPOSレジトレーニング画面 (v0.1.0 バージョンヘッダー適用)
- `pos/training/presenter.html`: キッチンからの通知受信、お客様の番号呼び出し、対面決済および商品の受け渡し完了処理を練習するためのプレゼンター用トレーニング画面 (v0.1.0 バージョンヘッダー適用)
- `main/map_editor/index.html`: Three.js を用いた校内3Dモデル作成のためのエディタUI画面 (v0.1.0 バージョンヘッダー適用)
- `main/map_editor/editor.js`: 建物の配置、形状編集（頂点操作・押し出し）、プロパティ管理、JSONエクスポート等のエディタ機能を制御するメインロジック (v0.1.0 バージョンヘッダー適用)
- `main/map_editor/editor.css`: エディタのツールバー、サイドパネル、頂点編集用補助UIなどのデザインを定義する専用スタイルシート (v0.1.0 バージョンヘッダー適用)
- `main/lastyear/`: 前年度（南陵祭'25）の公式サイトのアーカイブ資料（`index.html`, `data.js`等） (v0.1.0 バージョンヘッダー適用)
- `main/map_admin/editor.html`: MapLibre GL JS を使用した、フロアマップのエリア定義（GeoJSON）作成・編集ツール (v0.1.0 バージョンヘッダー適用)
- `map-experiments/`: 3Dマップの表示・操作・AI連携（Gemini）などの技術検証用プロトタイプ（`testmap1.html`, `testmap2.html`） (v0.1.0 バージョンヘッダー適用)

### 変更 (Changed)

- `japanese_workflow` に変更履歴記録プロセスを追加
