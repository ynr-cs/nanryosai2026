# 変更履歴 (Change Log)

本プロジェクトにおけるすべての重要な変更はこのファイルに記録されます。

フォーマットは [Keep a Changelog](https://keepachangelog.com/ja/1.0.0/) に基づき、
バージョン管理は [Semantic Versioning](https://semver.org/spec/v2.0.0.html) に準拠しますが、以下の独自基準を最優先します。

### バージョニング基準

- **最上位基準**: ユーザーがプロダクトとして「完全に使える状態になった」と判断したかどうか。
- **メジャー (Major / x)**: ユーザーがすべてのファイルを精査し、「南稜祭本番で稼働できる」と判断した時のみ更新。
- **パッチ (Patch / z)**: 開発中のあらゆる変更（不具合修正、機能追加、調整等）。実用可能な「完成」に至るまでの試行錯誤のログ。
- **マイナー (Minor / y)**: ユーザーとAIの試行錯誤を経て、ユーザーが「完了・一区切り」を宣言・承認した時のみ更新。
- **承認プロセス**: AIからの提案に対し、ユーザーが「承認」することでマイナーバージョンを繰り上げる。

## [0.2.27] 建物の頂点削除機能の実装 - 2026-02-07

### メタ情報

- **AIモデル**: Antigravity (Gemini)
  - **筆者**: AI

### 追加 (Added)

- **頂点削除機能**: 頂点編集モードにおいて、黄色の頂点ハンドル (🟡) を**右クリック**することで頂点を削除できる機能を実装。
  - **最小頂点数の保護**: 形状（三角形）を維持するため、頂点数が3点以下の場合は削除を制限し、ステータスバーに警告を表示するガード処理を導入。
  - **自動再構築**: 削除後、即座に境界計算（Bounds）、メッシュ生成、および編集ハンドルの再構築を行い、シームレスな編集継続を可能にした。

## [0.2.26] 道路ツールUXの抜本的改善と不具合修正 - 2026-02-07

### メタ情報

- **AIモデル**: Antigravity (Gemini)
- **筆者**: AI

### 追加 (Added)

- **クリック誤爆防止ロジック**: カメラ操作のためのドラッグ終了時に意図せず道路が引かれるのを防ぐため、マウスの移動距離（閾値5px）に基づくクリックキャンセル機能を実装。
- **初期起動時の安全設計**: エディタ起動時にいきなり道路建設モード（LINE）にならないよう、デフォルトのモードを「編集（EDIT）」に変更。

### 変更 (Changed)

- **右クリック挙動の洗練**: 右クリックを「現在の建設作業のキャンセル・リセット」のみに限定。右クリックしただけで勝手に編集モードへ遷移しないようにし、連続した作業を妨げないように改善。

### 修正 (Fixed)

- **接線計算とガイドライン**: 曲線末端の接線取得精度向上、および点線ガイドが表示されない不具合を解消（v0.2.25の内容を包括）。

## [0.2.25] 接線計算の精度向上とガイドライン修正 - 2026-02-07

### メタ情報

- **AIモデル**: Antigravity (Gemini)
- **筆者**: AI

### 修正 (Fixed)

- **接線引き継ぎの精度向上**: 曲線から連続して次の道路を引く際、曲線の終端における接線方向をベジェ曲線の数式 ($P_2 - P_1$) に基づいて計算するように改善。これにより、曲線と直線の接続がより滑らかに。
- **ガイドライン表示の修正**: `updateGuideLine` でジオメトリを毎フレーム置換するようにし、点線ガイドが表示されない問題を解決。

## [0.2.24] 曲線モードの機能強化と不具合修正 - 2026-02-07

### メタ情報

- **AIモデル**: Antigravity (Gemini)
- **筆者**: AI

### 追加 (Added)

- **接線拘束 (Tangent Constraint)**: Cities Skylines同様、既存道路から曲線を開始する際、最初の制御点を既存道路の接線方向に自動的に拘束する機能を実装（Shiftキーで解除可能）。これにより、常に滑らかな接続が可能に。
- **State 2 ガイドライン**: 制御点決定後の終点選択中（State 2）にも、制御点からマウス位置へのガイドラインを表示するように変更し、視認性を向上。
- **角度表示の統合**: 曲線モードでも建設中の角度をリアルタイムに表示。

### 修正 (Fixed)

- **プレビュー消失バグ**: 連続して曲線を作成する際、2回目以降にベジェ曲線のプレビューが表示されなくなる（または接線情報が正しく引き継がれない）不具合を修正。
- **状態管理の安定化**: 曲線建設完了後のステート遷移を整理。

## [0.2.23] 道路プレビューの位置ずれ修正 - 2026-02-07

### メタ情報

- **AIモデル**: Antigravity (Gemini)
- **筆者**: AI

### 修正 (Fixed)

- **道路プレビューの吸着不具合**: 曲線モード（ベジェ曲線）を使用した後に直線モードに切り替えると、道路のプレビューが原点 (0,0,0) を参照して巨大な三角形になってしまう問題を修正。
  - **原因**: 共通の `ghostMesh` を使用する際、曲線モードでセットされたインデックス付きジオメトリが直線モードでもそのまま参照され続けていたため。
  - **解決策**: `updateGhost` メソッドで毎フレームジオメトリを dispose し、新規に生成して置換するように変更。これにより、古いインデックス情報が残留することを完全に排除。

## [0.2.22] ベジェ曲線道路システム実装 (Cities Skylinesスタイル) - 2026-02-07

### メタ情報

- **AIモデル**: Antigravity (Claude)
- **筆者**: AI

### 追加 (Added)

- **3ステップ入力システム**: Cities Skylinesに倣い、ベジェ曲線道路を直感的に作成できるステートマシンを実装。
  - **State 0 (始点)**: クリックで始点 (P0) を決定。既存ノードにスナップ時は接線を自動取得。
  - **State 1 (制御点)**: マウス移動でガイドライン（点線）表示。クリックで制御点 (P1) を決定。
  - **State 2 (終点)**: マウス移動でベジェ曲線のリアルタイムプレビュー表示。クリックで終点 (P2) を決定、曲線セグメント生成。
- **ガイドライン表示**: 始点から制御点方向への点線ガイド (`THREE.LineDashedMaterial`)。
- **リアルタイムプレビュー**: `THREE.QuadraticBezierCurve3` によるベジェ曲線に沿った道路メッシュをゴースト表示。
- **連続建設モード**: 曲線作成後、終点を次の始点として連続的に曲線道路を作成可能。
- **右クリックで1ステップ戻る**: 曲線モード中に右クリックで状態を1つ前に戻せる (終点待ち→制御点待ち→始点待ち)。
- **曲線長表示**: ツールチップにベジェ曲線の推定長をリアルタイム表示。

### 新規メソッド (`RoadToolManager` クラス)

- `onCurveClick(rawPos, isShiftPressed)`: 曲線モード専用クリックハンドラ
- `createCurveSegment(n0, nControl, n1)`: 曲線セグメントをデータ構造に追加
- `updateGuideLine(start, end)`: ガイドライン（点線）の更新
- `updateCurveGhost(p0, p1, p2)`: ベジェ曲線ゴーストプレビューの更新
- `createBezierMeshGeometry(p0, p1, p2, width, segments)`: ベジェ曲線に沿った帯状メッシュの生成
- `estimateBezierLength(p0, p1, p2)`: ベジェ曲線長の推定
- `calculateTangentFromNode(node)`: ノードから既存セグメントの接線ベクトル取得

### 技術詳細

- **ベジェ曲線数式**: $B(t) = (1-t)^2 P_0 + 2(1-t)t P_1 + t^2 P_2$
- **データ構造**: `segments` 配列の要素に `control` フィールド（制御点ノードID）を追加
- **描画**: `createRoadMesh` 関数は既にベジェ曲線に対応済み、追加修正不要

## [0.2.21] 道路建設のスナップ修正 - 2026-02-07

### メタ情報

- **AIモデル**: Antigravity (Gemini)
- **筆者**: AI

### 修正 (Fixed)

- **道路建設の不具合**: 道路ツール (`LINE`/`CURVE`) 使用時に既存の道路や建物を選択しようとするロジックが優先され、既存ノードからの建設開始が阻害されていた問題を修正。ツール使用中は建設を最優先するように整理。
- **ロジックエラー**: `createSegment` 内での道路タイプ判定ミス (`!targetRoad.type === "road"`) を修正。

## [0.2.20] 道路削除の体験改善 - 2026-02-07

### メタ情報

- **AIモデル**: Antigravity (Claude)
- **筆者**: AI

### 修正 (Fixed)

- **クリック削除の閾値改善**: `deleteRoadAt` の閾値を `2.0` 固定から `road.width / 2 + 1.0` に変更。道路端の近くをクリックしても削除できるようになりました。また `<` を `<=` に変更。
- **範囲削除の交差判定**: `deleteRoadsInRange` で、矩形が道路セグメントを横切る場合も削除されるように `segmentIntersectsRect` ヘルパーを追加。

### 追加 (Added)

- **`segmentIntersectsRect` メソッド**: 線分と矩形のAABB交差判定ユーティリティ。

## [0.2.19] 道路削除の安全性向上とUI改善 - 2026-02-07

### メタ情報

- **AIモデル**: Antigravity (Gemini)
- **筆者**: AI

### 修正 (Fixed)

- **Legacyデータ保護**: `deleteRoadAt` / `deleteRoadsInRange` のクリーンアップループで `roads[i].segments` の存在チェックを追加。古い形式の道路データ（`path`のみ等）が混在していてもクラッシュしないように修正。
- **削除モード中の選択操作**: `RoadToolManager.handleEvent` を修正し、`DELETE` モード中でもクリックイベントを透過（`return false`）させることで、グローバルの `onClick` が発火し、選択解除などができるように改善。

### 変更 (Changed)

- **イベントハンドリング**: `handleEvent` の戻り値を厳密化。`pointerdown/up` は `DELETE` モード時のみ `true` (伝播阻止) を返し、それ以外は `false` を返して他機能（OrbitControls等）と共存しやすく整理。

## [0.2.18] editor.js リファクタリングと道路削除の完全修正 - 2026-02-07

### メタ情報

- **AIモデル**: Antigravity (Gemini)
- **筆者**: AI

### 修正 (Fixed)

- **道路削除機能の堅牢化**:
  - **曲線対応**: ベジェ曲線の点列を展開して距離判定を行うロジック (`getDistanceToRoadSegment`) を導入し、曲がった道路の上をクリックしても正しく削除できるように修正。
  - **データ不整合対策**: `road.segments` や `road.nodes` が欠落しているLegacyデータが存在してもクラッシュせず、安全にスキップまたは削除するようにガード処理を追加。
- **選択ロジックの改善**:
  - `getRoadIdFromHitObject` ヘルパーを導入し、道路メッシュ（`THREE.Group`）の子要素（白線やサイドライン）をクリックしても、親グループを遡って正しく道路IDを特定できるように修正。これにより削除や選択の判定ミスを解消。

### 変更 (Changed)

- **コードリファクタリング**:
  - `editor.js` 末尾に残存していたLegacyなグローバル関数 (`addNewRoad`, `setupRoadToolInteractions` 等) を削除・整理。
  - ツール制御を `RoadToolManager` クラスに完全に一本化し、コードの重複と競合リスクを排除。

## [0.2.17] 道路削除ツールの競合修正 (Pointer Events 移行) - 2026-02-07

### メタ情報

- **AIモデル**: Antigravity (Gemini)
- **筆者**: AI

### 修正 (Fixed)

- **OrbitControls との競合解消**:
  - 道路削除モードでのドラッグ（範囲選択）がカメラの視点移動と競合する問題を根本解決。
  - イベントリスナーを `mousedown`/`mousemove`/`mouseup` から `pointerdown`/`pointermove`/`pointerup` へ移行。
  - `pointerdown` イベントをキャプチャフェーズ (`capture: true`) で捕捉し、削除モード時は `stopImmediatePropagation()` を実行することで、後続の `OrbitControls` へイベントが伝播するのを完全に遮断。
- **操作性の向上**:
  - ポインターイベントへの移行により、タッチデバイス等での将来的な操作性向上にも寄与。

## [0.2.16] 道路スナップと削除UIの修正 - 2026-02-07

### メタ情報

- **AIモデル**: Antigravity (Gemini)
- **筆者**: AI

### 修正 (Fixed)

- **相対角度スナップの実装**:
  - 角度スナップが絶対座標（0度、90度...）ではなく、接続元の道路の延長線を基準とした相対角度（直進、右折90度...）で機能するように修正。
  - 基準となる延長線をグレーの点線で表示し、0度の方向を明確化。
- **角度表示位置の調整**:
  - 角度ラベルの表示位置を円弧の中心付近に移動し、より直感的に配置。
- **バグ修正 (UI/UX)**:
  - 削除ボタンが反応しない問題を修正（イベントリスナーの追加漏れを解消）。
  - 道路接続時の黄色いノードスナップマーカーが表示されなくなっていた問題を修正（初期化漏れのガードを追加）。
  - 削除モードでのドラッグ（範囲選択）が視点移動（OrbitControls）と競合して機能しない問題を修正（キャプチャイベントでの制御を追加）。

## [0.2.15] 道路削除機能と範囲選択ツールの追加 - 2026-02-07

### メタ情報

- **AIモデル**: Antigravity (Gemini)
- **筆者**: AI

### 追加 (Added)

- **道路削除モード (DELETE)**:
  - 道路を個別に、または範囲指定でまとめて削除できる新しいツールを追加。
- **範囲選択（矩形選択）**:
  - `mousedown` からのドラッグで赤い選択枠を表示し、枠内に含まれる道路を一括削除する機能を実装。
- **データクリーンアップロジック**:
  - セグメントが削除された際、どこにも繋がっていない孤立したノード (Orphan Nodes) を自動的に検出・削除し、データを健全に保つ仕組みを導入。

### 変更 (Changed)

- **UIの更新**:
  - 道路ツールパネルに「削除」ボタンを追加。
  - 削除モード中はカーソルが赤色に変化し、視覚的にモードを判別可能に。

## [0.2.14] 角度表示の Cities: Skylines スタイル化 - 2026-02-07

### メタ情報

- **AIモデル**: Antigravity (Gemini)
- **筆者**: AI

### 変更 (Changed)

- **情報タグ（ツールチップ）の整理**:
  - 表示内容を**座標 (POS)** と **距離 (Length)** のみに限定し、 Cities: Skylines 風のシンプルな外見に調整。
- **3D角度ガイドの導入**:
  - 角度情報をツールチップではなく、3D空間上の**円弧（アーク）と専用ラベル**で表示するように変更。
  - 既存の道路と新しい道路の間に青色の点線アークが表示され、その角度をリアルタイムに視覚化。
  - **リファレンス検知**: 接続元のノードに繋がっている既存道路の方向を自動検知し、それに対する相対角を算出。

## [0.2.13] 道路ツールのUX向上（ノード吸着・角度表示） - 2026-02-07

### メタ情報

- **AIモデル**: Antigravity (Gemini)
- **筆者**: AI

### 追加 (Added)

- **ノード吸着の視覚化**:
  - **機能**: 既存の道路ノードにカーソルがスナップした際、青いカーソルではなく**オレンジ色の点（Sphere）**を表示するように変更。
  - **目的**: 確実に接続できるポイントをユーザーが直感的に識別できるようにするため。
- **角度情報の表示**:
  - **機能**: 直線モード等での建設中に、現在のセグメントの長さだけでなく**角度（Angle）**をツールチップにリアルタイム表示。
  - **目的**: 正確な角度での道路敷設や、既存道路との位置関係の把握を容易にするため。

## [0.2.12] 道路プレビュー（ゴースト）のバグ修正 - 2026-02-07

### メタ情報

- **AIモデル**: Antigravity (Gemini)
- **筆者**: AI

### 修正 (Fixed)

- **道路建設中のプレビュー（ゴースト）非表示バグ**:
  - **背景/原因**:
    1. 建設中の道路プレビュー（青い半透明メッシュ）において、頂点座標の更新後にバウンディングボックス/スフィアの再計算が行われていなかったため、Three.js のカリング（描画範囲外判定）によって非表示になっていた。
    2. 色が濃紺の地面に対して暗い青（`0x3b82f6`）だったため、背景に溶け込んで視認性が著しく低かった。
  - **解決策**:
    - `updateGhost` 関数内で `computeBoundingSphere()` と `computeBoundingBox()` を追加。
    - プレビューの色をより発色の良いシアン（`0x00ffff`）に変更し、不透明度を調整。
    - Z-fighting 防止のため、地面からの高さをわずかに引き上げ。
  - **得られた知見**: 動的に形状が変わるジオメトリを使用する場合、属性値の更新だけでなくバウンディング情報の更新を忘れると、カリングによって表示が不安定になる。

## [0.2.11] 道路の視認性・デザイン向上 - 2026-02-07

### メタ情報

- **AIモデル**: Antigravity (Gemini)
- **筆者**: AI

### 変更 (Changed)

- **道路レンダリングの高度化**:
  - **背景/原因**: 以前の道路（グレー単色）は地面の色と近く、重なりや方向が判別しにくかった。
  - **解決策**:
    - **マテリアル刷新**: `MeshLambertMaterial` を採用し、環境光や影が反映されるリアルな質感に変更。
    - **アスファルト色**: 基本色を `0x555555` から深い `0x333333` に変更。
    - **中央線の追加**: 道路中央に白いラインを追加し、車線や方向性を強調。
    - **エッジラインの追加**: 道路の縁にグレーの境界線を追加し、地面とのコントラストを明確化。
    - **選択ハイライトの強化**: 選択時に道路全体が黄色く発光（Emissive）するように変更し、操作対象であることを分かりやすくした。
  - **得られた知見**: 単純な平面メッシュでも、多層的なライン（中央線・縁取り）を重ねることで、3D空間における「意味のある構造物」としての存在感が劇的に向上する。

## [0.2.10] 道路ツールUIのデザイン改善 - 2026-02-07

### メタ情報

- **AIモデル**: Antigravity (Gemini)
- **筆者**: AI

### 変更 (Changed)

- **道路ツールUIの刷新**:
  - **背景/原因**: アイコンのみのUIで機能が分かりにくく、デザインも未整備だった。
  - **解決策**:
    - ボタンにテキストラベル（直線、曲線、編集）を追加。
    - 各モードの説明文をパネル内に追加。
    - プレミアムなダークモードスタイル（アクティブ時のグロー効果、ホバー時の挙動）を実装。
    - 視点切替ボタンを既存のボタンコンポーネントと共通化し、レイアウトを最適化。
  - **得られた知見**: アイコンは空間を節約できるが、複雑なツールにおいてはテキストラベルの併用がユーザーの学習コストを劇的に下げる。デザインシステム（変数）を徹底的に活用することで、一貫性のある「プレミアム感」を維持できる。

## [0.2.9] 道路ツールUI表示不具合の修正 - 2026-02-07

### メタ情報

- **AIモデル**: Antigravity (Gemini)
- **筆者**: AI

### 修正 (Fixed)

- **新規道路作成時のUI非表示バグ**:
  - **背景/原因**: `addNewRoad` 関数内で、道路ツール用パネル（`#road-tools`）を表示する処理が欠落していたため、ボタンを押してもツールバーが出現せず操作不能になっていた。
  - **解決策**: 関数内に `selectBuilding(null, null)` 等による選択解除処理と、`document.getElementById("road-tools").style.display = "block"` を明示的に追加。
  - **得られた知見**: モード切替を伴う機能実装時は、状態遷移（State Transition）だけでなく、それに紐づくUIの表示/非表示（View Update）が正しく行われているかを必ずセットで確認する必要がある。

## [0.2.8] Road Toolの高度化（Cities: Skylines風ロジック） - 2026-02-07

### メタ情報

- **AIモデル**: Antigravity (Gemini)
- **筆者**: AI

### 追加 (Added)

- **Cities: Skylines風道路建設システム**:
  - **背景/原因**: 以前の道路生成コードは挙動が不安定で、自由な道路網の構築が困難だった。
  - **解決策**:
    - **ステートマシン導入**: `Idle`（始点未決定）と `Dragging`（建設中）の状態を厳密に管理。
    - **スマートスナップ機能**:
      - **Node Snap**: 既存ノード（交差点）へ2m以内で吸着。
      - **Angle Snap**: 90度/180度への角度補正。
      - **Grid Snap**: 上記以外はグリッド（1m）へ吸着。
    - **トレースモード (Shiftキー)**: `Shift` を押している間のみ全スナップを無効化し、航空写真等のトレースを容易にした。
    - **連続建設モード (Chaining)**: 道路の終点を次の始点として即座にセット。右クリックで解除。
  - **描画・UI**:
    - 青い球体によるカーソル表示。
    - 建設中のゴースト（半透明メッシュ）表示。
    - リアルタイムな長さ（m）とコスト（¥）のツールチップ表示。
  - **得られた知見**:
    - 3D空間での自由な配置において、複数のスナップ優先度（ノード > 角度 > グリッド）を設定することで、直感的な操作感が得られる。
    - 右クリックによる「1段階戻る（始点リセット）」操作は、ユーザーの試行錯誤を妨げない。

## [0.2.7] 3Dマップエディタドキュメントの整備 - 2026-02-07

### メタ情報

- **AIモデル**: Antigravity (Gemini)
- **筆者**: AI

### 追加 (Added)

- **AI向けコンテキストドキュメント (`antigravity/map_editor_CONTEXT.md`)**:
  - `main/map_editor/` の技術仕様、データモデル、UIコンポーネントID、座標系の詳細をまとめた内部ドキュメントを作成。
  - **背景/原因**: 他のAIエージェントがエディタの改修を行う際、`index.html` や `editor.js` の解析コストを下げるため。
  - **解決策**: 開発に必要な情報を「コンテキストファイル」として集約・永続化。

## [0.2.6] 道路ツールのバグ修正（初期化・選択処理） - 2026-02-07

### メタ情報

- **AIモデル**: Antigravity (Gemini)
- **筆者**: AI

### 修正 (Fixed)

- **起動時のクラッシュ修正**:
  - `setupRoadToolInteractions` が `renderer` 初期化前に呼び出されていたため、`domElement` 参照エラーが発生していた問題を修正。
- **選択時のTypeError修正**:
  - 道路（`THREE.Group`）を選択・解除する際、存在しない `.material` プロパティにアクセスしてクラッシュする問題を修正。
  - グループ内の全セグメント（Children）を走査して色を変更するようにロジックを変更。

## [0.2.5] 道路ツールの高度化（ベジェ曲線・2D編集） - 2026-02-05

### メタ情報

- **AIモデル**: Antigravity (Gemini)
- **筆者**: AI

### 追加 (Added)

- **ベジェ曲線（Bezier Curve）対応**:
  - 道路データ構造を単純なパスから「ノード・セグメント」形式（`testroad1.html`準拠）に刷新。
  - 2次ベジェ曲線による滑らかなカーブの描画をサポート。
- **2D平面編集モード**:
  - 道路編集時に自動的にカメラをトップダウン視点に切り替える機能（3Dへ戻るボタンあり）。
  - クイックツールバー（直線・曲線・編集モード）の実装。

### 修正 (Fixed)

- **ファイル破損の復旧**:
  - `editor.js` の保存時に発生したバイナリ混入（`cat`コマンドのエンコーディング不備）をGit復元とBOMなしUTF-8再保存により解決。
- **頂点編集の統合**:
  - 建物の頂点編集と道路の編集ロジックを統合し、`toggleVertexEditMode` でシームレスに切り替え可能にした。

---

## [0.2.4] 道路ツールの実装 - 2026-02-05

### メタ情報

- **AIモデル**: Antigravity (Gemini)
- **筆者**: AI

### 追加 (Added)

- **道路作成機能**:
  - サイドバーに「新規道路」ボタンを追加。
  - 幅を持った帯状のメッシュ（Y=0.02）として描画し、自由に配置可能にした。
- **道路の頂点編集**:
  - 建物の頂点編集モードを拡張し、道路のパス（経路）もドラッグで変更できるようにした。
  - グリッドスナップに対応（道路はワールド座標系でスナップ）。

### 変更 (Changed)

- **エディタコアのリファクタリング**:
  - `selectedBuilding` に依存していたロジックを修正し、`selectedRoad` との共存・切り替えを可能にした。
  - プロパティパネルを動的に切り替え、道路選択時は幅のみ編集可能にした。

---

## [0.2.3] 回転座標変換のバグ修正 - 2026-02-05

### メタ情報

- **AIモデル**: Antigravity (Gemini)
- **筆者**: AI

### 修正 (Fixed)

- **座標変換関数の符合修正**:
  - **背景/原因**: `localToWorld` および `worldToLocal` 関数において、回転行列の符号が Three.js の座標系（Y軸回転：右手法）と逆になっていた。これにより、回転した建物の頂点ハンドルが誤った位置に表示され、ドラッグ操作も逆方向に飛ぶ現象が発生していた。
  - **解決策**: Three.js の `Euler` (XYZ順) および `Matrix4` の内部計算と一致するように、回転行列の $sin$ 項の符号を反転させた。
  - **得られた知見**: 3Dライブラリ（Three.js）と独自計算を混用する場合、回転軸と符号の定義（右手法か左手法か）を厳密に一致させる必要がある。

## [0.2.2] ワークフローの強化（パッチノート記録の義務化） - 2026-02-05

### メタ情報

- **AIモデル**: Antigravity (Gemini)
- **筆者**: AI

### 変更 (Changed)

- **「1タスク = 1パッチ」ルールの導入**:
  - **背景/原因**: AIの会話が新しくなると過去のデバッグ知見が失われ、同様のバグ（例：特定条件下での頂点編集の不具合）に何度も直面する問題があった。
  - **解決策**: 1つのタスク（依頼）を完了するごとに必ずバージョン（v0.x.X）のパッチ番号を上げること、および `CHANGELOG.md` に技術的な背景・原因・解決策を濃密に記述することを `SKILL.md` で義務化した。
  - **得られた知見**: `antigravity/` 配下の複数ファイルに知見を分散させるとAIが混乱するため、`CHANGELOG.md` を「技術的な航海日誌」として唯一の真実（SSOT）に設定するのが最も効率的である。

## [0.2.1] 背景トレース保存機能の実装 - 2026-02-05

### メタ情報

- **AIモデル**: Antigravity (Gemini)
- **筆者**: AI

### 追加 (Added)

- **背景トレースの永続化**:
  - 設定した背景画像（DataURL形式）およびキャリブレーション設定（幅、位置、回転、透明度）を `localStorage` に保存。
  - 次回起動時に、前回作業していた地図の状態が自動で復元される機能。
- **UI/UXの改善**:
  - `loadBgImage` 時に現在のチェックボックスの状態（表示/非表示）を尊重するように修正。読み込み直後に意図せず画像が表示されてしまう挙動を防止。

### 修正 (Fixed)

- **回転した建物の頂点編集バグ**:
  - グリッドスナップがワールド座標基準で行われていたため、回転した建物の頂点をドラッグすると意図しない位置にズレる問題を修正。ローカル座標基準でスナップするように変更。

## [0.2.0] 3Dマップエディタの大規模機能強化 - 2026-02-05

### メタ情報

- **AIモデル**: Antigravity (Gemini)
- **筆者**: AI + Uokun

### 追加 (Added)

- **多角形（ExtrudeGeometry）のサポート**:
  - 建物の形状を従来の「矩形（BoxGeometry）」から「自由な多角形（ExtrudeGeometry）」ベースに刷新。
  - **頂点編集モード**: 各頂点の位置を個別にドラッグして調整可能に。
  - **頂点追加機能**: 辺の中央にあるハンドル（緑色）をクリックして、新しい角を自由に追加可能に。
- **背景画像トレース機能の強化**:
  - **Google Maps URL連携**: URL（`...z` 形式および `...m` 形式）を入力するだけで、縮尺（m/px）を自動推定・適用する機能。
  - **Google Earth URL連携**: URL（`...d` 形式）からカメラ距離を解析し、表示幅を自動設定する機能。
  - **クリップボード貼り付け (Ctrl+V)**: ブラウザ上の地図画像をスクリーンショットし、エディタに直接ペーストして背景として設定可能に。
  - **キャリブレーション**: 画像上の2点間をクリックし、実距離を入力することでスケールを正確に補正する機能。
  - **プレースホルダー表示**: URL入力時に、次に何をすべきか（スクショ貼り付け）を案内するガイド画像を表示。
- **UI/UXの改善**:
  - **メートル単位への完全移行**: すべての座標・サイズ表示を「メートル(m)」基準に統一し、Google Earth等の実測値と整合。
  - **プロパティパネル**: 各座標や回転、階数の数値を直接入力・編集可能に。
  - **ステータスバー**: 現在の操作（ドラッグ中、頂点編集中など）や解析結果をリアルタイムに表示。

### 変更 (Changed)

- `map_implementation_CONTEXT.md`: 最新の仕様（多角形データ構造 `path` プロパティの追加など）を反映して更新。
- **内部座標系の刷新**:
  - 建物の重心（Centroid）を常に基準点（Pivot）とするようにロジックを変更。
  - 頂点編集中に形状が変わっても、回転軸がずれないように自動補正(`recenterBuilding`)する仕組みを導入。

### 修正 (Fixed)

- **重大なバグ修正**:
  - 頂点編集モード中に建物を移動できてしまう/パラメーターが効かなくなる問題を修正。
  - 頂点ハンドル再生成時にドラッグ操作が中断される不具合を修正。
  - ExtrudeGeometry使用時に選択枠（白枠）とメッシュの位置がずれる描画上の不整合を修正。
  - `ReferenceError` (未定義関数) によるクラッシュを修正。

---

## [0.1.1] 移行フェーズの完了とクリーンアップ - 2026-02-05

### メタ情報

- **AIモデル**: Antigravity (Gemini)
- **筆者**: AI

### 削除 (Removed)

- `antigravity/v0.1.0_MIGRATION_CHECKLIST.md`: 全ファイルの移行（ヘッダー付与）が完了したため削除。

### 追加 (Added)

- `antigravity/migration_CONTEXT.md`: v0.1.0 移行作業の完了記録と、今後の運用方針をまとめた知見。

---

## [0.1.0] 変更履歴システムの始動 - 2026-02-05

### メタ情報

- **AIモデル**: Gemini
- **筆者**: Uokun

### 追加 (Added)

- `CHANGELOG.md` の作成と運用ルールの策定
- Semantic Versioning (v0.1.0) の導入
- `404.html`: 存在しないページへのアクセス時に表示されるエラーページ (v0.1.0 バージョンヘッダー適用)
- `debug_firestore_custom.js`: Firestore のデータを取得・確認するためのデバッグ用ユーティリティスクリプト (v0.1.0 バージョンヘッダー適用)
- `generate_hash.js`: 店舗用パスワードのハッシュとソルトを生成するためのユーティリティスクリプト (v0.1.0 バージョンヘッダー適用)
- `functions/index.js`: 受付番号発行、注文作成、決済処理、店舗認証などのコアロジックを担う Cloud Functions (v0.1.0 バージョンヘッダー適用)
- `main/index.html`: カウントダウン、リアルタイム情報、モバイルオーダー紹介、企画ハイライトを含むトップページ (v0.1.0 バージョンヘッダー適用)
- `main/style.css`: デザインシステム、ダークモード対応、共通コンポーネント、アニメーションを定義するベーススタイルシート (v0.1.0 バージョンヘッダー適用)
- `main/app-shell.js`: ヘッダー、ボトムナビゲーション、認証状態の監視、テーマ切り替えなどのアプリ共通シェル機能 (v0.1.0 バージョンヘッダー適用)
- `main/auth.js`: Firebase Authentication を使用した Google ログイン、ログアウト、ユーザー状態の監視を担うモジュール (v0.1.0 バージョンヘッダー適用)
- `main/account.html`: ユーザープロフィール、注文履歴、通知設定、アカウント管理を行うマイページ (v0.1.0 バージョンヘッダー適用)
- `main/admin_sync.html`: 企画データやメニュー情報の編集、Firestoreへの同期、data.jsの生成を行う管理ツール (v0.1.0 バージョンヘッダー適用)
- `main/detail.html`: 企画や模擬店の詳細情報、メニューリスト、ギャラリー、モバイルオーダー連携ボタンを表示する詳細ページ (v0.1.0 バージョンヘッダー適用)
- `main/map.html`: 校内の各フロア（1F〜5F）を3Dパース表示し、企画場所や施設の位置を確認できるフロアマップ 。実験段階の機能であり、`map-experiments/` フォルダと連携して開発中(v0.1.0 バージョンヘッダー適用)
- `main/map3d.html`: Three.js を使用した校内（キャンパス全体、生徒棟、体育館等）の3Dモデル探索が可能な立体マップ。実験段階の機能であり、`map-experiments/` フォルダと連携して開発中 (v0.1.0 バージョンヘッダー適用)
- `main/mobile-order-guide.html`: モバイルオーダーシステムのアーキテクチャ、セキュリティ設計、技術スタックを解説する技術仕様書 (v0.1.0 バージョンヘッダー適用)
- `main/projects-list.html`: 企画・展示の横断検索、カテゴリ・団体別フィルタリング、並び替え、表示形式（グリッド/リスト）切り替えが可能な企画一覧ページ (v0.1.0 バージョンヘッダー適用)
- `main/terms.html`: 注文後の商品の受け取り期限（15分）、禁止事項、免責事項、個人情報の取り扱いなどを定めた利用規約ページ (v0.1.0 バージョンヘッダー適用)
- `main/firebase-messaging-sw.js`: プッシュ通知をバックグラウンドで受信し、通知を表示するためのサービスワーカー (v0.1.0 バージョンヘッダー適用)
- `main/data/data.js`: 企画情報、メニュー、展示ギャラリー、ステージスケジュールなどの全コンテンツデータを保持するマスターデータファイル (v0.1.0 バージョンヘッダー適用)
- `pos/portal.html`: 各店舗の売上統計、商品管理、注文検索、および各運営画面（POS/キッチン等）へのアクセスを統合した管理用ポータル (v0.1.0 バージョンヘッダー適用)
- `pos/mobile-order.html`: 来場者がスマートフォンから商品を注文・決済するためのモバイルオーダー・クライアントUI (v0.1.0 バージョンヘッダー適用)
- `pos/monitor.html`: 調理完了・準備中の注文番号をリアルタイムに表示し、来場者へ商品の受け取りを促す digital signage 画面 (v0.1.0 バージョンヘッダー適用)
- `pos/kitchen.html`: 調理中の注文を一覧表示し、経過時間の監視やステータス更新（調理完了）を行う厨房用モニター画面 (v0.1.0 バージョンヘッダー適用)
- `pos/presenter.html`: 商品の受け渡し口で、お客様の呼び出しや対面決済（現金・QR）、受取完了処理を行うプレゼンター用画面 (v0.1.0 バージョンヘッダー適用)
- `pos/status.html`: 注文後の来場者が、調理・準備の進捗状況をリアルタイムに確認できるマイページ用注文ステータス画面 (v0.1.0 バージョンヘッダー適用)
- `pos/pos.html`: 店舗スタッフが対面で注文を受け付け、レジ会計処理を行うためのPOSシステム画面 (v0.1.0 バージョンヘッダー適用)
- `pos/simulator.html`: モバイルオーダーやSOK（券売機）の注文データをランダム生成し、Firestoreへ書き込む開発用注文シミュレーター (v0.1.0 バージョンヘッダー適用)
- `pos/animation.html`: 調理中、準備中、商品完成などの注文ステータスを可視化するアニメーション確認用画面 (v0.1.0 バージョンヘッダー適用)
- `pos/firebase-messaging-sw.js`: 店舗運営用（POS）セクションにおいて、プッシュ通知をバックグラウンドで受信するためのサービスワーカー (v0.1.0 バージョンヘッダー適用)
- `pos/training/index.html`: レジ担当、キッチン担当、呼び出し担当などの各ロールごとに操作方法を学習できるPOSトレーニングポータル (v0.1.0 バージョンヘッダー適用)
- `pos/training/kitchen.html`: 調理中の注文確認、カスタマイズ（抜き・追加）の把握、調理完了操作の流れを練習するためのキッチン担当用トレーニング画面 (v0.1.0 バージョンヘッダー適用)
- `pos/training/manager.html`: 売上確認、在庫切れ（Sold Out）設定、注文キャンセルなどの管理者・責任者限定機能を練習するための管理ポータルシミュレーター (v0.1.0 バージョンヘッダー適用)
- `pos/training/pos.html`: 模擬店スタッフが商品選択、カスタマイズ適用、会計確定までのレジ操作フローを習得するためのPOSレジトレーニング画面 (v0.1.0 バージョンヘッダー適用)
- `pos/training/presenter.html`: キッチンからの通知受信、お客様の番号呼び出し、対面決済および商品の受け渡し完了処理を練習するためのプレゼンター用トレーニング画面 (v0.1.0 バージョンヘッダー適用)
- `main/map_editor/index.html`: Three.js を用いた校内3Dモデル作成のためのエディタUI画面 (v0.1.0 バージョンヘッダー適用)
- `main/map_editor/editor.js`: 建物の配置、形状編集（頂点操作・押し出し）、プロパティ管理、JSONエクスポート等のエディタ機能を制御するメインロジック (v0.1.0 バージョンヘッダー適用)
- `main/map_editor/editor.css`: エディタのツールバー、サイドパネル、頂点編集用補助UIなどのデザインを定義する専用スタイルシート (v0.1.0 バージョンヘッダー適用)
- `main/lastyear/`: 前年度（南陵祭'25）の公式サイトのアーカイブ資料（`index.html`, `data.js`等） (v0.1.0 バージョンヘッダー適用)
- `main/map_admin/editor.html`: MapLibre GL JS を使用した、フロアマップのエリア定義（GeoJSON）作成・編集ツール (v0.1.0 バージョンヘッダー適用)
- `map-experiments/`: 3Dマップの表示・操作・AI連携（Gemini）などの技術検証用プロトタイプ（`testmap1.html`, `testmap2.html`） (v0.1.0 バージョンヘッダー適用)

### 変更 (Changed)

- `japanese_workflow` に変更履歴記録プロセスを追加
