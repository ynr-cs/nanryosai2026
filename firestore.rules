rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    
    // 認証済みかチェック
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // 店舗管理者であり、かつ操作対象の店舗ID権限を持っているかチェック
    // data.storeId ではなく、request.auth.token.storeId (サーバーが付与) を信じる
    function isStoreAdmin(targetStoreId) {
      return isAuthenticated() 
             && request.auth.token.role == 'store_admin' 
             && request.auth.token.storeId == targetStoreId;
    }

    // スーパー管理者 (緊急メンテナンス用: ynrcs1000@gmail.com)
    function isSuperAdmin() {
      return isAuthenticated() && request.auth.token.email == 'ynrcs1000@gmail.com';
    }

    // --- Collection Rules ---

    // 1. Stores (店舗情報の公開)
    // 読み取りは誰でも可能 (メニュー表示のため)
    // ※ パスワードフィールドが含まれていないことを確認してください
    match /stores/{storeId} {
      allow read: if true; 
      allow write: if isSuperAdmin(); // 管理者はコンソール等で変更
    }

    // 1-b. Store Secrets (パスワード等の機密情報)
    // 読み書き一切禁止 (Cloud Functionsからのみアクセス)
    match /store_secrets/{storeId} {
      allow read, write: if false;
    }

    // 2. Items (商品情報)
    match /items/{itemId} {
      // 誰でも閲覧可
      allow read: if true;
      
      // 作成・更新・削除: その店舗の管理者のみ
      // resource.data.storeId (既存) または request.resource.data.storeId (新規) が権限と一致するか
      allow create: if isStoreAdmin(request.resource.data.storeId) || isSuperAdmin();
      allow update: if (isStoreAdmin(resource.data.storeId) && isStoreAdmin(request.resource.data.storeId)) || isSuperAdmin();
      allow delete: if isStoreAdmin(resource.data.storeId) || isSuperAdmin();
    }

    // 3. Orders (注文)
    match /orders/{orderId} {
      // 読み取り: 認証済みユーザーなら許可 (Kitchen/Monitorの現在の仕様上)
      // 読み取り: 店舗管理者(自店のみ)、注文者本人、SuperAdminのみ
      allow read: if isStoreAdmin(resource.data.storeId) 
                  || (request.auth.uid == resource.data.userId)
                  || isSuperAdmin();
      
      // 作成: 禁止 (クライアントSDKからは作成不可。Cloud Functions経由のみ)
      // Phase 3 セキュリティ強化: これにより不正なパラメータでの注文を完全ブロック
      allow create: if false; 
      
      // 更新: 店舗管理者、SuperAdminのみ許可 (ユーザーによる変更・キャンセルは禁止)
      allow update: if isStoreAdmin(resource.data.storeId) 
                    || isSuperAdmin();
                    
      // 削除: 禁止 (SuperAdminのみ)
      allow delete: if isSuperAdmin();
    }

    // 4. Users (ユーザー情報)
    match /users/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // 5. Counters (採番)
    // 読み取り: 店舗管理者、SuperAdminのみ (売上推測防止)
    match /counters/{document=**} {
      allow read: if isAuthenticated() && (request.auth.token.role == 'store_admin' || request.auth.token.email == 'ynrcs1000@gmail.com');
      allow write: if false; 
    }
    
    // デフォルト: 全て拒否
    match /{document=**} {
      allow read, write: if false;
    }
  }
}