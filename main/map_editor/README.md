# 3Dマップエディタ

学校の建物を3D空間上でドラッグ＆ドロップで配置・編集し、JSONでエクスポートできるビジュアルエディタです。

> **📏 メートル単位対応**: Google Earth の測定機能と連携しやすいよう、すべての座標・サイズはメートル単位で表示されます。

## 起動方法

```bash
# プロジェクトルートで実行
npx serve main -p 3000

# ブラウザで開く
# http://localhost:3000/map_editor/
```

## 基本操作

### カメラ操作

- **ドラッグ**: カメラ回転（左ドラッグ）
- **スクロール**: ズームイン/ズームアウト
- **右ドラッグ**: パン（移動）
- **ボタン**: 右下のコントロールでズーム/リセット/真上視点

### 建物選択

- **クリック**: 3D空間内の建物をクリックして選択
- **パレット**: 左サイドバーの建物リストからも選択可能

### 建物移動

- **ドラッグ**: 選択した建物をドラッグして移動
- **グリッドスナップ**: デフォルトで1mにスナップ（オプションで変更可能）

### プロパティ編集

選択した建物の詳細を左サイドバーで編集:

- **ID**: 建物の識別子（読み取り専用）
- **名前**: 表示名
- **X座標 (m) / Z座標 (m)**: 位置（メートル単位）
- **幅 (m) / 奥行き (m)**: サイズ（メートル単位）
- **階数**: 1〜10（1階 = 3m）
- **回転 (°)**: 度単位

### 頂点編集モード（新機能）

建物の頂点をドラッグして移動したり、新しい頂点を追加して自由な形状の建物にできます。

1. 建物を選択
2. 「頂点編集モード」ボタンをクリック
3. 操作：
   - **🟡 黄色の球**: ドラッグして頂点を移動
   - **🟢 緑色の四角**: クリックして新しい頂点（曲がり角）を追加
4. 「頂点編集を終了」をクリックして終了

> **💡 ヒント**: 複雑な形状の建物も Google Earth をトレースして正確に作成できます。

### 背景画像のトレース（地図の重ね合わせ）

Google Maps や Google Earth の画像を背景に敷いて、建物を正確にトレースできます。

#### 方法 A: Google Maps URL を使う場合（推奨）

1. Google Maps を開き、トレースしたい場所を表示します
2. アドレスバーの URL（`@`以降の緯度経度を含むもの）をコピーします
   - 例: `https://www.google.com/.../@35.123,139.123,18z...`
3. エディタの「Google Maps URL」欄に貼り付けます
4. ズームレベルから自動的に縮尺が計算され、背景が表示されます

#### 方法 B: スクリーンショットを貼り付ける場合

1. Google Earth などで真上からのスクリーンショットを撮ります（クリップボードにコピー）
2. エディタ上で `Ctrl+V` (Macは `Cmd+V`) を押します
3. 画像が読み込まれます

#### スケールの調整（キャリブレーション）

画像と実際のサイズが合わない場合は、「📏 距離で補正」ボタンを使います。

1. 「距離で補正」ボタンをクリック
2. 学校の校庭など、長さが分かる場所の**始点**をクリック
3. **終点**をクリック
4. 「実際の距離(m)」を入力（例: `50`）
5. 入力した距離に合わせて画像サイズが自動調整されます

#### オフセット調整

X, Z 座標や回転を調整して、グリッドに建物を合わせます。

### 建物追加/削除

- **追加**: 「新規建物」ボタンでモーダルを開き、ID・名前を入力
- **削除**: 建物を選択した状態で「削除」ボタン

## エクスポート

### データの保存

### JSONエクスポート

「JSONエクスポート」ボタンをクリックすると、以下の形式でダウンロード:

```json
{
  "version": "1.0",
  "exportedAt": "2026-01-29T12:00:00.000Z",
  "buildings": [
    {
      "id": "student",
      "name": "生徒棟",
      "x": 0,
      "z": 0,
      "width": 80,
      "depth": 20,
      "floors": 5,
      "rotation": 0,
      "category": "student"
    }
  ]
}
```

### インポート

「インポート」ボタンで既存のJSONファイルを読み込み

### 自動保存

変更は自動的にLocalStorageに保存され、ページリロード時に復元

## map3d.html への適用

エクスポートしたJSONの `buildings` 配列を `map3d.html` の `BUILDINGS` 定数に反映:

```javascript
// map3d.html の BUILDINGS を以下のように更新
const BUILDINGS = {
  student: {
    x: 0,
    z: 0,
    width: 80, // メートル単位
    depth: 20, // メートル単位
    floors: 5,
    name: "生徒棟",
    // ...
  },
  // ...
};
```

## オプション

### グリッド表示

- チェックボックスでグリッドの表示/非表示を切り替え
- グリッドは10m区切りで表示

### グリッドスナップ

- 有効時、建物はグリッドにスナップして移動
- スナップ幅はデフォルト1m（0.5m〜50mの範囲で調整可能）

### 背景画像

- トレース用の画像を地面に半透明で表示
- 画像URLを入力し、透明度を調整可能
- Google Earth のスクリーンショットをオーバーレイして正確に配置

## ファイル構成

```
main/map_editor/
├── index.html   # エディタ本体
├── editor.js    # ロジック
├── editor.css   # スタイル
└── README.md    # このファイル
```

## 技術スタック

- **Three.js r128**: 3D描画
- **OrbitControls**: カメラ操作
- **DragControls**: ドラッグ移動
- **vanilla CSS**: スタイリング
- **LocalStorage**: データ保存

## スケール参考

| 項目          | サイズ      |
| ------------- | ----------- |
| グリッド1マス | 10m         |
| 表示範囲      | 200m x 200m |
| 1階の高さ     | 3m          |
| 原点マーカー  | 直径1m      |
