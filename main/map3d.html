<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>3Dキャンパスマップ | 南陵祭'26</title>
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "Noto Sans JP", sans-serif;
        overflow: hidden;
        background: linear-gradient(180deg, #87ceeb 0%, #b8d4e8 100%);
      }
      #canvas-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }

      .ui-panel {
        position: absolute;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
        pointer-events: auto;
      }

      #floor-selector {
        top: 20px;
        right: 20px;
        padding: 8px;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .floor-btn {
        border: none;
        background: transparent;
        padding: 14px 24px;
        font-size: 15px;
        font-weight: 600;
        color: #666;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .floor-btn:hover {
        background: #f0f0f0;
      }
      .floor-btn.active {
        background: #667eea;
        color: white;
      }

      #controls {
        bottom: 20px;
        right: 20px;
        padding: 8px;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .ctrl-btn {
        width: 48px;
        height: 48px;
        border: none;
        background: transparent;
        border-radius: 12px;
        cursor: pointer;
        color: #666;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }
      .ctrl-btn:hover {
        background: #f0f0f0;
        color: #333;
      }

      #legend {
        top: 20px;
        left: 20px;
        padding: 20px;
      }
      .legend-title {
        font-weight: 700;
        font-size: 14px;
        color: #333;
        margin-bottom: 16px;
      }
      .legend-item {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
        font-size: 13px;
        color: #555;
      }
      .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 6px;
      }

      #info-panel {
        bottom: 20px;
        left: 20px;
        width: 340px;
        transform: translateY(120%);
        transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        overflow: hidden;
      }
      #info-panel.show {
        transform: translateY(0);
      }

      .info-header {
        padding: 20px;
        display: flex;
        gap: 16px;
        align-items: center;
        border-bottom: 1px solid #eee;
      }
      .info-icon {
        width: 56px;
        height: 56px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 28px;
      }
      .info-name {
        font-size: 20px;
        font-weight: 700;
        color: #222;
      }
      .info-cat {
        font-size: 13px;
        color: #888;
        margin-top: 4px;
      }
      .info-body {
        padding: 20px;
      }
      .info-desc {
        font-size: 14px;
        color: #555;
        line-height: 1.7;
        margin-bottom: 16px;
      }
      .info-meta {
        display: flex;
        gap: 20px;
        margin-bottom: 16px;
      }
      .meta-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        color: #666;
      }
      .meta-item .material-icons {
        font-size: 18px;
        color: #999;
      }
      .detail-link {
        display: inline-block;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        text-decoration: none;
        padding: 12px 24px;
        border-radius: 25px;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.3s ease;
      }
      .detail-link:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
      }
      #close-info {
        position: absolute;
        top: 16px;
        right: 16px;
        width: 32px;
        height: 32px;
        border: none;
        background: #f5f5f5;
        border-radius: 50%;
        cursor: pointer;
        color: #888;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #close-info:hover {
        background: #eee;
      }

      /* Back button */
      .back-btn {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 100;
        width: 48px;
        height: 48px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #333;
        font-size: 18px;
        transition: all 0.2s ease;
      }
      .back-btn:hover {
        background: #fff;
        transform: scale(1.05);
      }

      /* Building selector */
      #building-selector {
        top: 80px;
        left: 20px;
        padding: 12px;
      }
      .building-title {
        font-weight: 700;
        font-size: 12px;
        color: #999;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .building-btn {
        display: block;
        width: 100%;
        border: none;
        background: transparent;
        padding: 10px 16px;
        font-size: 14px;
        font-weight: 500;
        color: #666;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        text-align: left;
        margin-bottom: 4px;
      }
      .building-btn:hover {
        background: #f0f0f0;
      }
      .building-btn.active {
        background: #e8f0fe;
        color: #667eea;
      }

      @media (max-width: 768px) {
        #legend {
          display: none;
        }
        #info-panel {
          width: calc(100% - 40px);
          left: 20px;
          right: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div id="canvas-container"></div>

    <button class="back-btn" onclick="history.back()" aria-label="戻る">
      <span class="material-icons">arrow_back</span>
    </button>

    <div id="building-selector" class="ui-panel">
      <div class="building-title">建物</div>
      <button class="building-btn active" onclick="selectBuilding('campus')">
        キャンパス全体
      </button>
      <button class="building-btn" onclick="selectBuilding('student')">
        生徒棟
      </button>
      <button class="building-btn" onclick="selectBuilding('gym')">
        体育館
      </button>
      <button class="building-btn" onclick="selectBuilding('staff')">
        職員室
      </button>
      <button class="building-btn" onclick="selectBuilding('budo')">
        武道場
      </button>
      <button class="building-btn" onclick="selectBuilding('health')">
        健康福祉棟
      </button>
    </div>

    <div id="floor-selector" class="ui-panel">
      <button class="floor-btn" onclick="changeFloor(5)">5F</button>
      <button class="floor-btn" onclick="changeFloor(4)">4F</button>
      <button class="floor-btn" onclick="changeFloor(3)">3F</button>
      <button class="floor-btn" onclick="changeFloor(2)">2F</button>
      <button class="floor-btn active" onclick="changeFloor(1)">1F</button>
    </div>

    <div id="controls" class="ui-panel">
      <button class="ctrl-btn" onclick="zoomIn()">
        <span class="material-icons">add</span>
      </button>
      <button class="ctrl-btn" onclick="zoomOut()">
        <span class="material-icons">remove</span>
      </button>
      <button class="ctrl-btn" onclick="resetView()">
        <span class="material-icons">center_focus_strong</span>
      </button>
    </div>

    <div id="info-panel" class="ui-panel">
      <button id="close-info" onclick="hideInfo()">
        <span class="material-icons" style="font-size: 20px">close</span>
      </button>
      <div class="info-header">
        <div class="info-icon" id="info-icon">
          <span class="material-icons">store</span>
        </div>
        <div>
          <div class="info-name" id="info-name">教室名</div>
          <div class="info-cat" id="info-cat">団体名</div>
        </div>
      </div>
      <div class="info-body">
        <div class="info-desc" id="info-desc">説明</div>
        <div class="info-meta">
          <div class="meta-item">
            <span class="material-icons">place</span
            ><span id="info-floor">1F</span>
          </div>
        </div>
        <a href="#" class="detail-link" id="info-link">詳細を見る</a>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="data/data.js"></script>

    <script>
      let scene, camera, renderer, controls;
      let raycaster, mouse;
      let floors = {};
      let currentFloor = 1;
      let currentBuilding = "campus";
      let hoveredRoom = null;
      let selectedRoom = null;

      // カテゴリ定義（南陵祭用）
      const CATEGORIES = {
        class1: { color: 0x667eea, label: "1年生", icon: "school" },
        class2: { color: 0x764ba2, label: "2年生", icon: "school" },
        class3: { color: 0xf093fb, label: "3年生", icon: "school" },
        club: { color: 0x43a047, label: "部活動", icon: "groups" },
        stage: { color: 0xff9800, label: "ステージ", icon: "mic" },
        service: { color: 0x78909c, label: "施設", icon: "info" },
      };

      // レイアウト設定
      const LAYOUT = {
        corridorWidth: 12,
        roomDepth: 18,
        roomHeight: 8,
        floorHeight: 12,
      };

      // 建物設定（ユーザー提供の配置図に基づく）
      // 概要: 校庭(右上) - 体育館(生徒棟の上) - 生徒棟(中央コの字) - 武道場/職員室(下) - 健康福祉棟(最下部斜め)
      const BUILDINGS = {
        // 生徒棟（コの字型、中央配置）
        student: {
          x: 0,
          z: 0,
          width: 160,
          depth: 40,
          floors: 5,
          name: "生徒棟",
          shape: "u", // コの字型
        },
        // 体育館（生徒棟の上＝北側、接続）
        gym: {
          x: -30,
          z: -70,
          width: 60,
          depth: 50,
          floors: 1,
          name: "体育館",
        },
        // 職員室（生徒棟の下＝南側、中央寄り）
        staff: {
          x: 10,
          z: 70,
          width: 50,
          depth: 35,
          floors: 2,
          name: "職員室棟",
        },
        // 武道場（生徒棟の下＝南側、左寄り）
        budo: {
          x: -60,
          z: 70,
          width: 40,
          depth: 35,
          floors: 1,
          name: "武道場",
        },
        // 健康福祉棟（最下部、斜め配置）
        health: {
          x: -70,
          z: 130,
          width: 35,
          depth: 30,
          floors: 1,
          name: "健康福祉棟",
          rotation: -Math.PI / 6, // 30度傾き
        },
      };

      init();
      animate();

      function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0xd4e5f7);

        const aspect = window.innerWidth / window.innerHeight;
        const d = 150;
        camera = new THREE.OrthographicCamera(
          -d * aspect,
          d * aspect,
          d,
          -d,
          1,
          2000,
        );
        camera.position.set(250, 250, 250);
        camera.lookAt(0, 0, 0);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document
          .getElementById("canvas-container")
          .appendChild(renderer.domElement);

        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.08;
        controls.minZoom = 0.3;
        controls.maxZoom = 2.5;
        controls.maxPolarAngle = Math.PI / 2.3;
        controls.target.set(0, 0, 0);

        const ambient = new THREE.AmbientLight(0xffffff, 0.65);
        scene.add(ambient);

        const sun = new THREE.DirectionalLight(0xffffff, 0.55);
        sun.position.set(100, 200, 100);
        sun.castShadow = true;
        sun.shadow.mapSize.width = 4096;
        sun.shadow.mapSize.height = 4096;
        sun.shadow.camera.left = -250;
        sun.shadow.camera.right = 250;
        sun.shadow.camera.top = 250;
        sun.shadow.camera.bottom = -250;
        sun.shadow.bias = -0.0005;
        scene.add(sun);

        const fill = new THREE.DirectionalLight(0xe8f4fd, 0.25);
        fill.position.set(-80, 60, -80);
        scene.add(fill);

        raycaster = new THREE.Raycaster();
        mouse = new THREE.Vector2();

        createEnvironment();
        createCampus();

        window.addEventListener("resize", onResize);
        renderer.domElement.addEventListener("mousemove", onMouseMove);
        renderer.domElement.addEventListener("click", onClick);
      }

      function createEnvironment() {
        // 地面（芝生）
        const groundGeo = new THREE.PlaneGeometry(800, 800);
        const groundMat = new THREE.MeshLambertMaterial({ color: 0x7cb342 });
        const ground = new THREE.Mesh(groundGeo, groundMat);
        ground.rotation.x = -Math.PI / 2;
        ground.position.y = -1;
        ground.receiveShadow = true;
        scene.add(ground);

        // 校庭（右上＝北東側に配置）
        const schoolyardGeo = new THREE.PlaneGeometry(140, 110);
        const schoolyardMat = new THREE.MeshLambertMaterial({
          color: 0xd7ccc8,
        });
        const schoolyard = new THREE.Mesh(schoolyardGeo, schoolyardMat);
        schoolyard.rotation.x = -Math.PI / 2;
        schoolyard.position.set(80, -0.9, -70); // 右上に移動
        schoolyard.receiveShadow = true;
        scene.add(schoolyard);

        // 正門への道
        const roadGeo = new THREE.PlaneGeometry(20, 200);
        const roadMat = new THREE.MeshLambertMaterial({ color: 0x9e9e9e });
        const road = new THREE.Mesh(roadGeo, roadMat);
        road.rotation.x = -Math.PI / 2;
        road.position.set(0, -0.85, 150);
        road.receiveShadow = true;
        scene.add(road);

        // 木を配置
        const treePositions = [
          [-80, -40],
          [80, -40],
          [-80, 40],
          [80, 40],
          [-150, 0],
          [150, 0],
          [0, -150],
        ];
        treePositions.forEach(([x, z]) => createTree(x, z));
      }

      function createTree(x, z) {
        const group = new THREE.Group();

        const trunkGeo = new THREE.CylinderGeometry(1.2, 1.8, 10, 8);
        const trunkMat = new THREE.MeshLambertMaterial({ color: 0x5d4037 });
        const trunk = new THREE.Mesh(trunkGeo, trunkMat);
        trunk.position.y = 5;
        trunk.castShadow = true;
        group.add(trunk);

        const leafGeo = new THREE.SphereGeometry(7, 12, 10);
        const leafMat = new THREE.MeshLambertMaterial({ color: 0x388e3c });
        const leaf = new THREE.Mesh(leafGeo, leafMat);
        leaf.position.y = 14;
        leaf.scale.y = 0.75;
        leaf.castShadow = true;
        group.add(leaf);

        group.position.set(x, 0, z);
        scene.add(group);
      }

      function createCampus() {
        // 生徒棟（メイン建物、5F）
        createBuilding("student", 5);

        // 体育館（生徒棟の上）
        createBuilding("gym", 1);

        // 職員室棟（生徒棟の下、中央）
        createBuilding("staff", 2);

        // 武道場（生徒棟の下、左）
        createBuilding("budo", 1);

        // 健康福祉棟（最下部、斜め）
        createBuilding("health", 1);

        // 渡り廊下（生徒棟と体育館を接続）
        createBridge(-30, 0.5, -40, 8, 20);
      }

      function createBuilding(buildingId, numFloors) {
        const building = BUILDINGS[buildingId];
        if (!building) return;

        for (let f = 1; f <= numFloors; f++) {
          if (!floors[f]) {
            floors[f] = { group: new THREE.Group(), objects: [] };
            scene.add(floors[f].group);
          }

          const yBase = (f - 1) * LAYOUT.floorHeight;
          createFloorBase(floors[f].group, yBase, building);

          if (buildingId === "student") {
            createStudentBuildingRooms(floors[f], yBase, f);
          } else if (buildingId === "staff") {
            createStaffBuildingRooms(floors[f], yBase, f);
          } else if (buildingId === "gym") {
            createGymRooms(floors[f], yBase);
          } else if (buildingId === "budo") {
            createBudoRooms(floors[f], yBase);
          } else if (buildingId === "health") {
            createHealthRooms(floors[f], yBase);
          }

          if (f !== 1) {
            floors[f].group.visible = false;
          }
        }
      }

      function createFloorBase(group, y, building) {
        const floorGeo = new THREE.BoxGeometry(
          building.width,
          2,
          building.depth,
        );
        const floorMat = new THREE.MeshLambertMaterial({ color: 0xe8e8e8 });
        const floor = new THREE.Mesh(floorGeo, floorMat);
        floor.position.set(building.x, y - 1, building.z);
        floor.receiveShadow = true;
        group.add(floor);
      }

      function createStudentBuildingRooms(floorData, y, floorNum) {
        const building = BUILDINGS.student;
        const group = floorData.group;
        const roomY = y + 0.5;

        // 生徒棟の教室配置（横長なので廊下の両側に教室）
        const numRooms = 7;
        const roomWidth = (building.width - 20) / numRooms;

        for (let i = 0; i < numRooms; i++) {
          const x =
            building.x -
            building.width / 2 +
            10 +
            roomWidth / 2 +
            i * roomWidth;

          // 企画データから対応するプロジェクトを探す
          const projectId = `${floorNum}-${i + 1}`;
          const project = findProjectByFloorAndPosition(floorNum, i);

          const roomData = project
            ? {
                id: project.id,
                name:
                  project.name.split("「")[1]?.replace("」", "") ||
                  project.name,
                groupName: project.groupName || project.name.split("「")[0],
                category: getCategoryFromTags(project.tags),
                desc: project.catchphrase || project.description || "",
                floor: floorNum + "F",
                link: `project-detail.htm?id=${project.id}`,
              }
            : {
                id: `room-${floorNum}-${i + 1}`,
                name: `${floorNum}階 ${i + 1}号室`,
                groupName: "",
                category: "service",
                desc: "",
                floor: floorNum + "F",
                link: null,
              };

          createRoom(
            group,
            floorData.objects,
            x,
            building.z - 8,
            roomWidth - 2,
            14,
            roomY,
            roomData,
          );
        }
      }

      function createStaffBuildingRooms(floorData, y, floorNum) {
        const building = BUILDINGS.staff;
        const group = floorData.group;
        const roomY = y + 0.5;

        // 職員室棟の部屋
        if (floorNum === 1) {
          createRoom(
            group,
            floorData.objects,
            building.x,
            building.z,
            45,
            30,
            roomY,
            {
              id: "staff-room",
              name: "職員室",
              groupName: "文化祭本部",
              category: "service",
              desc: "文化祭本部・警備本部はこちら",
              floor: "1F",
              link: null,
            },
          );
        } else {
          createRoom(
            group,
            floorData.objects,
            building.x,
            building.z,
            45,
            30,
            roomY,
            {
              id: "staff-2f",
              name: "職員室棟2F",
              groupName: "",
              category: "service",
              desc: "",
              floor: "2F",
              link: null,
            },
          );
        }
      }

      function createBudoRooms(floorData, y) {
        const building = BUILDINGS.budo;
        const group = floorData.group;
        const roomY = y + 0.5;

        createRoom(
          group,
          floorData.objects,
          building.x,
          building.z,
          35,
          30,
          roomY,
          {
            id: "budo",
            name: "武道場",
            groupName: "",
            category: "service",
            desc: "柔道場・剣道場",
            floor: "1F",
            link: null,
          },
          12, // 高さ12
        );
      }

      function createHealthRooms(floorData, y) {
        const building = BUILDINGS.health;
        const group = floorData.group;
        const roomY = y + 0.5;

        createRoom(
          group,
          floorData.objects,
          building.x,
          building.z,
          30,
          25,
          roomY,
          {
            id: "health",
            name: "健康福祉棟",
            groupName: "",
            category: "service",
            desc: "保健室・相談室",
            floor: "1F",
            link: null,
          },
        );
      }

      function createGymRooms(floorData, y) {
        const building = BUILDINGS.gym;
        const group = floorData.group;
        const roomY = y + 0.5;

        createRoom(
          group,
          floorData.objects,
          building.x,
          building.z,
          60,
          45,
          roomY,
          {
            id: "gymnasium",
            name: "体育館",
            groupName: "ステージ発表",
            category: "stage",
            desc: "メインステージ会場。軽音楽部、ダンス部などのパフォーマンスはこちら！",
            floor: "1F",
            link: "stage-list.htm",
          },
          20,
        ); // 体育館は高さ20
      }

      function createBridge(x, y, z, width, depth) {
        const bridgeGeo = new THREE.BoxGeometry(width, 3, depth * 2);
        const bridgeMat = new THREE.MeshLambertMaterial({ color: 0xfafafa });
        const bridge = new THREE.Mesh(bridgeGeo, bridgeMat);
        bridge.position.set(x + 30, y + 1.5, z + 15);
        bridge.castShadow = true;
        bridge.receiveShadow = true;

        if (floors[1]) {
          floors[1].group.add(bridge);
        }
      }

      function createRoom(
        group,
        objects,
        x,
        z,
        w,
        d,
        y,
        data,
        customHeight = null,
      ) {
        const category = CATEGORIES[data.category] || CATEGORIES.service;
        const h = customHeight || LAYOUT.roomHeight;
        const roomGroup = new THREE.Group();

        const bodyGeo = new THREE.BoxGeometry(w, h, d);
        const bodyMat = new THREE.MeshLambertMaterial({ color: 0xffffff });
        const body = new THREE.Mesh(bodyGeo, bodyMat);
        body.position.set(0, h / 2, 0);
        body.castShadow = true;
        body.receiveShadow = true;
        roomGroup.add(body);

        const roofGeo = new THREE.BoxGeometry(w + 1, 1.2, d + 1);
        const roofMat = new THREE.MeshLambertMaterial({
          color: category.color,
        });
        const roof = new THREE.Mesh(roofGeo, roofMat);
        roof.position.set(0, h + 0.6, 0);
        roof.castShadow = true;
        roomGroup.add(roof);

        // ラベル
        const labelTex = createRoomLabel(data.name, category.color);
        const labelGeo = new THREE.PlaneGeometry(w - 2, d - 2);
        const labelMat = new THREE.MeshBasicMaterial({
          map: labelTex,
          transparent: true,
        });
        const label = new THREE.Mesh(labelGeo, labelMat);
        label.rotation.x = -Math.PI / 2;
        label.position.set(0, h + 1.3, 0);
        roomGroup.add(label);

        // エッジ線
        const edgeGeo = new THREE.EdgesGeometry(bodyGeo);
        const edgeMat = new THREE.LineBasicMaterial({ color: 0xbdbdbd });
        const edge = new THREE.LineSegments(edgeGeo, edgeMat);
        edge.position.copy(body.position);
        roomGroup.add(edge);

        roomGroup.position.set(x, y, z);

        body.userData = {
          isRoom: true,
          roomGroup: roomGroup,
          id: data.id,
          name: data.name,
          groupName: data.groupName,
          category: data.category,
          categoryLabel: category.label,
          color: category.color,
          icon: category.icon,
          desc: data.desc,
          floor: data.floor,
          link: data.link,
          bodyMat: bodyMat,
          roofMat: roofMat,
          edgeMat: edgeMat,
        };

        objects.push(body);
        group.add(roomGroup);
      }

      function createRoomLabel(name, color) {
        const canvas = document.createElement("canvas");
        canvas.width = 512;
        canvas.height = 512;
        const ctx = canvas.getContext("2d");

        ctx.fillStyle = "#FFFFFF";
        ctx.fillRect(0, 0, 512, 512);

        const colorStr = "#" + color.toString(16).padStart(6, "0");
        ctx.fillStyle = colorStr;
        ctx.fillRect(30, 30, 452, 10);
        ctx.fillRect(30, 472, 452, 10);

        ctx.fillStyle = "#333333";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";

        let fontSize = 48;
        if (name.length > 8) fontSize = 36;
        if (name.length > 12) fontSize = 28;

        ctx.font = `bold ${fontSize}px "Noto Sans JP", sans-serif`;
        ctx.fillText(name, 256, 256);

        const tex = new THREE.CanvasTexture(canvas);
        tex.anisotropy = 16;
        return tex;
      }

      // ヘルパー関数
      function findProjectByFloorAndPosition(floor, position) {
        if (typeof projectData === "undefined") return null;

        // 簡易的なマッピング（後で正確な座標マッピングに置き換え）
        const floorProjects = projectData.filter((p) => p.floor === floor);
        return floorProjects[position] || null;
      }

      function getCategoryFromTags(tags) {
        if (!tags) return "service";
        if (tags.includes("1年生")) return "class1";
        if (tags.includes("2年生")) return "class2";
        if (tags.includes("3年生")) return "class3";
        if (tags.includes("部活動・同好会")) return "club";
        if (tags.includes("ステージ")) return "stage";
        return "service";
      }

      function onResize() {
        const aspect = window.innerWidth / window.innerHeight;
        const d = 150;
        camera.left = -d * aspect;
        camera.right = d * aspect;
        camera.top = d;
        camera.bottom = -d;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }

      function onMouseMove(e) {
        mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;

        raycaster.setFromCamera(mouse, camera);
        const currentObjects = floors[currentFloor]?.objects || [];
        const intersects = raycaster.intersectObjects(currentObjects, false);

        let found = null;
        if (intersects.length > 0 && intersects[0].object.userData.isRoom) {
          found = intersects[0].object;
        }

        if (found !== hoveredRoom) {
          if (hoveredRoom && hoveredRoom !== selectedRoom) {
            setRoomState(hoveredRoom, "normal");
          }
          hoveredRoom = found;
          if (hoveredRoom && hoveredRoom !== selectedRoom) {
            setRoomState(hoveredRoom, "hover");
          }
        }

        renderer.domElement.style.cursor = found ? "pointer" : "grab";
      }

      function onClick() {
        if (hoveredRoom) {
          if (selectedRoom && selectedRoom !== hoveredRoom) {
            setRoomState(selectedRoom, "normal");
          }
          selectedRoom = hoveredRoom;
          setRoomState(selectedRoom, "selected");
          showInfo(selectedRoom.userData);
        } else if (selectedRoom) {
          setRoomState(selectedRoom, "normal");
          selectedRoom = null;
          hideInfo();
        }
      }

      function setRoomState(obj, state) {
        const data = obj.userData;
        if (!data.bodyMat) return;

        switch (state) {
          case "normal":
            data.bodyMat.color.setHex(0xffffff);
            if (data.edgeMat) data.edgeMat.color.setHex(0xbdbdbd);
            break;
          case "hover":
            data.bodyMat.color.setHex(0xf5f5f5);
            if (data.edgeMat) data.edgeMat.color.setHex(data.color);
            break;
          case "selected":
            data.bodyMat.color.setHex(0xe3f2fd);
            if (data.edgeMat) data.edgeMat.color.setHex(0x1976d2);
            break;
        }
      }

      function showInfo(data) {
        document.getElementById("info-name").textContent = data.name;
        document.getElementById("info-cat").textContent =
          data.groupName || data.categoryLabel;
        document.getElementById("info-desc").textContent =
          data.desc || "情報がありません";
        document.getElementById("info-floor").textContent = data.floor;

        const icon = document.getElementById("info-icon");
        icon.style.background = "#" + data.color.toString(16).padStart(6, "0");
        icon.innerHTML = `<span class="material-icons">${data.icon}</span>`;

        const link = document.getElementById("info-link");
        if (data.link) {
          link.href = data.link;
          link.style.display = "inline-block";
        } else {
          link.style.display = "none";
        }

        document.getElementById("info-panel").classList.add("show");
      }

      function hideInfo() {
        document.getElementById("info-panel").classList.remove("show");
      }

      function changeFloor(num) {
        if (selectedRoom) {
          setRoomState(selectedRoom, "normal");
          selectedRoom = null;
          hideInfo();
        }
        hoveredRoom = null;

        Object.keys(floors).forEach((key) => {
          floors[key].group.visible = parseInt(key) === num;
        });
        currentFloor = num;

        document.querySelectorAll(".floor-btn").forEach((btn) => {
          const btnFloor = parseInt(btn.textContent);
          btn.classList.toggle("active", btnFloor === num);
        });
      }

      function selectBuilding(buildingId) {
        currentBuilding = buildingId;

        document.querySelectorAll(".building-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        event.target.classList.add("active");

        // カメラをビルディングにフォーカス
        if (buildingId === "campus") {
          controls.target.set(0, 0, 0);
          camera.zoom = 1;
        } else {
          const building = BUILDINGS[buildingId];
          if (building) {
            controls.target.set(building.x, 0, building.z);
            camera.zoom = 1.5;
          }
        }
        camera.updateProjectionMatrix();
      }

      function zoomIn() {
        camera.zoom = Math.min(camera.zoom * 1.3, 2.5);
        camera.updateProjectionMatrix();
      }

      function zoomOut() {
        camera.zoom = Math.max(camera.zoom / 1.3, 0.3);
        camera.updateProjectionMatrix();
      }

      function resetView() {
        camera.position.set(250, 250, 250);
        camera.lookAt(0, 0, 0);
        camera.zoom = 1;
        camera.updateProjectionMatrix();
        controls.target.set(0, 0, 0);
        controls.update();
      }

      function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
      }
    </script>
  </body>
</html>
