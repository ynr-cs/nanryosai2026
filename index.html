<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>文化祭モバイルオーダー ログイン</title>

    <!-- スタイルシート(CSS)を記述 -->
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        background-color: #f4f4f9;
      }
      .container {
        text-align: center;
        background-color: white;
        padding: 40px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
      }
      button {
        background-color: #4285f4;
        color: white;
        border: none;
        padding: 12px 24px;
        font-size: 16px;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      button:hover {
        background-color: #357ae8;
      }
      #user-info {
        margin-top: 20px;
        font-size: 18px;
        color: #555;
      }
      /* 最初は非表示にしておくためのクラス */
      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <!-- 画面に表示する要素(HTML) -->
    <div class="container">
      <h1>文化祭モバイルオーダー</h1>
      <button id="login-button">Googleでログイン</button>

      <!-- ログイン後にユーザー情報を表示するエリア -->
      <!-- 最初は hidden クラスで非表示にしておく -->
      <div id="user-info" class="hidden">
        <p id="user-name"></p>
        <button id="logout-button">ログアウト</button>
      </div>
    </div>

    <!-- JavaScriptの処理を記述 -->
    <script type="module">
      // Firebase v9のモジュラースタイルで各機能をインポートする
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
      import {
        getAuth,
        GoogleAuthProvider,
        signInWithPopup,
        signOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        setDoc,
      } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

      // =================================================================
      // ▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼ ここに自分のfirebaseConfigを貼り付け ▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼
      // =================================================================
      const firebaseConfig = {
        apiKey: "AIzaSyA-Ijkbo-9rgrNKbDlRJ-rQVYdSXR_a9Do",
        authDomain: "nanryosai-2026-a4091.firebaseapp.com",
        projectId: "nanryosai-2026-a4091",
        storageBucket: "nanryosai-2026-a4091.firebasestorage.app",
        messagingSenderId: "93228414556",
        appId: "1:93228414556:web:f64f90c13849fae9049899",
        measurementId: "G-1M5G95EXF0",
      };
      // =================================================================
      // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲
      // =================================================================

      // ■ 1. Firebaseの初期化
      // -----------------------------------------------------------------
      // firebaseConfigの情報を使ってFirebaseのサービスを使えるように準備する
      const app = initializeApp(firebaseConfig);
      // Authenticationの機能を使うためのインスタンスを取得
      const auth = getAuth(app);
      // Firestoreの機能を使うためのインスタンスを取得
      const db = getFirestore(app);
      // Googleログイン機能を提供するためのプロバイダーインスタンスを作成
      const provider = new GoogleAuthProvider();

      // ■ 2. HTML要素の取得
      // -----------------------------------------------------------------
      // これから操作するHTML要素を、IDを使って取得しておく
      const loginButton = document.getElementById("login-button");
      const logoutButton = document.getElementById("logout-button");
      const userInfoDiv = document.getElementById("user-info");
      const userNameP = document.getElementById("user-name");

      // ■ 3. ログイン処理
      // -----------------------------------------------------------------
      // login-buttonがクリックされたときの処理を設定
      loginButton.addEventListener("click", () => {
        // Googleの認証ポップアップを表示してログインを行う
        signInWithPopup(auth, provider)
          .then((result) => {
            // ログイン成功時の処理
            console.log("ログイン成功！", result.user);
            // ★★★ここが重要★★★
            // ログインしたユーザーの情報をFirestoreに保存する
            saveUserToFirestore(result.user);
          })
          .catch((error) => {
            // ログイン失敗時の処理
            console.error("ログインエラー:", error);
            // エラーコードやメッセージをコンソールに表示
            const errorCode = error.code;
            const errorMessage = error.message;
            console.error(
              `エラーコード: ${errorCode}, エラーメッセージ: ${errorMessage}`
            );
          });
      });

      // ■ 4. ログアウト処理
      // -----------------------------------------------------------------
      // logout-buttonがクリックされたときの処理を設定
      logoutButton.addEventListener("click", () => {
        signOut(auth)
          .then(() => {
            console.log("ログアウトしました。");
            // 画面の状態は onAuthStateChanged が自動で更新してくれる
          })
          .catch((error) => {
            console.error("ログアウトエラー:", error);
          });
      });

      // ■ 5. ユーザー情報をFirestoreに保存する関数
      // -----------------------------------------------------------------
      // userオブジェクトを受け取り、Firestoreにデータを保存する
      async function saveUserToFirestore(user) {
        // 保存するユーザー情報のオブジェクトを作成
        const userData = {
          uid: user.uid, // ユーザーの一意なID
          displayName: user.displayName, // Googleアカウントの表示名
          email: user.email, // Googleアカウントのメールアドレス
          photoURL: user.photoURL, // Googleアカウントのプロフィール写真URL
          lastLogin: new Date(), // 最終ログイン日時（例として追加）
        };

        try {
          // Firestoreの'users'コレクションに、ユーザーのuidをドキュメントIDとしてデータを保存
          // doc(db, 'コレクション名', 'ドキュメントID') で保存場所を指定
          await setDoc(doc(db, "users", user.uid), userData);
          console.log("Firestoreにユーザー情報を保存しました。");

          /*
                 【解説】setDocの良いところ
                 setDocは、指定したドキュメントID（今回はuser.uid）のドキュメントが
                 存在しない場合は「新規作成」し、
                 すでに存在する場合は「上書き保存」してくれます。
                 これにより、ユーザーが何回ログインしてもデータベースに同じユーザーが
                 重複して作られることがなく、常に最新の情報に更新できます。
                 モバイルオーダーシステムでは非常に都合の良い機能です。
                */
        } catch (error) {
          console.error("Firestoreへの保存エラー:", error);
        }
      }

      // ■ 6. ユーザーのログイン状態を監視する
      // -----------------------------------------------------------------
      // onAuthStateChangedは、ログイン、ログアウト、ページ読み込み時など
      // ユーザーの認証状態が変化したときに自動的に呼び出される便利な関数
      onAuthStateChanged(auth, (user) => {
        if (user) {
          // --- ログインしている場合の処理 ---
          console.log("ログイン状態です:", user);

          // UI（画面表示）をログイン後の状態に更新
          userNameP.textContent = `ようこそ、${user.displayName}さん`;
          userInfoDiv.classList.remove("hidden"); // ユーザー情報エリアを表示
          loginButton.classList.add("hidden"); // ログインボタンを非表示
        } else {
          // --- ログアウトしている場合の処理 ---
          console.log("ログアウト状態です。");

          // UIをログアウト後の状態（初期状態）に更新
          userNameP.textContent = "";
          userInfoDiv.classList.add("hidden"); // ユーザー情報エリアを非表示
          loginButton.classList.remove("hidden"); // ログインボタンを表示
        }
      });
    </script>
  </body>
</html>
